/*! For license information please see 26.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunklab3algoritmos=self.webpackChunklab3algoritmos||[]).push([[26],{26:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>Eg,AggregateField:()=>ym,AggregateQuerySnapshot:()=>wm,Bytes:()=>vm,CACHE_SIZE_UNLIMITED:()=>tm,CollectionReference:()=>jf,DocumentReference:()=>Gf,DocumentSnapshot:()=>Mg,FieldPath:()=>bm,FieldValue:()=>_m,Firestore:()=>em,FirestoreError:()=>Br,GeoPoint:()=>Tm,LoadBundleTask:()=>Zf,PersistentCacheIndexManager:()=>xp,Query:()=>Kf,QueryCompositeFilterConstraint:()=>ig,QueryConstraint:()=>eg,QueryDocumentSnapshot:()=>Pg,QueryEndAtConstraint:()=>pg,QueryFieldFilterConstraint:()=>rg,QueryLimitConstraint:()=>lg,QueryOrderByConstraint:()=>ug,QuerySnapshot:()=>Lg,QueryStartAtConstraint:()=>fg,SnapshotMetadata:()=>Rg,Timestamp:()=>rs,Transaction:()=>pp,WriteBatch:()=>mp,_AutoId:()=>Zr,_ByteString:()=>Ci,_DatabaseId:()=>Fi,_DocumentKey:()=>cs,_EmptyAppCheckTokenProvider:()=>Xr,_EmptyAuthCredentialsProvider:()=>Gr,_FieldPath:()=>us,_TestingHooks:()=>Mp,_cast:()=>Vf,_debugAssert:()=>Vr,_isBase64Available:()=>xi,_logWarn:()=>Pr,_validateIsNotUsedTogether:()=>Pf,addDoc:()=>Wg,aggregateFieldEqual:()=>Ng,aggregateQuerySnapshotEqual:()=>kg,and:()=>ag,arrayRemove:()=>Ip,arrayUnion:()=>bp,average:()=>Dg,clearIndexedDbPersistence:()=>cm,collection:()=>$f,collectionGroup:()=>Qf,connectFirestoreEmulator:()=>zf,count:()=>Ag,deleteAllPersistentCacheIndexes:()=>Np,deleteDoc:()=>Qg,deleteField:()=>wp,disableNetwork:()=>dm,disablePersistentCacheIndexAutoCreation:()=>Ap,doc:()=>Wf,documentId:()=>Im,enableIndexedDbPersistence:()=>om,enableMultiTabIndexedDbPersistence:()=>am,enableNetwork:()=>hm,enablePersistentCacheIndexAutoCreation:()=>Dp,endAt:()=>wg,endBefore:()=>yg,ensureFirestoreConfigured:()=>sm,executeWrite:()=>Xg,getAggregateFromServer:()=>tp,getCountFromServer:()=>Zg,getDoc:()=>Vg,getDocFromCache:()=>Ug,getDocFromServer:()=>Bg,getDocs:()=>zg,getDocsFromCache:()=>Kg,getDocsFromServer:()=>Gg,getFirestore:()=>rm,getPersistentCacheIndexManager:()=>Cp,increment:()=>_p,initializeFirestore:()=>nm,limit:()=>hg,limitToLast:()=>dg,loadBundle:()=>mm,memoryEagerGarbageCollector:()=>ip,memoryLocalCache:()=>ap,memoryLruGarbageCollector:()=>op,namedQuery:()=>gm,onSnapshot:()=>Hg,onSnapshotsInSync:()=>Yg,or:()=>og,orderBy:()=>cg,persistentLocalCache:()=>up,persistentMultipleTabManager:()=>dp,persistentSingleTabManager:()=>hp,query:()=>ng,queryEqual:()=>Yf,refEqual:()=>Hf,runTransaction:()=>yp,serverTimestamp:()=>vp,setDoc:()=>jg,setIndexConfiguration:()=>Ep,setLogLevel:()=>kr,snapshotEqual:()=>Og,startAfter:()=>gg,startAt:()=>mg,sum:()=>Cg,terminate:()=>fm,updateDoc:()=>$g,waitForPendingWrites:()=>lm,where:()=>sg,writeBatch:()=>Tp});var r,s=n(461),i=n(125),o=n(424),a=n(743),u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c={},l=l||{},h=u||self;function d(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function f(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var m="closure_uid_"+(1e9*Math.random()>>>0),g=0;function p(t,e,n){return t.call.apply(t.bind,arguments)}function y(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function w(t,e,n){return(w=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?p:y).apply(null,arguments)}function v(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function b(t,e){function n(){}n.prototype=e.prototype,t.$=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.ac=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}function I(){this.s=this.s,this.o=this.o}I.prototype.s=!1,I.prototype.sa=function(){var t;!this.s&&(this.s=!0,this.N(),0)&&(t=this,Object.prototype.hasOwnProperty.call(t,m)&&t[m]||(t[m]=++g))},I.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const _=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1};function T(t){const e=t.length;if(0<e){const n=Array(e);for(let r=0;r<e;r++)n[r]=t[r];return n}return[]}function E(t,e){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(d(n)){const e=t.length||0,r=n.length||0;t.length=e+r;for(let s=0;s<r;s++)t[e+s]=n[s]}else t.push(n)}}function S(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}S.prototype.h=function(){this.defaultPrevented=!0};var x=function(){if(!h.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{const t=()=>{};h.addEventListener("test",t,e),h.removeEventListener("test",t,e)}catch(t){}return t}();function C(t){return/^[\s\xa0]*$/.test(t)}function D(){var t=h.navigator;return t&&(t=t.userAgent)?t:""}function A(t){return-1!=D().indexOf(t)}function N(t){return N[" "](t),t}N[" "]=function(){};var k,R,M,P=A("Opera"),L=A("Trident")||A("MSIE"),F=A("Edge"),O=F||L,V=A("Gecko")&&!(-1!=D().toLowerCase().indexOf("webkit")&&!A("Edge"))&&!(A("Trident")||A("MSIE"))&&!A("Edge"),q=-1!=D().toLowerCase().indexOf("webkit")&&!A("Edge");function U(){var t=h.document;return t?t.documentMode:void 0}t:{var B="",z=(R=D(),V?/rv:([^\);]+)(\)|;)/.exec(R):F?/Edge\/([\d\.]+)/.exec(R):L?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(R):q?/WebKit\/(\S+)/.exec(R):P?/(?:Version)[ \/]?(\S+)/.exec(R):void 0);if(z&&(B=z?z[1]:""),L){var K=U();if(null!=K&&K>parseFloat(B)){k=String(K);break t}}k=B}h.document&&L?M=U()||parseInt(k,10)||void 0:M=void 0;var G=M;function j(t,e){if(S.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(V){t:{try{N(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:$[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&j.$.h.call(this)}}b(j,S);var $={2:"touch",3:"pen",4:"mouse"};j.prototype.h=function(){j.$.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var Q="closure_listenable_"+(1e6*Math.random()|0),W=0;function H(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.la=s,this.key=++W,this.fa=this.ia=!1}function Y(t){t.fa=!0,t.listener=null,t.proxy=null,t.src=null,t.la=null}function X(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function J(t){const e={};for(const n in t)e[n]=t[n];return e}const Z="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function tt(t,e){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e],r)t[n]=r[n];for(let e=0;e<Z.length;e++)n=Z[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function et(t){this.src=t,this.g={},this.h=0}function nt(t,e){var n=e.type;if(n in t.g){var r,s=t.g[n],i=_(s,e);(r=0<=i)&&Array.prototype.splice.call(s,i,1),r&&(Y(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function rt(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.fa&&i.listener==e&&i.capture==!!n&&i.la==r)return s}return-1}et.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=rt(t,e,r,s);return-1<o?(e=t[o],n||(e.ia=!1)):((e=new H(e,this.src,i,!!r,s)).ia=n,t.push(e)),e};var st="closure_lm_"+(1e6*Math.random()|0),it={};function ot(t,e,n,r,s){if(r&&r.once)return ut(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)ot(t,e[i],n,r,s);return null}return n=gt(n),t&&t[Q]?t.O(e,n,f(r)?!!r.capture:!!r,s):at(t,e,n,!1,r,s)}function at(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o=f(s)?!!s.capture:!!s,a=ft(t);if(a||(t[st]=a=new et(t)),(n=a.add(e,n,r,o,i)).proxy)return n;if(r=function(){const t=dt;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)x||(s=o),void 0===s&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(ht(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function ut(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)ut(t,e[i],n,r,s);return null}return n=gt(n),t&&t[Q]?t.P(e,n,f(r)?!!r.capture:!!r,s):at(t,e,n,!0,r,s)}function ct(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)ct(t,e[i],n,r,s);else r=f(r)?!!r.capture:!!r,n=gt(n),t&&t[Q]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=rt(i=t.g[e],n,r,s))&&(Y(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=ft(t))&&(e=t.g[e.toString()],t=-1,e&&(t=rt(e,n,r,s)),(n=-1<t?e[t]:null)&&lt(n))}function lt(t){if("number"!=typeof t&&t&&!t.fa){var e=t.src;if(e&&e[Q])nt(e.i,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(ht(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=ft(e))?(nt(n,t),0==n.h&&(n.src=null,e[st]=null)):Y(t)}}}function ht(t){return t in it?it[t]:it[t]="on"+t}function dt(t,e){if(t.fa)t=!0;else{e=new j(e,this);var n=t.listener,r=t.la||t.src;t.ia&&lt(t),t=n.call(r,e)}return t}function ft(t){return(t=t[st])instanceof et?t:null}var mt="__closure_events_fn_"+(1e9*Math.random()>>>0);function gt(t){return"function"==typeof t?t:(t[mt]||(t[mt]=function(e){return t.handleEvent(e)}),t[mt])}function pt(){I.call(this),this.i=new et(this),this.S=this,this.J=null}function yt(t,e){var n,r=t.J;if(r)for(n=[];r;r=r.J)n.push(r);if(t=t.S,r=e.type||e,"string"==typeof e)e=new S(e,t);else if(e instanceof S)e.target=e.target||t;else{var s=e;tt(e=new S(r,t),s)}if(s=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];s=wt(o,r,!0,e)&&s}if(s=wt(o=e.g=t,r,!0,e)&&s,s=wt(o,r,!1,e)&&s,n)for(i=0;i<n.length;i++)s=wt(o=e.g=n[i],r,!1,e)&&s}function wt(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.fa&&o.capture==n){var a=o.listener,u=o.la||o.src;o.ia&&nt(t.i,o),s=!1!==a.call(u,r)&&s}}return s&&!r.defaultPrevented}b(pt,I),pt.prototype[Q]=!0,pt.prototype.removeEventListener=function(t,e,n,r){ct(this,t,e,n,r)},pt.prototype.N=function(){if(pt.$.N.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)Y(n[r]);delete e.g[t],e.h--}}this.J=null},pt.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},pt.prototype.P=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var vt=h.JSON.stringify;function bt(){var t=Ct;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var It=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new _t),(t=>t.reset()));class _t{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Tt(t){var e=1;t=t.split(":");const n=[];for(;0<e&&t.length;)n.push(t.shift()),e--;return t.length&&n.push(t.join(":")),n}function Et(t){h.setTimeout((()=>{throw t}),0)}let St,xt=!1,Ct=new class{constructor(){this.h=this.g=null}add(t,e){const n=It.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}},Dt=()=>{const t=h.Promise.resolve(void 0);St=()=>{t.then(At)}};var At=()=>{for(var t;t=bt();){try{t.h.call(t.g)}catch(t){Et(t)}var e=It;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}xt=!1};function Nt(t,e){pt.call(this),this.h=t||1,this.g=e||h,this.j=w(this.qb,this),this.l=Date.now()}function kt(t){t.ga=!1,t.T&&(t.g.clearTimeout(t.T),t.T=null)}function Rt(t,e,n){if("function"==typeof t)n&&(t=w(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=w(t.handleEvent,t)}return 2147483647<Number(e)?-1:h.setTimeout(t,e||0)}function Mt(t){t.g=Rt((()=>{t.g=null,t.i&&(t.i=!1,Mt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}b(Nt,pt),(r=Nt.prototype).ga=!1,r.T=null,r.qb=function(){if(this.ga){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-t):(this.T&&(this.g.clearTimeout(this.T),this.T=null),yt(this,"tick"),this.ga&&(kt(this),this.start()))}},r.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},r.N=function(){Nt.$.N.call(this),kt(this),delete this.g};class Pt extends I{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Mt(this)}N(){super.N(),this.g&&(h.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Lt(t){I.call(this),this.h=t,this.g={}}b(Lt,I);var Ft=[];function Ot(t,e,n,r){Array.isArray(n)||(n&&(Ft[0]=n.toString()),n=Ft);for(var s=0;s<n.length;s++){var i=ot(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function Vt(t){X(t.g,(function(t,e){this.g.hasOwnProperty(e)&&lt(t)}),t),t.g={}}function qt(){this.g=!0}function Ut(t,e,n,r){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(2>r.length)){var s=r[1];if(Array.isArray(s)&&!(1>s.length)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return vt(n)}catch(t){return e}}(t,n)+(r?" "+r:"")}))}Lt.prototype.N=function(){Lt.$.N.call(this),Vt(this)},Lt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},qt.prototype.Ea=function(){this.g=!1},qt.prototype.info=function(){};var Bt={},zt=null;function Kt(){return zt=zt||new pt}function Gt(t){S.call(this,Bt.Ta,t)}function jt(t){const e=Kt();yt(e,new Gt(e))}function $t(t,e){S.call(this,Bt.STAT_EVENT,t),this.stat=e}function Qt(t){const e=Kt();yt(e,new $t(e,t))}function Wt(t,e){S.call(this,Bt.Ua,t),this.size=e}function Ht(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return h.setTimeout((function(){t()}),e)}Bt.Ta="serverreachability",b(Gt,S),Bt.STAT_EVENT="statevent",b($t,S),Bt.Ua="timingevent",b(Wt,S);var Yt={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},Xt={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function Jt(){}function Zt(t){return t.h||(t.h=t.i())}function te(){}Jt.prototype.h=null;var ee,ne={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function re(){S.call(this,"d")}function se(){S.call(this,"c")}function ie(){}function oe(t,e,n,r){this.l=t,this.j=e,this.m=n,this.W=r||1,this.U=new Lt(this),this.P=ue,t=O?125:void 0,this.V=new Nt(t),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new ae}function ae(){this.i=null,this.g="",this.h=!1}b(re,S),b(se,S),b(ie,Jt),ie.prototype.g=function(){return new XMLHttpRequest},ie.prototype.i=function(){return{}},ee=new ie;var ue=45e3,ce={},le={};function he(t,e,n){t.L=1,t.A=Ne(Se(e)),t.u=n,t.S=!0,de(t,null)}function de(t,e){t.G=Date.now(),pe(t),t.B=Se(t.A);var n=t.B,r=t.W;Array.isArray(r)||(r=[String(r)]),Ke(n.i,"t",r),t.o=0,n=t.l.J,t.h=new ae,t.g=Gn(t.l,n?e:null,!t.u),0<t.O&&(t.M=new Pt(w(t.Pa,t,t.g),t.O)),Ot(t.U,t.g,"readystatechange",t.nb),e=t.I?J(t.I):{},t.u?(t.v||(t.v="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ha(t.B,t.v,t.u,e)):(t.v="GET",t.g.ha(t.B,t.v,null,e)),jt(),function(t,e,n,r,s,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+c+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+r+") [attempt "+s+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.v,t.B,t.m,t.W,t.u)}function fe(t){return!!t.g&&"GET"==t.v&&2!=t.L&&t.l.Ha}function me(t,e,n){let r,s=!0;for(;!t.J&&t.o<n.length;){if(r=ge(t,n),r==le){4==e&&(t.s=4,Qt(14),s=!1),Ut(t.j,t.m,null,"[Incomplete Response]");break}if(r==ce){t.s=4,Qt(15),Ut(t.j,t.m,n,"[Invalid Chunk]"),s=!1;break}Ut(t.j,t.m,r,null),Ie(t,r)}fe(t)&&0!=t.o&&(t.h.g=t.h.g.slice(t.o),t.o=0),4!=e||0!=n.length||t.h.h||(t.s=1,Qt(16),s=!1),t.i=t.i&&s,s?0<n.length&&!t.ba&&(t.ba=!0,(e=t.l).g==t&&e.ca&&!e.M&&(e.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Fn(e),e.M=!0,Qt(11))):(Ut(t.j,t.m,n,"[Invalid Chunked Response]"),be(t),ve(t))}function ge(t,e){var n=t.o,r=e.indexOf("\n",n);return-1==r?le:(n=Number(e.substring(n,r)),isNaN(n)?ce:(r+=1)+n>e.length?le:(e=e.slice(r,r+n),t.o=r+n,e))}function pe(t){t.Y=Date.now()+t.P,ye(t,t.P)}function ye(t,e){if(null!=t.C)throw Error("WatchDog timer not null");t.C=Ht(w(t.lb,t),e)}function we(t){t.C&&(h.clearTimeout(t.C),t.C=null)}function ve(t){0==t.l.H||t.J||qn(t.l,t)}function be(t){we(t);var e=t.M;e&&"function"==typeof e.sa&&e.sa(),t.M=null,kt(t.V),Vt(t.U),t.g&&(e=t.g,t.g=null,e.abort(),e.sa())}function Ie(t,e){try{var n=t.l;if(0!=n.H&&(n.g==t||Ye(n.i,t)))if(!t.K&&Ye(n.i,t)&&3==n.H){try{var r=n.Ja.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.G+3e3<t.G))break t;Vn(n),Dn(n)}Ln(n),Qt(18)}}else n.Fa=s[1],0<n.Fa-n.V&&37500>s[2]&&n.G&&0==n.A&&!n.v&&(n.v=Ht(w(n.ib,n),6e3));if(1>=He(n.i)&&n.oa){try{n.oa()}catch(t){}n.oa=void 0}}else Bn(n,11)}else if((t.K||n.g==t)&&Vn(n),!C(e))for(s=n.Ja.g.parse(e),e=0;e<s.length;e++){let c=s[e];if(n.V=c[0],c=c[1],2==n.H)if("c"==c[0]){n.K=c[1],n.pa=c[2];const e=c[3];null!=e&&(n.ra=e,n.l.info("VER="+n.ra));const s=c[4];null!=s&&(n.Ga=s,n.l.info("SVER="+n.Ga));const l=c[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=r.i;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(Xe(i,i.h),i.h=null))}if(r.F){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(r.Da=t,Ae(r.I,r.F,t))}}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-t.G,n.l.info("Handshake RTT: "+n.S+"ms"));var o=t;if((r=n).wa=Kn(r,r.J?r.pa:null,r.Y),o.K){Je(r.i,o);var a=o,u=r.L;u&&a.setTimeout(u),a.C&&(we(a),pe(a)),r.g=o}else Pn(r);0<n.j.length&&Nn(n)}else"stop"!=c[0]&&"close"!=c[0]||Bn(n,7);else 3==n.H&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?Bn(n,7):Cn(n):"noop"!=c[0]&&n.h&&n.h.Aa(c),n.A=0)}jt()}catch(t){}}function _e(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(d(t)||"string"==typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.ta&&"function"==typeof t.ta)return t.ta();if(!t.Z||"function"!=typeof t.Z){if("undefined"!=typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!=typeof Set&&t instanceof Set)){if(d(t)||"string"==typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const r in t)e[n++]=r;return e}}}(t),r=function(t){if(t.Z&&"function"==typeof t.Z)return t.Z();if("undefined"!=typeof Map&&t instanceof Map||"undefined"!=typeof Set&&t instanceof Set)return Array.from(t.values());if("string"==typeof t)return t.split("");if(d(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t),s=r.length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}(r=oe.prototype).setTimeout=function(t){this.P=t},r.nb=function(t){t=t.target;const e=this.M;e&&3==In(t)?e.l():this.Pa(t)},r.Pa=function(t){try{if(t==this.g)t:{const l=In(this.g);var e=this.g.Ia();if(this.g.da(),!(3>l)&&(3!=l||O||this.g&&(this.h.h||this.g.ja()||_n(this.g)))){this.J||4!=l||7==e||jt(),we(this);var n=this.g.da();this.ca=n;e:if(fe(this)){var r=_n(this.g);t="";var s=r.length,i=4==In(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){be(this),ve(this);var o="";break e}this.h.i=new h.TextDecoder}for(e=0;e<s;e++)this.h.h=!0,t+=this.h.i.decode(r[e],{stream:i&&e==s-1});r.length=0,this.h.g+=t,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==n,function(t,e,n,r,s,i,o){t.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.v,this.B,this.m,this.W,l,n),this.i){if(this.aa&&!this.K){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!C(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.s=3,Qt(12),be(this),ve(this);break t}Ut(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ie(this,n)}this.S?(me(this,l,o),O&&this.i&&3==l&&(Ot(this.U,this.V,"tick",this.mb),this.V.start())):(Ut(this.j,this.m,o,null),Ie(this,o)),4==l&&be(this),this.i&&!this.J&&(4==l?qn(this.l,this):(this.i=!1,pe(this)))}else(function(t){const e={};t=(t.g&&2<=In(t)&&t.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<t.length;r++){if(C(t[r]))continue;var n=Tt(t[r]);const s=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const i=e[s]||[];e[s]=i,i.push(n)}!function(t,e){for(const n in t)e.call(void 0,t[n],n,t)}(e,(function(t){return t.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.s=3,Qt(12)):(this.s=0,Qt(13)),be(this),ve(this)}}}catch(t){}},r.mb=function(){if(this.g){var t=In(this.g),e=this.g.ja();this.o<e.length&&(we(this),me(this,t,e),this.i&&4!=t&&pe(this))}},r.cancel=function(){this.J=!0,be(this)},r.lb=function(){this.C=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.B),2!=this.L&&(jt(),Qt(17)),be(this),this.s=2,ve(this)):ye(this,this.Y-t)};var Te=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Ee(t){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,t instanceof Ee){this.h=t.h,xe(this,t.j),this.s=t.s,this.g=t.g,Ce(this,t.m),this.l=t.l;var e=t.i,n=new qe;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),De(this,n),this.o=t.o}else t&&(e=String(t).match(Te))?(this.h=!1,xe(this,e[1]||"",!0),this.s=ke(e[2]||""),this.g=ke(e[3]||"",!0),Ce(this,e[4]),this.l=ke(e[5]||"",!0),De(this,e[6]||"",!0),this.o=ke(e[7]||"")):(this.h=!1,this.i=new qe(null,this.h))}function Se(t){return new Ee(t)}function xe(t,e,n){t.j=n?ke(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Ce(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function De(t,e,n){e instanceof qe?(t.i=e,function(t,e){e&&!t.j&&(Ue(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Be(this,e),Ke(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=Re(e,Oe)),t.i=new qe(e,t.h))}function Ae(t,e,n){t.i.set(e,n)}function Ne(t){return Ae(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function ke(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Re(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,Me),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Me(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Ee.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Re(e,Pe,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(Re(e,Pe,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(Re(n,"/"==n.charAt(0)?Fe:Le,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Re(n,Ve)),t.join("")};var Pe=/[#\/\?@]/g,Le=/[#\?:]/g,Fe=/[#\?]/g,Oe=/[#\?@]/g,Ve=/#/g;function qe(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Ue(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),s=null;if(0<=r){var i=t[n].substring(0,r);s=t[n].substring(r+1)}else i=t[n];e(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Be(t,e){Ue(t),e=Ge(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function ze(t,e){return Ue(t),e=Ge(t,e),t.g.has(e)}function Ke(t,e,n){Be(t,e),0<n.length&&(t.i=null,t.g.set(Ge(t,e),T(n)),t.h+=n.length)}function Ge(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}(r=qe.prototype).add=function(t,e){Ue(this),this.i=null,t=Ge(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},r.forEach=function(t,e){Ue(this),this.g.forEach((function(n,r){n.forEach((function(n){t.call(e,n,r,this)}),this)}),this)},r.ta=function(){Ue(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let r=0;r<e.length;r++){const s=t[r];for(let t=0;t<s.length;t++)n.push(e[r])}return n},r.Z=function(t){Ue(this);let e=[];if("string"==typeof t)ze(this,t)&&(e=e.concat(this.g.get(Ge(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},r.set=function(t,e){return Ue(this),this.i=null,ze(this,t=Ge(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},r.get=function(t,e){return t&&0<(t=this.Z(t)).length?String(t[0]):e},r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var r=e[n];const i=encodeURIComponent(String(r)),o=this.Z(r);for(r=0;r<o.length;r++){var s=i;""!==o[r]&&(s+="="+encodeURIComponent(String(o[r]))),t.push(s)}}return this.i=t.join("&")};var je=class{constructor(t,e){this.g=t,this.map=e}};function $e(t){this.l=t||Qe,t=h.PerformanceNavigationTiming?0<(t=h.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(h.g&&h.g.Ka&&h.g.Ka()&&h.g.Ka().dc),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var Qe=10;function We(t){return!!t.h||!!t.g&&t.g.size>=t.j}function He(t){return t.h?1:t.g?t.g.size:0}function Ye(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function Xe(t,e){t.g?t.g.add(e):t.h=e}function Je(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function Ze(t){if(null!=t.h)return t.i.concat(t.h.F);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}return T(t.i)}$e.prototype.cancel=function(){if(this.i=Ze(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}};var tn=class{stringify(t){return h.JSON.stringify(t,void 0)}parse(t){return h.JSON.parse(t,void 0)}};function en(){this.g=new tn}function nn(t,e,n){const r=n||"";try{_e(t,(function(t,n){let s=t;f(t)&&(s=vt(t)),e.push(r+n+"="+encodeURIComponent(s))}))}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function rn(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function sn(t){this.l=t.ec||null,this.j=t.ob||!1}function on(t,e){pt.call(this),this.F=t,this.u=e,this.m=void 0,this.readyState=an,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}b(sn,Jt),sn.prototype.g=function(){return new on(this.l,this.j)},sn.prototype.i=function(t){return function(){return t}}({}),b(on,pt);var an=0;function un(t){t.j.read().then(t.Xa.bind(t)).catch(t.ka.bind(t))}function cn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,ln(t)}function ln(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(r=on.prototype).open=function(t,e){if(this.readyState!=an)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,ln(this)},r.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.F||h).fetch(new Request(this.B,e)).then(this.$a.bind(this),this.ka.bind(this))},r.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,cn(this)),this.readyState=an},r.$a=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,ln(this)),this.g&&(this.readyState=3,ln(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==h.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;un(this)}else t.text().then(this.Za.bind(this),this.ka.bind(this))},r.Xa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?cn(this):ln(this),3==this.readyState&&un(this)}},r.Za=function(t){this.g&&(this.response=this.responseText=t,cn(this))},r.Ya=function(t){this.g&&(this.response=t,cn(this))},r.ka=function(){this.g&&cn(this)},r.setRequestHeader=function(t,e){this.v.append(t,e)},r.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(on.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var hn=h.JSON.parse;function dn(t){pt.call(this),this.headers=new Map,this.u=t||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=fn,this.L=this.M=!1}b(dn,pt);var fn="",mn=/^https?$/i,gn=["POST","PUT"];function pn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,yn(t),vn(t)}function yn(t){t.F||(t.F=!0,yt(t,"complete"),yt(t,"error"))}function wn(t){if(t.h&&void 0!==l&&(!t.C[1]||4!=In(t)||2!=t.da()))if(t.v&&4==In(t))Rt(t.La,0,t);else if(yt(t,"readystatechange"),4==In(t)){t.h=!1;try{const o=t.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var r;if(r=0===o){var s=String(t.I).match(Te)[1]||null;!s&&h.self&&h.self.location&&(s=h.self.location.protocol.slice(0,-1)),r=!mn.test(s?s.toLowerCase():"")}n=r}if(n)yt(t,"complete"),yt(t,"success");else{t.m=6;try{var i=2<In(t)?t.g.statusText:""}catch(t){i=""}t.j=i+" ["+t.da()+"]",yn(t)}}finally{vn(t)}}}function vn(t,e){if(t.g){bn(t);const n=t.g,r=t.C[0]?()=>{}:null;t.g=null,t.C=null,e||yt(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function bn(t){t.g&&t.L&&(t.g.ontimeout=null),t.A&&(h.clearTimeout(t.A),t.A=null)}function In(t){return t.g?t.g.readyState:0}function _n(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.K){case fn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Tn(t){let e="";return X(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function En(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=Tn(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Ae(t,e,n))}function Sn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function xn(t){this.Ga=0,this.j=[],this.l=new qt,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Sn("failFast",!1,t),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Sn("baseRetryDelayMs",5e3,t),this.hb=Sn("retryDelaySeedMs",1e4,t),this.eb=Sn("forwardChannelMaxRetries",2,t),this.xa=Sn("forwardChannelRequestTimeoutMs",2e4,t),this.va=t&&t.xmlHttpFactory||void 0,this.Ha=t&&t.useFetchStreams||!1,this.L=void 0,this.J=t&&t.supportsCrossDomainXhr||!1,this.K="",this.i=new $e(t&&t.concurrentRequestLimit),this.Ja=new en,this.P=t&&t.fastHandshake||!1,this.O=t&&t.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=t&&t.bc||!1,t&&t.Ea&&this.l.Ea(),t&&t.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&t&&t.detectBufferingProxy||!1,this.qa=void 0,t&&t.longPollingTimeout&&0<t.longPollingTimeout&&(this.qa=t.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Cn(t){if(An(t),3==t.H){var e=t.W++,n=Se(t.I);if(Ae(n,"SID",t.K),Ae(n,"RID",e),Ae(n,"TYPE","terminate"),Rn(t,n),(e=new oe(t,t.l,e)).L=2,e.A=Ne(Se(n)),n=!1,h.navigator&&h.navigator.sendBeacon)try{n=h.navigator.sendBeacon(e.A.toString(),"")}catch(t){}!n&&h.Image&&((new Image).src=e.A,n=!0),n||(e.g=Gn(e.l,null),e.g.ha(e.A)),e.G=Date.now(),pe(e)}zn(t)}function Dn(t){t.g&&(Fn(t),t.g.cancel(),t.g=null)}function An(t){Dn(t),t.u&&(h.clearTimeout(t.u),t.u=null),Vn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&h.clearTimeout(t.m),t.m=null)}function Nn(t){if(!We(t.i)&&!t.m){t.m=!0;var e=t.Na;St||Dt(),xt||(St(),xt=!0),Ct.add(e,t),t.C=0}}function kn(t,e){var n;n=e?e.m:t.W++;const r=Se(t.I);Ae(r,"SID",t.K),Ae(r,"RID",n),Ae(r,"AID",t.V),Rn(t,r),t.o&&t.s&&En(r,t.o,t.s),n=new oe(t,t.l,n,t.C+1),null===t.o&&(n.I=t.s),e&&(t.j=e.F.concat(t.j)),e=Mn(t,n,1e3),n.setTimeout(Math.round(.5*t.xa)+Math.round(.5*t.xa*Math.random())),Xe(t.i,n),he(n,r,e)}function Rn(t,e){t.na&&X(t.na,(function(t,n){Ae(e,n,t)})),t.h&&_e({},(function(t,n){Ae(e,n,t)}))}function Mn(t,e,n){n=Math.min(t.j.length,n);var r=t.h?w(t.h.Va,t.h,t):null;t:{var s=t.j;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=s[0].g,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=s[o].g;const a=s[o].map;if(n-=e,0>n)e=Math.max(0,s[o].g-100),i=!1;else try{nn(a,t,"req"+n+"_")}catch(t){r&&r(a)}}if(i){r=t.join("&");break t}}}return t=t.j.splice(0,n),e.F=t,r}function Pn(t){if(!t.g&&!t.u){t.ba=1;var e=t.Ma;St||Dt(),xt||(St(),xt=!0),Ct.add(e,t),t.A=0}}function Ln(t){return!(t.g||t.u||3<=t.A||(t.ba++,t.u=Ht(w(t.Ma,t),Un(t,t.A)),t.A++,0))}function Fn(t){null!=t.B&&(h.clearTimeout(t.B),t.B=null)}function On(t){t.g=new oe(t,t.l,"rpc",t.ba),null===t.o&&(t.g.I=t.s),t.g.O=0;var e=Se(t.wa);Ae(e,"RID","rpc"),Ae(e,"SID",t.K),Ae(e,"AID",t.V),Ae(e,"CI",t.G?"0":"1"),!t.G&&t.qa&&Ae(e,"TO",t.qa),Ae(e,"TYPE","xmlhttp"),Rn(t,e),t.o&&t.s&&En(e,t.o,t.s),t.L&&t.g.setTimeout(t.L);var n=t.g;t=t.pa,n.L=1,n.A=Ne(Se(e)),n.u=null,n.S=!0,de(n,t)}function Vn(t){null!=t.v&&(h.clearTimeout(t.v),t.v=null)}function qn(t,e){var n=null;if(t.g==e){Vn(t),Fn(t),t.g=null;var r=2}else{if(!Ye(t.i,e))return;n=e.F,Je(t.i,e),r=1}if(0!=t.H)if(e.i)if(1==r){n=e.u?e.u.length:0,e=Date.now()-e.G;var s=t.C;yt(r=Kt(),new Wt(r,n)),Nn(t)}else Pn(t);else if(3==(s=e.s)||0==s&&0<e.ca||!(1==r&&function(t,e){return!(He(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.j=e.F.concat(t.j),0):1==t.H||2==t.H||t.C>=(t.cb?0:t.eb)||(t.m=Ht(w(t.Na,t,e),Un(t,t.C)),t.C++,0)))}(t,e)||2==r&&Ln(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),s){case 1:Bn(t,5);break;case 4:Bn(t,10);break;case 3:Bn(t,6);break;default:Bn(t,2)}}function Un(t,e){let n=t.ab+Math.floor(Math.random()*t.hb);return t.isActive()||(n*=2),n*e}function Bn(t,e){if(t.l.info("Error code "+e),2==e){var n=null;t.h&&(n=null);var r=w(t.pb,t);n||(n=new Ee("//www.google.com/images/cleardot.gif"),h.location&&"http"==h.location.protocol||xe(n,"https"),Ne(n)),function(t,e){const n=new qt;if(h.Image){const r=new Image;r.onload=v(rn,n,r,"TestLoadImage: loaded",!0,e),r.onerror=v(rn,n,r,"TestLoadImage: error",!1,e),r.onabort=v(rn,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=v(rn,n,r,"TestLoadImage: timeout",!1,e),h.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=t}else e(!1)}(n.toString(),r)}else Qt(2);t.H=0,t.h&&t.h.za(e),zn(t),An(t)}function zn(t){if(t.H=0,t.ma=[],t.h){const e=Ze(t.i);0==e.length&&0==t.j.length||(E(t.ma,e),E(t.ma,t.j),t.i.i.length=0,T(t.j),t.j.length=0),t.h.ya()}}function Kn(t,e,n){var r=n instanceof Ee?Se(n):new Ee(n);if(""!=r.g)e&&(r.g=e+"."+r.g),Ce(r,r.m);else{var s=h.location;r=s.protocol,e=e?e+"."+s.hostname:s.hostname,s=+s.port;var i=new Ee(null);r&&xe(i,r),e&&(i.g=e),s&&Ce(i,s),n&&(i.l=n),r=i}return n=t.F,e=t.Da,n&&e&&Ae(r,n,e),Ae(r,"VER",t.ra),Rn(t,r),r}function Gn(t,e,n){if(e&&!t.J)throw Error("Can't create secondary domain capable XhrIo object.");return(e=t.Ha&&!t.va?new dn(new sn({ob:n})):new dn(t.va)).Oa(t.J),e}function jn(){}function $n(){if(L&&!(10<=Number(G)))throw Error("Environmental error: no available transport.")}function Qn(t,e){pt.call(this),this.g=new xn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.Ca&&(t?t["X-WebChannel-Client-Profile"]=e.Ca:t={"X-WebChannel-Client-Profile":e.Ca}),this.g.U=t,(t=e&&e.cc)&&!C(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!C(e)&&(this.g.F=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new Yn(this)}function Wn(t){re.call(this),t.__headers__&&(this.headers=t.__headers__,this.statusCode=t.__status__,delete t.__headers__,delete t.__status__);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Hn(){se.call(this),this.status=1}function Yn(t){this.g=t}function Xn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Jn(t,e,n){n||(n=0);var r=Array(16);if("string"==typeof e)for(var s=0;16>s;++s)r[s]=e.charCodeAt(n++)|e.charCodeAt(n++)<<8|e.charCodeAt(n++)<<16|e.charCodeAt(n++)<<24;else for(s=0;16>s;++s)r[s]=e[n++]|e[n++]<<8|e[n++]<<16|e[n++]<<24;e=t.g[0],n=t.g[1],s=t.g[2];var i=t.g[3],o=e+(i^n&(s^i))+r[0]+3614090360&4294967295;o=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=n+(o<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^i&(n^s))+r[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=e+(n^s^i)+r[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=e+(s^(n|~i))+r[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((i=(e=n+((o=e+(s^(n|~i))+r[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((s=i+((o=s+(e^(i|~n))+r[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~e))+r[9]+3951481745&4294967295,t.g[0]=t.g[0]+e&4294967295,t.g[1]=t.g[1]+(s+(o<<21&4294967295|o>>>11))&4294967295,t.g[2]=t.g[2]+s&4294967295,t.g[3]=t.g[3]+i&4294967295}function Zn(t,e){this.h=e;for(var n=[],r=!0,s=t.length-1;0<=s;s--){var i=0|t[s];r&&i==e||(n[s]=i,r=!1)}this.g=n}(r=dn.prototype).Oa=function(t){this.M=t},r.ha=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+t);e=e?e.toUpperCase():"GET",this.I=t,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():ee.g(),this.C=this.u?Zt(this.u):Zt(ee),this.g.onreadystatechange=w(this.La,this);try{this.G=!0,this.g.open(e,String(t),!0),this.G=!1}catch(t){return void pn(this,t)}if(t=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const t of r.keys())n.set(t,r.get(t))}r=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),s=h.FormData&&t instanceof h.FormData,!(0<=_(gn,e))||r||s||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[t,e]of n)this.g.setRequestHeader(t,e);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{bn(this),0<this.B&&((this.L=function(t){return L&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=w(this.ua,this)):this.A=Rt(this.ua,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){pn(this,t)}},r.ua=function(){void 0!==l&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,yt(this,"timeout"),this.abort(8))},r.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,yt(this,"complete"),yt(this,"abort"),vn(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),vn(this,!0)),dn.$.N.call(this)},r.La=function(){this.s||(this.G||this.v||this.l?wn(this):this.kb())},r.kb=function(){wn(this)},r.isActive=function(){return!!this.g},r.da=function(){try{return 2<In(this)?this.g.status:-1}catch(t){return-1}},r.ja=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},r.Wa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),hn(e)}},r.Ia=function(){return this.m},r.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(r=xn.prototype).ra=8,r.H=1,r.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new oe(this,this.l,t);let i=this.s;if(this.U&&(i?(i=J(i),tt(i,this.U)):i=this.U),null!==this.o||this.O||(s.I=i,i=null),this.P)t:{for(var e=0,n=0;n<this.j.length;n++){var r=this.j[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(e+=r)){e=n;break t}if(4096===e||n===this.j.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=Mn(this,s,e),Ae(n=Se(this.I),"RID",t),Ae(n,"CVER",22),this.F&&Ae(n,"X-HTTP-Session-Id",this.F),Rn(this,n),i&&(this.O?e="headers="+encodeURIComponent(String(Tn(i)))+"&"+e:this.o&&En(n,this.o,i)),Xe(this.i,s),this.bb&&Ae(n,"TYPE","init"),this.P?(Ae(n,"$req",e),Ae(n,"SID","null"),s.aa=!0,he(s,n,null)):he(s,n,e),this.H=2}}else 3==this.H&&(t?kn(this,t):0==this.j.length||We(this.i)||kn(this))},r.Ma=function(){if(this.u=null,On(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var t=2*this.S;this.l.info("BP detection timer enabled: "+t),this.B=Ht(w(this.jb,this),t)}},r.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Qt(10),Dn(this),On(this))},r.ib=function(){null!=this.v&&(this.v=null,Dn(this),Ln(this),Qt(19))},r.pb=function(t){t?(this.l.info("Successfully pinged google.com"),Qt(2)):(this.l.info("Failed to ping google.com"),Qt(1))},r.isActive=function(){return!!this.h&&this.h.isActive(this)},(r=jn.prototype).Ba=function(){},r.Aa=function(){},r.za=function(){},r.ya=function(){},r.isActive=function(){return!0},r.Va=function(){},$n.prototype.g=function(t,e){return new Qn(t,e)},b(Qn,pt),Qn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var t=this.g,e=this.l,n=this.h||void 0;Qt(0),t.Y=e,t.na=n||{},t.G=t.aa,t.I=Kn(t,null,t.Y),Nn(t)},Qn.prototype.close=function(){Cn(this.g)},Qn.prototype.u=function(t){var e=this.g;if("string"==typeof t){var n={};n.__data__=t,t=n}else this.v&&((n={}).__data__=vt(t),t=n);e.j.push(new je(e.fb++,t)),3==e.H&&Nn(e)},Qn.prototype.N=function(){this.g.h=null,delete this.j,Cn(this.g),delete this.g,Qn.$.N.call(this)},b(Wn,re),b(Hn,se),b(Yn,jn),Yn.prototype.Ba=function(){yt(this.g,"a")},Yn.prototype.Aa=function(t){yt(this.g,new Wn(t))},Yn.prototype.za=function(t){yt(this.g,new Hn)},Yn.prototype.ya=function(){yt(this.g,"b")},b(Xn,(function(){this.blockSize=-1})),Xn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Xn.prototype.j=function(t,e){void 0===e&&(e=t.length);for(var n=e-this.blockSize,r=this.m,s=this.h,i=0;i<e;){if(0==s)for(;i<=n;)Jn(this,t,i),i+=this.blockSize;if("string"==typeof t){for(;i<e;)if(r[s++]=t.charCodeAt(i++),s==this.blockSize){Jn(this,r),s=0;break}}else for(;i<e;)if(r[s++]=t[i++],s==this.blockSize){Jn(this,r),s=0;break}}this.h=s,this.i+=e},Xn.prototype.l=function(){var t=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);t[0]=128;for(var e=1;e<t.length-8;++e)t[e]=0;var n=8*this.i;for(e=t.length-8;e<t.length;++e)t[e]=255&n,n/=256;for(this.j(t),t=Array(16),e=n=0;4>e;++e)for(var r=0;32>r;r+=8)t[n++]=this.g[e]>>>r&255;return t};var tr={};function er(t){return-128<=t&&128>t?function(t){var e=tr;return Object.prototype.hasOwnProperty.call(e,t)?e[t]:e[t]=function(t){return new Zn([0|t],0>t?-1:0)}(t)}(t):new Zn([0|t],0>t?-1:0)}function nr(t){if(isNaN(t)||!isFinite(t))return sr;if(0>t)return cr(nr(-t));for(var e=[],n=1,r=0;t>=n;r++)e[r]=t/n|0,n*=rr;return new Zn(e,0)}var rr=4294967296,sr=er(0),ir=er(1),or=er(16777216);function ar(t){if(0!=t.h)return!1;for(var e=0;e<t.g.length;e++)if(0!=t.g[e])return!1;return!0}function ur(t){return-1==t.h}function cr(t){for(var e=t.g.length,n=[],r=0;r<e;r++)n[r]=~t.g[r];return new Zn(n,~t.h).add(ir)}function lr(t,e){return t.add(cr(e))}function hr(t,e){for(;(65535&t[e])!=t[e];)t[e+1]+=t[e]>>>16,t[e]&=65535,e++}function dr(t,e){this.g=t,this.h=e}function fr(t,e){if(ar(e))throw Error("division by zero");if(ar(t))return new dr(sr,sr);if(ur(t))return e=fr(cr(t),e),new dr(cr(e.g),cr(e.h));if(ur(e))return e=fr(t,cr(e)),new dr(cr(e.g),e.h);if(30<t.g.length){if(ur(t)||ur(e))throw Error("slowDivide_ only works with positive integers.");for(var n=ir,r=e;0>=r.X(t);)n=mr(n),r=mr(r);var s=gr(n,1),i=gr(r,1);for(r=gr(r,2),n=gr(n,2);!ar(r);){var o=i.add(r);0>=o.X(t)&&(s=s.add(n),i=o),r=gr(r,1),n=gr(n,1)}return e=lr(t,s.R(e)),new dr(s,e)}for(s=sr;0<=t.X(e);){for(n=Math.max(1,Math.floor(t.ea()/e.ea())),r=48>=(r=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,r-48),o=(i=nr(n)).R(e);ur(o)||0<o.X(t);)o=(i=nr(n-=r)).R(e);ar(i)&&(i=ir),s=s.add(i),t=lr(t,o)}return new dr(s,t)}function mr(t){for(var e=t.g.length+1,n=[],r=0;r<e;r++)n[r]=t.D(r)<<1|t.D(r-1)>>>31;return new Zn(n,t.h)}function gr(t,e){var n=e>>5;e%=32;for(var r=t.g.length-n,s=[],i=0;i<r;i++)s[i]=0<e?t.D(i+n)>>>e|t.D(i+n+1)<<32-e:t.D(i+n);return new Zn(s,t.h)}(r=Zn.prototype).ea=function(){if(ur(this))return-cr(this).ea();for(var t=0,e=1,n=0;n<this.g.length;n++){var r=this.D(n);t+=(0<=r?r:rr+r)*e,e*=rr}return t},r.toString=function(t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);if(ar(this))return"0";if(ur(this))return"-"+cr(this).toString(t);for(var e=nr(Math.pow(t,6)),n=this,r="";;){var s=fr(n,e).g,i=((0<(n=lr(n,s.R(e))).g.length?n.g[0]:n.h)>>>0).toString(t);if(ar(n=s))return i+r;for(;6>i.length;)i="0"+i;r=i+r}},r.D=function(t){return 0>t?0:t<this.g.length?this.g[t]:this.h},r.X=function(t){return ur(t=lr(this,t))?-1:ar(t)?0:1},r.abs=function(){return ur(this)?cr(this):this},r.add=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0,s=0;s<=e;s++){var i=r+(65535&this.D(s))+(65535&t.D(s)),o=(i>>>16)+(this.D(s)>>>16)+(t.D(s)>>>16);r=o>>>16,i&=65535,o&=65535,n[s]=o<<16|i}return new Zn(n,-2147483648&n[n.length-1]?-1:0)},r.R=function(t){if(ar(this)||ar(t))return sr;if(ur(this))return ur(t)?cr(this).R(cr(t)):cr(cr(this).R(t));if(ur(t))return cr(this.R(cr(t)));if(0>this.X(or)&&0>t.X(or))return nr(this.ea()*t.ea());for(var e=this.g.length+t.g.length,n=[],r=0;r<2*e;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var s=0;s<t.g.length;s++){var i=this.D(r)>>>16,o=65535&this.D(r),a=t.D(s)>>>16,u=65535&t.D(s);n[2*r+2*s]+=o*u,hr(n,2*r+2*s),n[2*r+2*s+1]+=i*u,hr(n,2*r+2*s+1),n[2*r+2*s+1]+=o*a,hr(n,2*r+2*s+1),n[2*r+2*s+2]+=i*a,hr(n,2*r+2*s+2)}for(r=0;r<e;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=e;r<2*e;r++)n[r]=0;return new Zn(n,0)},r.gb=function(t){return fr(this,t).h},r.and=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)&t.D(r);return new Zn(n,this.h&t.h)},r.or=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)|t.D(r);return new Zn(n,this.h|t.h)},r.xor=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)^t.D(r);return new Zn(n,this.h^t.h)},$n.prototype.createWebChannel=$n.prototype.g,Qn.prototype.send=Qn.prototype.u,Qn.prototype.open=Qn.prototype.m,Qn.prototype.close=Qn.prototype.close,Yt.NO_ERROR=0,Yt.TIMEOUT=8,Yt.HTTP_ERROR=6,Xt.COMPLETE="complete",te.EventType=ne,ne.OPEN="a",ne.CLOSE="b",ne.ERROR="c",ne.MESSAGE="d",pt.prototype.listen=pt.prototype.O,dn.prototype.listenOnce=dn.prototype.P,dn.prototype.getLastError=dn.prototype.Sa,dn.prototype.getLastErrorCode=dn.prototype.Ia,dn.prototype.getStatus=dn.prototype.da,dn.prototype.getResponseJson=dn.prototype.Wa,dn.prototype.getResponseText=dn.prototype.ja,dn.prototype.send=dn.prototype.ha,dn.prototype.setWithCredentials=dn.prototype.Oa,Xn.prototype.digest=Xn.prototype.l,Xn.prototype.reset=Xn.prototype.reset,Xn.prototype.update=Xn.prototype.j,Zn.prototype.add=Zn.prototype.add,Zn.prototype.multiply=Zn.prototype.R,Zn.prototype.modulo=Zn.prototype.gb,Zn.prototype.compare=Zn.prototype.X,Zn.prototype.toNumber=Zn.prototype.ea,Zn.prototype.toString=Zn.prototype.toString,Zn.prototype.getBits=Zn.prototype.D,Zn.fromNumber=nr,Zn.fromString=function t(e,n){if(0==e.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==e.charAt(0))return cr(t(e.substring(1),n));if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=nr(Math.pow(n,8)),s=sr,i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),a=parseInt(e.substring(i,i+o),n);8>o?(o=nr(Math.pow(n,o)),s=s.R(o).add(nr(a))):s=(s=s.R(r)).add(nr(a))}return s};var pr=c.createWebChannelTransport=function(){return new $n},yr=c.getStatEventTarget=function(){return Kt()},wr=c.ErrorCode=Yt,vr=c.EventType=Xt,br=c.Event=Bt,Ir=c.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},_r=(c.FetchXmlHttpFactory=sn,c.WebChannel=te),Tr=c.XhrIo=dn,Er=c.Md5=Xn,Sr=c.Integer=Zn;const xr="@firebase/firestore";class Cr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Cr.UNAUTHENTICATED=new Cr(null),Cr.GOOGLE_CREDENTIALS=new Cr("google-credentials-uid"),Cr.FIRST_PARTY=new Cr("first-party-uid"),Cr.MOCK_USER=new Cr("mock-user");let Dr="10.7.2";const Ar=new o.Vy("@firebase/firestore");function Nr(){return Ar.logLevel}function kr(t){Ar.setLogLevel(t)}function Rr(t,...e){if(Ar.logLevel<=o.$b.DEBUG){const n=e.map(Lr);Ar.debug(`Firestore (${Dr}): ${t}`,...n)}}function Mr(t,...e){if(Ar.logLevel<=o.$b.ERROR){const n=e.map(Lr);Ar.error(`Firestore (${Dr}): ${t}`,...n)}}function Pr(t,...e){if(Ar.logLevel<=o.$b.WARN){const n=e.map(Lr);Ar.warn(`Firestore (${Dr}): ${t}`,...n)}}function Lr(t){if("string"==typeof t)return t;try{return function(t){return JSON.stringify(t)}(t)}catch(e){return t}}function Fr(t="Unexpected state"){const e=`FIRESTORE (${Dr}) INTERNAL ASSERTION FAILED: `+t;throw Mr(e),new Error(e)}function Or(t,e){t||Fr()}function Vr(t,e){t||Fr()}function qr(t,e){return t}const Ur={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Br extends a.g{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class zr{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Kr{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Gr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Cr.UNAUTHENTICATED)))}shutdown(){}}class jr{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class $r{constructor(t){this.t=t,this.currentUser=Cr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new zr;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new zr,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{Rr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(Rr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new zr)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Rr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Or("string"==typeof e.accessToken),new Kr(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Or(null===t||"string"==typeof t),new Cr(t)}}class Qr{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=Cr.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Wr{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new Qr(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable((()=>e(Cr.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Hr{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Yr{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){const n=t=>{null!=t.error&&Rr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.R;return this.R=t.token,Rr("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const r=t=>{Rr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.A.onInit((t=>r(t))),setTimeout((()=>{if(!this.appCheck){const t=this.A.getImmediate({optional:!0});t?r(t):Rr("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Or("string"==typeof t.token),this.R=t.token,new Hr(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Xr{getToken(){return Promise.resolve(new Hr(""))}invalidateToken(){}start(t,e){}shutdown(){}}function Jr(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class Zr{static newId(){const t=62*Math.floor(256/62);let e="";for(;e.length<20;){const n=Jr(40);for(let r=0;r<n.length;++r)e.length<20&&n[r]<t&&(e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return e}}function ts(t,e){return t<e?-1:t>e?1:0}function es(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function ns(t){return t+"\0"}class rs{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Br(Ur.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Br(Ur.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Br(Ur.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Br(Ur.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return rs.fromMillis(Date.now())}static fromDate(t){return rs.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new rs(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?ts(this.nanoseconds,t.nanoseconds):ts(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ss{constructor(t){this.timestamp=t}static fromTimestamp(t){return new ss(t)}static min(){return new ss(new rs(0,0))}static max(){return new ss(new rs(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class is{constructor(t,e,n){void 0===e?e=0:e>t.length&&Fr(),void 0===n?n=t.length-e:n>t.length-e&&Fr(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===is.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof is?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class os extends is{construct(t,e,n){return new os(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Br(Ur.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new os(e)}static emptyPath(){return new os([])}}const as=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class us extends is{construct(t,e,n){return new us(t,e,n)}static isValidIdentifier(t){return as.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),us.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new us(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new Br(Ur.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new Br(Ur.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Br(Ur.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new Br(Ur.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new us(e)}static emptyPath(){return new us([])}}class cs{constructor(t){this.path=t}static fromPath(t){return new cs(os.fromString(t))}static fromName(t){return new cs(os.fromString(t).popFirst(5))}static empty(){return new cs(os.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===os.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return os.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new cs(new os(t.slice()))}}class ls{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}function hs(t){return t.fields.find((t=>2===t.kind))}function ds(t){return t.fields.filter((t=>2!==t.kind))}function fs(t,e){let n=ts(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(t.fields.length,e.fields.length);++r)if(n=gs(t.fields[r],e.fields[r]),0!==n)return n;return ts(t.fields.length,e.fields.length)}ls.UNKNOWN_ID=-1;class ms{constructor(t,e){this.fieldPath=t,this.kind=e}}function gs(t,e){const n=us.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:ts(t.kind,e.kind)}class ps{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new ps(0,vs.min())}}function ys(t,e){const n=t.toTimestamp().seconds,r=t.toTimestamp().nanoseconds+1,s=ss.fromTimestamp(1e9===r?new rs(n+1,0):new rs(n,r));return new vs(s,cs.empty(),e)}function ws(t){return new vs(t.readTime,t.key,-1)}class vs{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new vs(ss.min(),cs.empty(),-1)}static max(){return new vs(ss.max(),cs.empty(),-1)}}function bs(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=cs.comparator(t.documentKey,e.documentKey),0!==n?n:ts(t.largestBatchId,e.largestBatchId))}const Is="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class _s{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Ts(t){if(t.code!==Ur.FAILED_PRECONDITION||t.message!==Is)throw t;Rr("LocalStore","Unexpectedly lost primary lease")}class Es{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Fr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Es(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Es?e:Es.resolve(e)}catch(t){return Es.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Es.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Es.reject(e)}static resolve(t){return new Es(((e,n)=>{e(t)}))}static reject(t){return new Es(((e,n)=>{n(t)}))}static waitFor(t){return new Es(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=Es.resolve(!1);for(const n of t)e=e.next((t=>t?Es.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}static mapArray(t,e){return new Es(((n,r)=>{const s=t.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===s&&n(i)}),(t=>r(t)))}}))}static doWhile(t,e){return new Es(((n,r)=>{const s=()=>{!0===t()?e().next((()=>{s()}),r):n()};s()}))}}class Ss{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new zr,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new Ds(t,e.error)):this.V.resolve()},this.transaction.onerror=e=>{const n=Ms(e.target.error);this.V.reject(new Ds(t,n))}}static open(t,e,n,r){try{return new Ss(e,t.transaction(r,n))}catch(t){throw new Ds(e,t)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(Rr("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new Ns(e)}}class xs{constructor(t,e,n){this.name=t,this.version=e,this.p=n,12.2===xs.S((0,a.ZQ)())&&Mr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Rr("SimpleDb","Removing database:",t),ks(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!(0,a.zW)())return!1;if(xs.C())return!0;const t=(0,a.ZQ)(),e=xs.S(t),n=0<e&&e<10,r=xs.v(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static C(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.__PRIVATE_env)||void 0===t?void 0:t.F)}static M(t,e){return t.store(e)}static S(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(t){return this.db||(Rr("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new Ds(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new Br(Ur.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new Br(Ur.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Ds(t,r))},r.onupgradeneeded=t=>{Rr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.p.N(e,r.transaction,t.oldVersion,this.version).next((()=>{Rr("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=t=>this.B(t)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.O(t);const e=Ss.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).next((t=>(e.g(),t))).catch((t=>(e.abort(t),Es.reject(t)))).toPromise();return i.catch((()=>{})),await e.m,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(Rr("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Cs{constructor(t){this.k=t,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(t){this.k=t}done(){this.q=!0}U(t){this.K=t}delete(){return ks(this.k.delete())}}class Ds extends Br{constructor(t,e){super(Ur.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function As(t){return"IndexedDbTransactionError"===t.name}class Ns{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Rr("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Rr("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),ks(n)}add(t){return Rr("SimpleDb","ADD",this.store.name,t,t),ks(this.store.add(t))}get(t){return ks(this.store.get(t)).next((e=>(void 0===e&&(e=null),Rr("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Rr("SimpleDb","DELETE",this.store.name,t),ks(this.store.delete(t))}count(){return Rr("SimpleDb","COUNT",this.store.name),ks(this.store.count())}W(t,e){const n=this.options(t,e),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const t=r.getAll(n.range);return new Es(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}{const t=this.cursor(n),e=[];return this.G(t,((t,n)=>{e.push(n)})).next((()=>e))}}j(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new Es(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}H(t,e){Rr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.J=!1;const r=this.cursor(n);return this.G(r,((t,e,n)=>n.delete()))}Y(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.G(r,e)}Z(t){const e=this.cursor({});return new Es(((n,r)=>{e.onerror=t=>{const e=Ms(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}G(t,e){const n=[];return new Es(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new Cs(s),o=e(s.primaryKey,s.value,i);if(o instanceof Es){const t=o.catch((t=>(i.done(),Es.reject(t))));n.push(t)}i.isDone?r():null===i.$?s.continue():s.continue(i.$)}})).next((()=>Es.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.J?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function ks(t){return new Es(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Ms(t.target.error);n(e)}}))}let Rs=!1;function Ms(t){const e=xs.S((0,a.ZQ)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Br("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Rs||(Rs=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Ps{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(t){Rr("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{Rr("IndexBackfiller",`Documents written: ${await this.X.te()}`)}catch(t){As(t)?Rr("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):await Ts(t)}await this.ee(6e4)}))}}class Ls{constructor(t,e){this.localStore=t,this.persistence=e}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.ne(e,t)))}ne(t,e){const n=new Set;let r=e,s=!0;return Es.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return Rr("IndexBackfiller",`Processing collection: ${e}`),this.re(t,e,r).next((t=>{r-=t,n.add(e)}));s=!1})))).next((()=>e-r))}re(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((r=>this.localStore.localDocuments.getNextDocuments(t,e,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(t,s).next((()=>this.ie(r,n))).next((n=>(Rr("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>s.size))}))))}ie(t,e){let n=t;return e.changes.forEach(((t,e)=>{const r=ws(e);bs(r,n)>0&&(n=r)})),new vs(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Fs{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.se(t),this.oe=t=>e.writeSequenceNumber(t))}se(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.oe&&this.oe(t),t}}function Os(t){return null==t}function Vs(t){return 0===t&&1/t==-1/0}function qs(t){return"number"==typeof t&&Number.isInteger(t)&&!Vs(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}function Us(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=zs(e)),e=Bs(t.get(n),e);return zs(e)}function Bs(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function zs(t){return t+""}function Ks(t){const e=t.length;if(Or(e>=2),2===e)return Or(""===t.charAt(0)&&""===t.charAt(1)),os.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Fr(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=t.substring(i,e),s+="\0";break;case"":s+=t.substring(i,e+1);break;default:Fr()}i=e+2}return new os(r)}Fs._e=-1;const Gs=["userId","batchId"];function js(t,e){return[t,Us(e)]}function $s(t,e,n){return[t,Us(e),n]}const Qs={},Ws=["prefixPath","collectionGroup","readTime","documentId"],Hs=["prefixPath","collectionGroup","documentId"],Ys=["collectionGroup","readTime","prefixPath","documentId"],Xs=["canonicalId","targetId"],Js=["targetId","path"],Zs=["path","targetId"],ti=["collectionId","parent"],ei=["indexId","uid"],ni=["uid","sequenceNumber"],ri=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],si=["indexId","uid","orderedDocumentKey"],ii=["userId","collectionPath","documentId"],oi=["userId","collectionPath","largestBatchId"],ai=["userId","collectionGroup","largestBatchId"],ui=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ci=[...ui,"documentOverlays"],li=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],hi=li,di=[...hi,"indexConfiguration","indexState","indexEntries"];class fi extends _s{constructor(t,e){super(),this.ae=t,this.currentSequenceNumber=e}}function mi(t,e){const n=qr(t);return xs.M(n.ae,e)}function gi(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function pi(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function yi(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class wi{constructor(t,e){this.comparator=t,this.root=e||bi.EMPTY}insert(t,e){return new wi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,bi.BLACK,null,null))}remove(t){return new wi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,bi.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new vi(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new vi(this.root,t,this.comparator,!1)}getReverseIterator(){return new vi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new vi(this.root,t,this.comparator,!0)}}class vi{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class bi{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:bi.RED,this.left=null!=r?r:bi.EMPTY,this.right=null!=s?s:bi.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new bi(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return bi.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return bi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,bi.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,bi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Fr();if(this.right.isRed())throw Fr();const t=this.left.check();if(t!==this.right.check())throw Fr();return t+(this.isRed()?0:1)}}bi.EMPTY=null,bi.RED=!0,bi.BLACK=!1,bi.EMPTY=new class{constructor(){this.size=0}get key(){throw Fr()}get value(){throw Fr()}get color(){throw Fr()}get left(){throw Fr()}get right(){throw Fr()}copy(t,e,n,r,s){return this}insert(t,e,n){return new bi(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ii{constructor(t){this.comparator=t,this.data=new wi(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new _i(this.data.getIterator())}getIteratorFrom(t){return new _i(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Ii))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Ii(this.comparator);return e.data=t,e}}class _i{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Ti(t){return t.hasNext()?t.getNext():void 0}class Ei{constructor(t){this.fields=t,t.sort(us.comparator)}static empty(){return new Ei([])}unionWith(t){let e=new Ii(us.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Ei(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return es(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class Si extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function xi(){return"undefined"!=typeof atob}class Ci{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new Si("Invalid base64 string: "+t):t}}(t);return new Ci(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Ci(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return ts(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Ci.EMPTY_BYTE_STRING=new Ci("");const Di=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ai(t){if(Or(!!t),"string"==typeof t){let e=0;const n=Di.exec(t);if(Or(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:Ni(t.seconds),nanos:Ni(t.nanos)}}function Ni(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function ki(t){return"string"==typeof t?Ci.fromBase64String(t):Ci.fromUint8Array(t)}function Ri(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Mi(t){const e=t.mapValue.fields.__previous_value__;return Ri(e)?Mi(e):e}function Pi(t){const e=Ai(t.mapValue.fields.__local_write_time__.timestampValue);return new rs(e.seconds,e.nanos)}class Li{constructor(t,e,n,r,s,i,o,a,u){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}class Fi{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Fi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Fi&&t.projectId===this.projectId&&t.database===this.database}}const Oi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Vi={nullValue:"NULL_VALUE"};function qi(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Ri(t)?4:to(t)?9007199254740991:10:Fr()}function Ui(t,e){if(t===e)return!0;const n=qi(t);if(n!==qi(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Pi(t).isEqual(Pi(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Ai(t.timestampValue),r=Ai(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return ki(t.bytesValue).isEqual(ki(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return Ni(t.geoPointValue.latitude)===Ni(e.geoPointValue.latitude)&&Ni(t.geoPointValue.longitude)===Ni(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Ni(t.integerValue)===Ni(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=Ni(t.doubleValue),r=Ni(e.doubleValue);return n===r?Vs(n)===Vs(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return es(t.arrayValue.values||[],e.arrayValue.values||[],Ui);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(gi(n)!==gi(r))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===r[t]||!Ui(n[t],r[t])))return!1;return!0}(t,e);default:return Fr()}}function Bi(t,e){return void 0!==(t.values||[]).find((t=>Ui(t,e)))}function zi(t,e){if(t===e)return 0;const n=qi(t),r=qi(e);if(n!==r)return ts(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return ts(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=Ni(t.integerValue||t.doubleValue),r=Ni(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return Ki(t.timestampValue,e.timestampValue);case 4:return Ki(Pi(t),Pi(e));case 5:return ts(t.stringValue,e.stringValue);case 6:return function(t,e){const n=ki(t),r=ki(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=ts(n[t],r[t]);if(0!==e)return e}return ts(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=ts(Ni(t.latitude),Ni(e.latitude));return 0!==n?n:ts(Ni(t.longitude),Ni(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=zi(n[t],r[t]);if(e)return e}return ts(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Oi.mapValue&&e===Oi.mapValue)return 0;if(t===Oi.mapValue)return 1;if(e===Oi.mapValue)return-1;const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=ts(r[t],i[t]);if(0!==e)return e;const o=zi(n[r[t]],s[i[t]]);if(0!==o)return o}return ts(r.length,i.length)}(t.mapValue,e.mapValue);default:throw Fr()}}function Ki(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return ts(t,e);const n=Ai(t),r=Ai(e),s=ts(n.seconds,r.seconds);return 0!==s?s:ts(n.nanos,r.nanos)}function Gi(t){return ji(t)}function ji(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Ai(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(t){return ki(t).toBase64()}(t.bytesValue):"referenceValue"in t?function(t){return cs.fromName(t).toString()}(t.referenceValue):"geoPointValue"in t?function(t){return`geo(${t.latitude},${t.longitude})`}(t.geoPointValue):"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=ji(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${ji(t.fields[s])}`;return n+"}"}(t.mapValue):Fr()}function $i(t){switch(qi(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const e=Mi(t);return e?16+$i(e):16;case 5:return 2*t.stringValue.length;case 6:return ki(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return function(t){return(t.values||[]).reduce(((t,e)=>t+$i(e)),0)}(t.arrayValue);case 10:return function(t){let e=0;return pi(t.fields,((t,n)=>{e+=t.length+$i(n)})),e}(t.mapValue);default:throw Fr()}}function Qi(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Wi(t){return!!t&&"integerValue"in t}function Hi(t){return!!t&&"arrayValue"in t}function Yi(t){return!!t&&"nullValue"in t}function Xi(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Ji(t){return!!t&&"mapValue"in t}function Zi(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return pi(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Zi(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Zi(t.arrayValue.values[n]);return e}return Object.assign({},t)}function to(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function eo(t){return"nullValue"in t?Vi:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Qi(Fi.empty(),cs.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Fr()}function no(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Qi(Fi.empty(),cs.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Oi:Fr()}function ro(t,e){const n=zi(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function so(t,e){const n=zi(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class io{constructor(t){this.value=t}static empty(){return new io({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Ji(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Zi(e)}setAll(t){let e=us.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=Zi(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());Ji(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Ui(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];Ji(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){pi(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new io(Zi(this.value))}}function oo(t){const e=[];return pi(t.fields,((t,n)=>{const r=new us([t]);if(Ji(n)){const t=oo(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new Ei(e)}class ao{constructor(t,e,n,r,s,i,o){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(t){return new ao(t,0,ss.min(),ss.min(),ss.min(),io.empty(),0)}static newFoundDocument(t,e,n,r){return new ao(t,1,e,ss.min(),n,r,0)}static newNoDocument(t,e){return new ao(t,2,e,ss.min(),ss.min(),io.empty(),0)}static newUnknownDocument(t,e){return new ao(t,3,e,ss.min(),ss.min(),io.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(ss.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=io.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=io.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ss.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof ao&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new ao(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class uo{constructor(t,e){this.position=t,this.inclusive=e}}function co(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?cs.comparator(cs.fromName(o.referenceValue),n.key):zi(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function lo(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Ui(t.position[n],e.position[n]))return!1;return!0}class ho{constructor(t,e="asc"){this.field=t,this.dir=e}}function fo(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class mo{}class go extends mo{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new So(t,e,n):"array-contains"===e?new Ao(t,n):"in"===e?new No(t,n):"not-in"===e?new ko(t,n):"array-contains-any"===e?new Ro(t,n):new go(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new xo(t,n):new Co(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(zi(e,this.value)):null!==e&&qi(this.value)===qi(e)&&this.matchesComparison(zi(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Fr()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class po extends mo{constructor(t,e){super(),this.filters=t,this.op=e,this.ue=null}static create(t,e){return new po(t,e)}matches(t){return yo(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function yo(t){return"and"===t.op}function wo(t){return"or"===t.op}function vo(t){return bo(t)&&yo(t)}function bo(t){for(const e of t.filters)if(e instanceof po)return!1;return!0}function Io(t){if(t instanceof go)return t.field.canonicalString()+t.op.toString()+Gi(t.value);if(vo(t))return t.filters.map((t=>Io(t))).join(",");{const e=t.filters.map((t=>Io(t))).join(",");return`${t.op}(${e})`}}function _o(t,e){return t instanceof go?function(t,e){return e instanceof go&&t.op===e.op&&t.field.isEqual(e.field)&&Ui(t.value,e.value)}(t,e):t instanceof po?function(t,e){return e instanceof po&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,r)=>t&&_o(n,e.filters[r])),!0)}(t,e):void Fr()}function To(t,e){const n=t.filters.concat(e);return po.create(n,t.op)}function Eo(t){return t instanceof go?function(t){return`${t.field.canonicalString()} ${t.op} ${Gi(t.value)}`}(t):t instanceof po?function(t){return t.op.toString()+" {"+t.getFilters().map(Eo).join(" ,")+"}"}(t):"Filter"}class So extends go{constructor(t,e,n){super(t,e,n),this.key=cs.fromName(n.referenceValue)}matches(t){const e=cs.comparator(t.key,this.key);return this.matchesComparison(e)}}class xo extends go{constructor(t,e){super(t,"in",e),this.keys=Do(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Co extends go{constructor(t,e){super(t,"not-in",e),this.keys=Do(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Do(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>cs.fromName(t.referenceValue)))}class Ao extends go{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Hi(e)&&Bi(e.arrayValue,this.value)}}class No extends go{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&Bi(this.value.arrayValue,e)}}class ko extends go{constructor(t,e){super(t,"not-in",e)}matches(t){if(Bi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!Bi(this.value.arrayValue,e)}}class Ro extends go{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Hi(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>Bi(this.value.arrayValue,t)))}}class Mo{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ce=null}}function Po(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Mo(t,e,n,r,s,i,o)}function Lo(t){const e=qr(t);if(null===e.ce){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>Io(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Os(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>Gi(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>Gi(t))).join(",")),e.ce=t}return e.ce}function Fo(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!fo(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!_o(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!lo(t.startAt,e.startAt)&&lo(t.endAt,e.endAt)}function Oo(t){return cs.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Vo(t,e){return t.filters.filter((t=>t instanceof go&&t.field.isEqual(e)))}function qo(t,e,n){let r=Vi,s=!0;for(const n of Vo(t,e)){let t=Vi,e=!0;switch(n.op){case"<":case"<=":t=eo(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Vi}ro({value:r,inclusive:s},{value:t,inclusive:e})<0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];ro({value:r,inclusive:s},{value:t,inclusive:n.inclusive})<0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}function Uo(t,e,n){let r=Oi,s=!0;for(const n of Vo(t,e)){let t=Oi,e=!0;switch(n.op){case">=":case">":t=no(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Oi}so({value:r,inclusive:s},{value:t,inclusive:e})>0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];so({value:r,inclusive:s},{value:t,inclusive:n.inclusive})>0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}class Bo{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function zo(t,e,n,r,s,i,o,a){return new Bo(t,e,n,r,s,i,o,a)}function Ko(t){return new Bo(t)}function Go(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function jo(t){return null!==t.collectionGroup}function $o(t){const e=qr(t);if(null===e.le){e.le=[];const t=new Set;for(const n of e.explicitOrderBy)e.le.push(n),t.add(n.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc",r=function(t){let e=new Ii(us.comparator);return t.filters.forEach((t=>{t.getFlattenedFilters().forEach((t=>{t.isInequality()&&(e=e.add(t.field))}))})),e}(e);r.forEach((r=>{t.has(r.canonicalString())||r.isKeyField()||e.le.push(new ho(r,n))})),t.has(us.keyField().canonicalString())||e.le.push(new ho(us.keyField(),n))}return e.le}function Qo(t){const e=qr(t);return e.he||(e.he=Wo(e,$o(t))),e.he}function Wo(t,e){if("F"===t.limitType)return Po(t.path,t.collectionGroup,e,t.filters,t.limit,t.startAt,t.endAt);{e=e.map((t=>{const e="desc"===t.dir?"asc":"desc";return new ho(t.field,e)}));const n=t.endAt?new uo(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new uo(t.startAt.position,t.startAt.inclusive):null;return Po(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}}function Ho(t,e){const n=t.filters.concat([e]);return new Bo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function Yo(t,e,n){return new Bo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Xo(t,e){return Fo(Qo(t),Qo(e))&&t.limitType===e.limitType}function Jo(t){return`${Lo(Qo(t))}|lt:${t.limitType}`}function Zo(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>Eo(t))).join(", ")}]`),Os(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>Gi(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>Gi(t))).join(",")),`Target(${e})`}(Qo(t))}; limitType=${t.limitType})`}function ta(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):cs.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of $o(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const r=co(t,e,n);return t.inclusive?r<=0:r<0}(t.startAt,$o(t),e)||t.endAt&&!function(t,e,n){const r=co(t,e,n);return t.inclusive?r>=0:r>0}(t.endAt,$o(t),e))}(t,e)}function ea(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function na(t){return(e,n)=>{let r=!1;for(const s of $o(t)){const t=ra(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function ra(t,e,n){const r=t.field.isKeyField()?cs.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?zi(r,s):Fr()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return Fr()}}class sa{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(t){pi(this.inner,((e,n)=>{for(const[e,r]of n)t(e,r)}))}isEmpty(){return yi(this.inner)}size(){return this.innerSize}}const ia=new wi(cs.comparator);function oa(){return ia}const aa=new wi(cs.comparator);function ua(...t){let e=aa;for(const n of t)e=e.insert(n.key,n);return e}function ca(t){let e=aa;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function la(){return da()}function ha(){return da()}function da(){return new sa((t=>t.toString()),((t,e)=>t.isEqual(e)))}const fa=new wi(cs.comparator),ma=new Ii(cs.comparator);function ga(...t){let e=ma;for(const n of t)e=e.add(n);return e}const pa=new Ii(ts);function ya(){return pa}function wa(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Vs(e)?"-0":e}}function va(t){return{integerValue:""+t}}function ba(t,e){return qs(e)?va(e):wa(t,e)}class Ia{constructor(){this._=void 0}}function _a(t,e,n){return t instanceof Sa?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&Ri(e)&&(e=Mi(e)),e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof xa?Ca(t,e):t instanceof Da?Aa(t,e):function(t,e){const n=Ea(t,e),r=ka(n)+ka(t.Ie);return Wi(n)&&Wi(t.Ie)?va(r):wa(t.serializer,r)}(t,e)}function Ta(t,e,n){return t instanceof xa?Ca(t,e):t instanceof Da?Aa(t,e):n}function Ea(t,e){return t instanceof Na?function(t){return Wi(t)||function(t){return!!t&&"doubleValue"in t}(t)}(e)?e:{integerValue:0}:null}class Sa extends Ia{}class xa extends Ia{constructor(t){super(),this.elements=t}}function Ca(t,e){const n=Ra(e);for(const e of t.elements)n.some((t=>Ui(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Da extends Ia{constructor(t){super(),this.elements=t}}function Aa(t,e){let n=Ra(e);for(const e of t.elements)n=n.filter((t=>!Ui(t,e)));return{arrayValue:{values:n}}}class Na extends Ia{constructor(t,e){super(),this.serializer=t,this.Ie=e}}function ka(t){return Ni(t.integerValue||t.doubleValue)}function Ra(t){return Hi(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Ma{constructor(t,e){this.field=t,this.transform=e}}class Pa{constructor(t,e){this.version=t,this.transformResults=e}}class La{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new La}static exists(t){return new La(void 0,t)}static updateTime(t){return new La(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Fa(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Oa{}function Va(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Wa(t.key,La.none()):new Ka(t.key,t.data,La.none());{const n=t.data,r=io.empty();let s=new Ii(us.comparator);for(let t of e.fields)if(!s.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?r.delete(t):r.set(t,e),s=s.add(t)}return new Ga(t.key,r,new Ei(s.toArray()),La.none())}}function qa(t,e,n){t instanceof Ka?function(t,e,n){const r=t.value.clone(),s=$a(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Ga?function(t,e,n){if(!Fa(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=$a(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(ja(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ua(t,e,n,r){return t instanceof Ka?function(t,e,n,r){if(!Fa(t.precondition,e))return n;const s=t.value.clone(),i=Qa(t.fieldTransforms,r,e);return s.setAll(i),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null}(t,e,n,r):t instanceof Ga?function(t,e,n,r){if(!Fa(t.precondition,e))return n;const s=Qa(t.fieldTransforms,r,e),i=e.data;return i.setAll(ja(t)),i.setAll(s),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,r):function(t,e,n){return Fa(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Ba(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=Ea(r.transform,t||null);null!=s&&(null===n&&(n=io.empty()),n.set(r.field,s))}return n||null}function za(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&es(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof xa&&e instanceof xa||t instanceof Da&&e instanceof Da?es(t.elements,e.elements,Ui):t instanceof Na&&e instanceof Na?Ui(t.Ie,e.Ie):t instanceof Sa&&e instanceof Sa}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Ka extends Oa{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Ga extends Oa{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function ja(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function $a(t,e,n){const r=new Map;Or(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,Ta(o,a,n[s]))}return r}function Qa(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,_a(t,i,e))}return r}class Wa extends Oa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ha extends Oa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Ya{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&qa(r,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ua(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Ua(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=ha();return this.mutations.forEach((r=>{const s=t.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=e.has(r.key)?null:o;const a=Va(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(ss.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),ga())}isEqual(t){return this.batchId===t.batchId&&es(this.mutations,t.mutations,((t,e)=>za(t,e)))&&es(this.baseMutations,t.baseMutations,((t,e)=>za(t,e)))}}class Xa{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){Or(t.mutations.length===n.length);let r=fa;const s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new Xa(t,e,n,r)}}class Ja{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Za{constructor(t,e,n){this.alias=t,this.aggregateType=e,this.fieldPath=n}}class tu{constructor(t,e){this.count=t,this.unchangedNames=e}}var eu,nu;function ru(t){switch(t){default:return Fr();case Ur.CANCELLED:case Ur.UNKNOWN:case Ur.DEADLINE_EXCEEDED:case Ur.RESOURCE_EXHAUSTED:case Ur.INTERNAL:case Ur.UNAVAILABLE:case Ur.UNAUTHENTICATED:return!1;case Ur.INVALID_ARGUMENT:case Ur.NOT_FOUND:case Ur.ALREADY_EXISTS:case Ur.PERMISSION_DENIED:case Ur.FAILED_PRECONDITION:case Ur.ABORTED:case Ur.OUT_OF_RANGE:case Ur.UNIMPLEMENTED:case Ur.DATA_LOSS:return!0}}function su(t){if(void 0===t)return Mr("GRPC error has no .code"),Ur.UNKNOWN;switch(t){case eu.OK:return Ur.OK;case eu.CANCELLED:return Ur.CANCELLED;case eu.UNKNOWN:return Ur.UNKNOWN;case eu.DEADLINE_EXCEEDED:return Ur.DEADLINE_EXCEEDED;case eu.RESOURCE_EXHAUSTED:return Ur.RESOURCE_EXHAUSTED;case eu.INTERNAL:return Ur.INTERNAL;case eu.UNAVAILABLE:return Ur.UNAVAILABLE;case eu.UNAUTHENTICATED:return Ur.UNAUTHENTICATED;case eu.INVALID_ARGUMENT:return Ur.INVALID_ARGUMENT;case eu.NOT_FOUND:return Ur.NOT_FOUND;case eu.ALREADY_EXISTS:return Ur.ALREADY_EXISTS;case eu.PERMISSION_DENIED:return Ur.PERMISSION_DENIED;case eu.FAILED_PRECONDITION:return Ur.FAILED_PRECONDITION;case eu.ABORTED:return Ur.ABORTED;case eu.OUT_OF_RANGE:return Ur.OUT_OF_RANGE;case eu.UNIMPLEMENTED:return Ur.UNIMPLEMENTED;case eu.DATA_LOSS:return Ur.DATA_LOSS;default:return Fr()}}(nu=eu||(eu={}))[nu.OK=0]="OK",nu[nu.CANCELLED=1]="CANCELLED",nu[nu.UNKNOWN=2]="UNKNOWN",nu[nu.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",nu[nu.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",nu[nu.NOT_FOUND=5]="NOT_FOUND",nu[nu.ALREADY_EXISTS=6]="ALREADY_EXISTS",nu[nu.PERMISSION_DENIED=7]="PERMISSION_DENIED",nu[nu.UNAUTHENTICATED=16]="UNAUTHENTICATED",nu[nu.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",nu[nu.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",nu[nu.ABORTED=10]="ABORTED",nu[nu.OUT_OF_RANGE=11]="OUT_OF_RANGE",nu[nu.UNIMPLEMENTED=12]="UNIMPLEMENTED",nu[nu.INTERNAL=13]="INTERNAL",nu[nu.UNAVAILABLE=14]="UNAVAILABLE",nu[nu.DATA_LOSS=15]="DATA_LOSS";let iu=null;function ou(){return new TextEncoder}const au=new Sr([4294967295,4294967295],0);function uu(t){const e=ou().encode(t),n=new Er;return n.update(e),new Uint8Array(n.digest())}function cu(t){const e=new DataView(t.buffer),n=e.getUint32(0,!0),r=e.getUint32(4,!0),s=e.getUint32(8,!0),i=e.getUint32(12,!0);return[new Sr([n,r],0),new Sr([s,i],0)]}class lu{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new hu(`Invalid padding: ${e}`);if(n<0)throw new hu(`Invalid hash count: ${n}`);if(t.length>0&&0===this.hashCount)throw new hu(`Invalid hash count: ${n}`);if(0===t.length&&0!==e)throw new hu(`Invalid padding when bitmap length is 0: ${e}`);this.Te=8*t.length-e,this.Ee=Sr.fromNumber(this.Te)}de(t,e,n){let r=t.add(e.multiply(Sr.fromNumber(n)));return 1===r.compare(au)&&(r=new Sr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(0===this.Te)return!1;const e=uu(t),[n,r]=cu(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);if(!this.Ae(e))return!1}return!0}static create(t,e,n){const r=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),i=new lu(s,r,e);return n.forEach((t=>i.insert(t))),i}insert(t){if(0===this.Te)return;const e=uu(t),[n,r]=cu(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);this.Re(e)}}Re(t){const e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}}class hu extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class du{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const r=new Map;return r.set(t,fu.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new du(ss.min(),r,new wi(ts),oa(),ga())}}class fu{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new fu(n,e,ga(),ga(),ga())}}class mu{constructor(t,e,n,r){this.Ve=t,this.removedTargetIds=e,this.key=n,this.me=r}}class gu{constructor(t,e){this.targetId=t,this.fe=e}}class pu{constructor(t,e,n=Ci.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class yu{constructor(){this.ge=0,this.pe=bu(),this.ye=Ci.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(t){t.approximateByteSize()>0&&(this.Se=!0,this.ye=t)}ve(){let t=ga(),e=ga(),n=ga();return this.pe.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:Fr()}})),new fu(this.ye,this.we,t,e,n)}Fe(){this.Se=!1,this.pe=bu()}Me(t,e){this.Se=!0,this.pe=this.pe.insert(t,e)}xe(t){this.Se=!0,this.pe=this.pe.remove(t)}Oe(){this.ge+=1}Ne(){this.ge-=1,Or(this.ge>=0)}Be(){this.Se=!0,this.we=!0}}class wu{constructor(t){this.Le=t,this.ke=new Map,this.qe=oa(),this.Qe=vu(),this.Ke=new wi(ts)}$e(t){for(const e of t.Ve)t.me&&t.me.isFoundDocument()?this.Ue(e,t.me):this.We(e,t.key,t.me);for(const e of t.removedTargetIds)this.We(e,t.key,t.me)}Ge(t){this.forEachTarget(t,(e=>{const n=this.ze(e);switch(t.state){case 0:this.je(e)&&n.Ce(t.resumeToken);break;case 1:n.Ne(),n.be||n.Fe(),n.Ce(t.resumeToken);break;case 2:n.Ne(),n.be||this.removeTarget(e);break;case 3:this.je(e)&&(n.Be(),n.Ce(t.resumeToken));break;case 4:this.je(e)&&(this.He(e),n.Ce(t.resumeToken));break;default:Fr()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.ke.forEach(((t,n)=>{this.je(n)&&e(n)}))}Je(t){const e=t.targetId,n=t.fe.count,r=this.Ye(e);if(r){const s=r.target;if(Oo(s))if(0===n){const t=new cs(s.path);this.We(e,t,ao.newNoDocument(t,ss.min()))}else Or(1===n);else{const r=this.Ze(e);if(r!==n){const n=this.Xe(t),s=n?this.et(n,t,r):1;if(0!==s){this.He(e);const t=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(e,t)}null==iu||iu.tt(function(t,e,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:t,existenceFilterCount:e.count,databaseId:n.database,projectId:n.projectId},d=e.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:t=>{var e;return null!==(e=null==r?void 0:r.mightContain(t))&&void 0!==e&&e}}),h}(r,t.fe,this.Le.nt(),n,s))}}}}Xe(t){const e=t.fe.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=e;let i,o;try{i=ki(n).toUint8Array()}catch(t){if(t instanceof Si)return Pr("Decoding the base64 bloom filter in existence filter failed ("+t.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw t}try{o=new lu(i,r,s)}catch(t){return Pr(t instanceof hu?"BloomFilter error: ":"Applying bloom filter failed: ",t),null}return 0===o.Te?null:o}et(t,e,n){return e.fe.count===n-this.rt(t,e.targetId)?0:2}rt(t,e){const n=this.Le.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const s=this.Le.nt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;t.mightContain(i)||(this.We(e,n,null),r++)})),r}it(t){const e=new Map;this.ke.forEach(((n,r)=>{const s=this.Ye(r);if(s){if(n.current&&Oo(s.target)){const e=new cs(s.target.path);null!==this.qe.get(e)||this.st(r,e)||this.We(r,e,ao.newNoDocument(e,t))}n.De&&(e.set(r,n.ve()),n.Fe())}}));let n=ga();this.Qe.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.Ye(t);return!e||"TargetPurposeLimboResolution"===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))})),this.qe.forEach(((e,n)=>n.setReadTime(t)));const r=new du(t,e,this.Ke,this.qe,n);return this.qe=oa(),this.Qe=vu(),this.Ke=new wi(ts),r}Ue(t,e){if(!this.je(t))return;const n=this.st(t,e.key)?2:0;this.ze(t).Me(e.key,n),this.qe=this.qe.insert(e.key,e),this.Qe=this.Qe.insert(e.key,this.ot(e.key).add(t))}We(t,e,n){if(!this.je(t))return;const r=this.ze(t);this.st(t,e)?r.Me(e,1):r.xe(e),this.Qe=this.Qe.insert(e,this.ot(e).delete(t)),n&&(this.qe=this.qe.insert(e,n))}removeTarget(t){this.ke.delete(t)}Ze(t){const e=this.ze(t).ve();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Oe(t){this.ze(t).Oe()}ze(t){let e=this.ke.get(t);return e||(e=new yu,this.ke.set(t,e)),e}ot(t){let e=this.Qe.get(t);return e||(e=new Ii(ts),this.Qe=this.Qe.insert(t,e)),e}je(t){const e=null!==this.Ye(t);return e||Rr("WatchChangeAggregator","Detected inactive target",t),e}Ye(t){const e=this.ke.get(t);return e&&e.be?null:this.Le._t(t)}He(t){this.ke.set(t,new yu),this.Le.getRemoteKeysForTarget(t).forEach((e=>{this.We(t,e,null)}))}st(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}}function vu(){return new wi(cs.comparator)}function bu(){return new wi(cs.comparator)}const Iu={asc:"ASCENDING",desc:"DESCENDING"},_u={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Tu={and:"AND",or:"OR"};class Eu{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Su(t,e){return t.useProto3Json||Os(e)?e:{value:e}}function xu(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Cu(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function Du(t,e){return xu(t,e.toTimestamp())}function Au(t){return Or(!!t),ss.fromTimestamp(function(t){const e=Ai(t);return new rs(e.seconds,e.nanos)}(t))}function Nu(t,e){return ku(t,e).canonicalString()}function ku(t,e){const n=function(t){return new os(["projects",t.projectId,"databases",t.database])}(t).child("documents");return void 0===e?n:n.child(e)}function Ru(t){const e=os.fromString(t);return Or(tc(e)),e}function Mu(t,e){return Nu(t.databaseId,e.path)}function Pu(t,e){const n=Ru(e);if(n.get(1)!==t.databaseId.projectId)throw new Br(Ur.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Br(Ur.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new cs(Vu(n))}function Lu(t,e){return Nu(t.databaseId,e)}function Fu(t){const e=Ru(t);return 4===e.length?os.emptyPath():Vu(e)}function Ou(t){return new os(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Vu(t){return Or(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function qu(t,e,n){return{name:Mu(t,e),fields:n.value.mapValue.fields}}function Uu(t,e,n){const r=Pu(t,e.name),s=Au(e.updateTime),i=e.createTime?Au(e.createTime):ss.min(),o=new io({mapValue:{fields:e.fields}}),a=ao.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Bu(t,e){let n;if(e instanceof Ka)n={update:qu(t,e.key,e.value)};else if(e instanceof Wa)n={delete:Mu(t,e.key)};else if(e instanceof Ga)n={update:qu(t,e.key,e.data),updateMask:Zu(e.fieldMask)};else{if(!(e instanceof Ha))return Fr();n={verify:Mu(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof Sa)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof xa)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Da)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Na)return{fieldPath:e.field.canonicalString(),increment:n.Ie};throw Fr()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Du(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Fr()}(t,e.precondition)),n}function zu(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?La.updateTime(Au(t.updateTime)):void 0!==t.exists?La.exists(t.exists):La.none()}(e.currentDocument):La.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Or("REQUEST_TIME"===e.setToServerValue),n=new Sa;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new xa(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Da(t)}else"increment"in e?n=new Na(t,e.increment):Fr();const r=us.fromServerFormat(e.fieldPath);return new Ma(r,n)}(t,e))):[];if(e.update){e.update.name;const s=Pu(t,e.update.name),i=new io({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Ei(e.map((t=>us.fromServerFormat(t))))}(e.updateMask);return new Ga(s,i,t,n,r)}return new Ka(s,i,n,r)}if(e.delete){const r=Pu(t,e.delete);return new Wa(r,n)}if(e.verify){const r=Pu(t,e.verify);return new Ha(r,n)}return Fr()}function Ku(t,e){return{documents:[Lu(t,e.path)]}}function Gu(t,e){const n={structuredQuery:{}},r=e.path;let s;null!==e.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=Lu(t,s);const i=function(t){if(0!==t.length)return Ju(po.create(t,"and"))}(e.filters);i&&(n.structuredQuery.where=i);const o=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Yu(t.field),direction:Qu(t.dir)}}(t)))}(e.orderBy);o&&(n.structuredQuery.orderBy=o);const a=Su(t,e.limit);return null!==a&&(n.structuredQuery.limit=a),e.startAt&&(n.structuredQuery.startAt=function(t){return{before:t.inclusive,values:t.position}}(e.startAt)),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),{ut:n,parent:s}}function ju(t){let e=Fu(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){Or(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function(t){const e=$u(t);return e instanceof po&&vo(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=function(t){return t.map((t=>function(t){return new ho(Xu(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t)))}(n.orderBy));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,Os(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new uo(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new uo(n,e)}(n.endAt)),zo(e,s,o,i,a,"F",u,c)}function $u(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Xu(t.unaryFilter.field);return go.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Xu(t.unaryFilter.field);return go.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Xu(t.unaryFilter.field);return go.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Xu(t.unaryFilter.field);return go.create(s,"!=",{nullValue:"NULL_VALUE"});default:return Fr()}}(t):void 0!==t.fieldFilter?function(t){return go.create(Xu(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Fr()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return po.create(t.compositeFilter.filters.map((t=>$u(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return Fr()}}(t.compositeFilter.op))}(t):Fr()}function Qu(t){return Iu[t]}function Wu(t){return _u[t]}function Hu(t){return Tu[t]}function Yu(t){return{fieldPath:t.canonicalString()}}function Xu(t){return us.fromServerFormat(t.fieldPath)}function Ju(t){return t instanceof go?function(t){if("=="===t.op){if(Xi(t.value))return{unaryFilter:{field:Yu(t.field),op:"IS_NAN"}};if(Yi(t.value))return{unaryFilter:{field:Yu(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Xi(t.value))return{unaryFilter:{field:Yu(t.field),op:"IS_NOT_NAN"}};if(Yi(t.value))return{unaryFilter:{field:Yu(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Yu(t.field),op:Wu(t.op),value:t.value}}}(t):t instanceof po?function(t){const e=t.getFilters().map((t=>Ju(t)));return 1===e.length?e[0]:{compositeFilter:{op:Hu(t.op),filters:e}}}(t):Fr()}function Zu(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function tc(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class ec{constructor(t,e,n,r,s=ss.min(),i=ss.min(),o=Ci.EMPTY_BYTE_STRING,a=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(t){return new ec(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new ec(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new ec(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new ec(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}class nc{constructor(t){this.ct=t}}function rc(t,e){const n=e.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:sc(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(t,e){return{name:Mu(t,e.key),fields:e.data.value.mapValue.fields,updateTime:xu(t,e.version.toTimestamp()),createTime:xu(t,e.createTime.toTimestamp())}}(t.ct,e);else if(e.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:ic(e.version)};else{if(!e.isUnknownDocument())return Fr();r.unknownDocument={path:n.path.toArray(),version:ic(e.version)}}return r}function sc(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function ic(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function oc(t){const e=new rs(t.seconds,t.nanoseconds);return ss.fromTimestamp(e)}function ac(t,e){const n=(e.baseMutations||[]).map((e=>zu(t.ct,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const r=e.mutations[t+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const r=e.mutations.map((e=>zu(t.ct,e))),s=rs.fromMillis(e.localWriteTimeMs);return new Ya(e.batchId,s,n,r)}function uc(t){const e=oc(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?oc(t.lastLimboFreeSnapshotVersion):ss.min();let r;return r=function(t){return void 0!==t.documents}(t.query)?function(t){return Or(1===t.documents.length),Qo(Ko(Fu(t.documents[0])))}(t.query):function(t){return Qo(ju(t))}(t.query),new ec(r,t.targetId,"TargetPurposeListen",t.lastListenSequenceNumber,e,n,Ci.fromBase64String(t.resumeToken))}function cc(t,e){const n=ic(e.snapshotVersion),r=ic(e.lastLimboFreeSnapshotVersion);let s;s=Oo(e.target)?Ku(t.ct,e.target):Gu(t.ct,e.target).ut;const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Lo(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function lc(t){const e=ju({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Yo(e,e.limit,"L"):e}function hc(t,e){return new Ja(e.largestBatchId,zu(t.ct,e.overlayMutation))}function dc(t,e){const n=e.path.lastSegment();return[t,Us(e.path.popLast()),n]}function fc(t,e,n,r){return{indexId:t,uid:e,sequenceNumber:n,readTime:ic(r.readTime),documentKey:Us(r.documentKey.path),largestBatchId:r.largestBatchId}}class mc{getBundleMetadata(t,e){return gc(t).get(e).next((t=>{if(t)return function(t){return{id:t.bundleId,createTime:oc(t.createTime),version:t.version}}(t)}))}saveBundleMetadata(t,e){return gc(t).put(function(t){return{bundleId:t.id,createTime:ic(Au(t.createTime)),version:t.version}}(e))}getNamedQuery(t,e){return pc(t).get(e).next((t=>{if(t)return function(t){return{name:t.name,query:lc(t.bundledQuery),readTime:oc(t.readTime)}}(t)}))}saveNamedQuery(t,e){return pc(t).put(function(t){return{name:t.name,readTime:ic(Au(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function gc(t){return mi(t,"bundles")}function pc(t){return mi(t,"namedQueries")}class yc{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){const n=e.uid||"";return new yc(t,n)}getOverlay(t,e){return wc(t).get(dc(this.userId,e)).next((t=>t?hc(this.serializer,t):null))}getOverlays(t,e){const n=la();return Es.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const r=[];return n.forEach(((n,s)=>{const i=new Ja(e,s);r.push(this.ht(t,i))})),Es.waitFor(r)}removeOverlaysForBatchId(t,e,n){const r=new Set;e.forEach((t=>r.add(Us(t.getCollectionPath()))));const s=[];return r.forEach((e=>{const r=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(wc(t).H("collectionPathOverlayIndex",r))})),Es.waitFor(s)}getOverlaysForCollection(t,e,n){const r=la(),s=Us(e),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return wc(t).W("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=hc(this.serializer,e);r.set(t.getKey(),t)}return r}))}getOverlaysForCollectionGroup(t,e,n,r){const s=la();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return wc(t).Y({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=hc(this.serializer,e);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ht(t,e){return wc(t).put(function(t,e,n){const[r,s,i]=dc(e,n.mutation.key);return{userId:e,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Bu(t.ct,n.mutation)}}(this.serializer,this.userId,e))}}function wc(t){return mi(t,"documentOverlays")}class vc{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(Ni(t.integerValue));else if("doubleValue"in t){const n=Ni(t.doubleValue);isNaN(n)?this.Et(e,13):(this.Et(e,15),Vs(n)?e.dt(0):e.dt(n))}else if("timestampValue"in t){const n=t.timestampValue;this.Et(e,20),"string"==typeof n?e.At(n):(e.At(`${n.seconds||""}`),e.dt(n.nanos||0))}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(ki(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.Et(e,45),e.dt(n.latitude||0),e.dt(n.longitude||0)}else"mapValue"in t?to(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):Fr()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){const n=t.fields||{};this.Et(e,55);for(const t of Object.keys(n))this.Rt(t,e),this.It(n[t],e)}wt(t,e){const n=t.values||[];this.Et(e,50);for(const t of n)this.It(t,e)}gt(t,e){this.Et(e,37),cs.fromName(t).path.forEach((t=>{this.Et(e,60),this.St(t,e)}))}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}}function bc(t){if(0===t)return 8;let e=0;return!(t>>4)&&(e+=4,t<<=4),!(t>>6)&&(e+=2,t<<=2),!(t>>7)&&(e+=1),e}function Ic(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const r=bc(255&t[n]);if(e+=r,8!==r)break}return e}(t);return Math.ceil(e/8)}vc.bt=new vc;class _c{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ct(n.value),n=e.next();this.vt()}Ft(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Mt(n.value),n=e.next();this.xt()}Ot(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ct(t);else if(t<2048)this.Ct(960|t>>>6),this.Ct(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ct(480|t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t);else{const t=e.codePointAt(0);this.Ct(240|t>>>18),this.Ct(128|63&t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t)}}this.vt()}Nt(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Mt(t);else if(t<2048)this.Mt(960|t>>>6),this.Mt(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Mt(480|t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t);else{const t=e.codePointAt(0);this.Mt(240|t>>>18),this.Mt(128|63&t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t)}}this.xt()}Bt(t){const e=this.Lt(t),n=Ic(e);this.kt(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}qt(t){const e=this.Lt(t),n=Ic(e);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(t){this.kt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Wt(){return this.buffer.slice(0,this.position)}Lt(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=!!(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ct(t){const e=255&t;0===e?(this.Kt(0),this.Kt(255)):255===e?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(t){const e=255&t;0===e?(this.Ut(0),this.Ut(255)):255===e?(this.Ut(255),this.Ut(0)):this.Ut(t)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(t){this.kt(1),this.buffer[this.position++]=t}Ut(t){this.kt(1),this.buffer[this.position++]=~t}kt(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class Tc{constructor(t){this.Gt=t}ft(t){this.Gt.Dt(t)}At(t){this.Gt.Ot(t)}dt(t){this.Gt.Bt(t)}Tt(){this.Gt.Qt()}}class Ec{constructor(t){this.Gt=t}ft(t){this.Gt.Ft(t)}At(t){this.Gt.Nt(t)}dt(t){this.Gt.qt(t)}Tt(){this.Gt.$t()}}class Sc{constructor(){this.Gt=new _c,this.zt=new Tc(this.Gt),this.jt=new Ec(this.Gt)}seed(t){this.Gt.seed(t)}Ht(t){return 0===t?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class xc{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}Jt(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new xc(this.indexId,this.documentKey,this.arrayValue,n)}}function Cc(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Dc(t.arrayValue,e.arrayValue),0!==n?n:(n=Dc(t.directionalValue,e.directionalValue),0!==n?n:cs.comparator(t.documentKey,e.documentKey)))}function Dc(t,e){for(let n=0;n<t.length&&n<e.length;++n){const r=t[n]-e[n];if(0!==r)return r}return t.length-e.length}class Ac{constructor(t){this.Yt=new Ii(((t,e)=>us.comparator(t.field,e.field))),this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Zt=t.orderBy,this.Xt=[];for(const e of t.filters){const t=e;t.isInequality()?this.Yt=this.Yt.add(t):this.Xt.push(t)}}get en(){return this.Yt.size>1}tn(t){if(Or(t.collectionGroup===this.collectionId),this.en)return!1;const e=hs(t);if(void 0!==e&&!this.nn(e))return!1;const n=ds(t);let r=new Set,s=0,i=0;for(;s<n.length&&this.nn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Yt.size>0){const t=this.Yt.getIterator().getNext();if(!r.has(t.field.canonicalString())){const e=n[s];if(!this.rn(t,e)||!this.sn(this.Zt[i++],e))return!1}++s}for(;s<n.length;++s){const t=n[s];if(i>=this.Zt.length||!this.sn(this.Zt[i++],t))return!1}return!0}on(){if(this.en)return null;let t=new Ii(us.comparator);const e=[];for(const n of this.Xt)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)e.push(new ms(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new ms(n.field,0))}for(const n of this.Zt)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new ms(n.field,"asc"===n.dir?0:1)));return new ls(ls.UNKNOWN_ID,this.collectionId,e,ps.empty())}nn(t){for(const e of this.Xt)if(this.rn(e,t))return!0;return!1}rn(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function Nc(t){var e,n;if(Or(t instanceof go||t instanceof po),t instanceof go){if(t instanceof No){const r=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>go.create(t.field,"==",e))))||[];return po.create(r,"or")}return t}const r=t.filters.map((t=>Nc(t)));return po.create(r,t.op)}function kc(t){if(0===t.getFilters().length)return[];const e=Lc(Nc(t));return Or(Pc(e)),Rc(e)||Mc(e)?[e]:e.getFilters()}function Rc(t){return t instanceof go}function Mc(t){return t instanceof po&&vo(t)}function Pc(t){return Rc(t)||Mc(t)||function(t){if(t instanceof po&&wo(t)){for(const e of t.getFilters())if(!Rc(e)&&!Mc(e))return!1;return!0}return!1}(t)}function Lc(t){if(Or(t instanceof go||t instanceof po),t instanceof go)return t;if(1===t.filters.length)return Lc(t.filters[0]);const e=t.filters.map((t=>Lc(t)));let n=po.create(e,t.op);return n=Vc(n),Pc(n)?n:(Or(n instanceof po),Or(yo(n)),Or(n.filters.length>1),n.filters.reduce(((t,e)=>Fc(t,e))))}function Fc(t,e){let n;return Or(t instanceof go||t instanceof po),Or(e instanceof go||e instanceof po),n=t instanceof go?e instanceof go?function(t,e){return po.create([t,e],"and")}(t,e):Oc(t,e):e instanceof go?Oc(e,t):function(t,e){if(Or(t.filters.length>0&&e.filters.length>0),yo(t)&&yo(e))return To(t,e.getFilters());const n=wo(t)?t:e,r=wo(t)?e:t,s=n.filters.map((t=>Fc(t,r)));return po.create(s,"or")}(t,e),Vc(n)}function Oc(t,e){if(yo(e))return To(e,t.getFilters());{const n=e.filters.map((e=>Fc(t,e)));return po.create(n,"or")}}function Vc(t){if(Or(t instanceof go||t instanceof po),t instanceof go)return t;const e=t.getFilters();if(1===e.length)return Vc(e[0]);if(bo(t))return t;const n=e.map((t=>Vc(t))),r=[];return n.forEach((e=>{e instanceof go?r.push(e):e instanceof po&&(e.op===t.op?r.push(...e.filters):r.push(e))})),1===r.length?r[0]:po.create(r,t.op)}class qc{constructor(){this._n=new Uc}addToCollectionParentIndex(t,e){return this._n.add(e),Es.resolve()}getCollectionParents(t,e){return Es.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return Es.resolve()}deleteFieldIndex(t,e){return Es.resolve()}deleteAllFieldIndexes(t){return Es.resolve()}createTargetIndexes(t,e){return Es.resolve()}getDocumentsMatchingTarget(t,e){return Es.resolve(null)}getIndexType(t,e){return Es.resolve(0)}getFieldIndexes(t,e){return Es.resolve([])}getNextCollectionGroupToUpdate(t){return Es.resolve(null)}getMinOffset(t,e){return Es.resolve(vs.min())}getMinOffsetFromCollectionGroup(t,e){return Es.resolve(vs.min())}updateCollectionGroup(t,e,n){return Es.resolve()}updateIndexEntries(t,e){return Es.resolve()}}class Uc{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Ii(os.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Ii(os.comparator)).toArray()}}const Bc=new Uint8Array(0);class zc{constructor(t,e){this.databaseId=e,this.an=new Uc,this.un=new sa((t=>Lo(t)),((t,e)=>Fo(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.an.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.an.add(e)}));const s={collectionId:n,parent:Us(r)};return Kc(t).put(s)}return Es.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[ns(e),""],!1,!0);return Kc(t).W(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(Ks(r.parent))}return n}))}addFieldIndex(t,e){const n=jc(t),r=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete r.indexId;const s=n.add(r);if(e.indexState){const n=$c(t);return s.next((t=>{n.put(fc(t,this.uid,e.indexState.sequenceNumber,e.indexState.offset))}))}return s.next()}deleteFieldIndex(t,e){const n=jc(t),r=$c(t),s=Gc(t);return n.delete(e.indexId).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}deleteAllFieldIndexes(t){const e=jc(t),n=Gc(t),r=$c(t);return e.H().next((()=>n.H())).next((()=>r.H()))}createTargetIndexes(t,e){return Es.forEach(this.cn(e),(e=>this.getIndexType(t,e).next((n=>{if(0===n||1===n){const n=new Ac(e).on();if(null!=n)return this.addFieldIndex(t,n)}}))))}getDocumentsMatchingTarget(t,e){const n=Gc(t);let r=!0;const s=new Map;return Es.forEach(this.cn(e),(e=>this.ln(t,e).next((t=>{r&&(r=!!t),s.set(e,t)})))).next((()=>{if(r){let t=ga();const r=[];return Es.forEach(s,((s,i)=>{Rr("IndexedDbIndexManager",`Using index ${function(t){return`id=${t.indexId}|cg=${t.collectionGroup}|f=${t.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`}(s)} to execute ${Lo(e)}`);const o=function(t,e){const n=hs(e);if(void 0===n)return null;for(const e of Vo(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,s),a=function(t,e){const n=new Map;for(const r of ds(e))for(const e of Vo(t,r.fieldPath))switch(e.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,s),u=function(t,e){const n=[];let r=!0;for(const s of ds(e)){const e=0===s.kind?qo(t,s.fieldPath,t.startAt):Uo(t,s.fieldPath,t.startAt);n.push(e.value),r&&(r=e.inclusive)}return new uo(n,r)}(i,s),c=function(t,e){const n=[];let r=!0;for(const s of ds(e)){const e=0===s.kind?Uo(t,s.fieldPath,t.endAt):qo(t,s.fieldPath,t.endAt);n.push(e.value),r&&(r=e.inclusive)}return new uo(n,r)}(i,s),l=this.hn(s,i,u),h=this.hn(s,i,c),d=this.Pn(s,i,a),f=this.In(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return Es.forEach(f,(s=>n.j(s,e.limit).next((e=>{e.forEach((e=>{const n=cs.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),r.push(n))}))}))))})).next((()=>r))}return Es.resolve(null)}))}cn(t){let e=this.un.get(t);return e||(e=0===t.filters.length?[t]:kc(po.create(t.filters,"and")).map((e=>Po(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.un.set(t,e),e)}In(t,e,n,r,s,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,s.length),u=a/(null!=e?e.length:1),c=[];for(let l=0;l<a;++l){const a=e?this.Tn(e[l/u]):Bc,h=this.En(t,a,n[l%u],r),d=this.dn(t,a,s[l%u],i),f=o.map((e=>this.En(t,a,e,!0)));c.push(...this.createRange(h,d,f))}return c}En(t,e,n,r){const s=new xc(t,cs.empty(),e,n);return r?s:s.Jt()}dn(t,e,n,r){const s=new xc(t,cs.empty(),e,n);return r?s.Jt():s}ln(t,e){const n=new Ac(e),r=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,r).next((t=>{let e=null;for(const r of t)n.tn(r)&&(!e||r.fields.length>e.fields.length)&&(e=r);return e}))}getIndexType(t,e){let n=2;const r=this.cn(e);return Es.forEach(r,(e=>this.ln(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Ii(us.comparator),n=!1;for(const r of t.filters)for(const t of r.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&r.length>1&&2===n?1:n))}An(t,e){const n=new Sc;for(const r of ds(t)){const t=e.data.field(r.fieldPath);if(null==t)return null;const s=n.Ht(r.kind);vc.bt.Pt(t,s)}return n.Wt()}Tn(t){const e=new Sc;return vc.bt.Pt(t,e.Ht(0)),e.Wt()}Rn(t,e){const n=new Sc;return vc.bt.Pt(Qi(this.databaseId,e),n.Ht(function(t){const e=ds(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Wt()}Pn(t,e,n){if(null===n)return[];let r=[];r.push(new Sc);let s=0;for(const i of ds(t)){const t=n[s++];for(const n of r)if(this.Vn(e,i.fieldPath)&&Hi(t))r=this.mn(r,i,t);else{const e=n.Ht(i.kind);vc.bt.Pt(t,e)}}return this.fn(r)}hn(t,e,n){return this.Pn(t,e,n.position)}fn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Wt();return e}mn(t,e,n){const r=[...t],s=[];for(const t of n.arrayValue.values||[])for(const n of r){const r=new Sc;r.seed(n.Wt()),vc.bt.Pt(t,r.Ht(e.kind)),s.push(r)}return s}Vn(t,e){return!!t.filters.find((t=>t instanceof go&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=jc(t),r=$c(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return Es.forEach(t,(t=>r.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new ps(e.sequenceNumber,new vs(oc(e.readTime),new cs(Ks(e.documentKey)),e.largestBatchId)):ps.empty(),r=t.fields.map((([t,e])=>new ms(us.fromServerFormat(t),e)));return new ls(t.indexId,t.collectionGroup,r,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:ts(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const r=jc(t),s=$c(t);return this.gn(t).next((t=>r.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>Es.forEach(e,(e=>s.put(fc(e.indexId,this.uid,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return Es.forEach(e,((e,r)=>{const s=n.get(e.collectionGroup);return(s?Es.resolve(s):this.getFieldIndexes(t,e.collectionGroup)).next((s=>(n.set(e.collectionGroup,s),Es.forEach(s,(n=>this.pn(t,e,n).next((e=>{const s=this.yn(r,n);return e.isEqual(s)?Es.resolve():this.wn(t,r,n,e,s)})))))))}))}Sn(t,e,n,r){return Gc(t).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,e.key),documentKey:e.key.path.toArray()})}bn(t,e,n,r){return Gc(t).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,e.key),e.key.path.toArray()])}pn(t,e,n){const r=Gc(t);let s=new Ii(Cc);return r.Y({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,e)])},((t,r)=>{s=s.add(new xc(n.indexId,e,r.arrayValue,r.directionalValue))})).next((()=>s))}yn(t,e){let n=new Ii(Cc);const r=this.An(e,t);if(null==r)return n;const s=hs(e);if(null!=s){const i=t.data.field(s.fieldPath);if(Hi(i))for(const s of i.arrayValue.values||[])n=n.add(new xc(e.indexId,t.key,this.Tn(s),r))}else n=n.add(new xc(e.indexId,t.key,Bc,r));return n}wn(t,e,n,r,s){Rr("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,r,s){const i=t.getIterator(),o=e.getIterator();let a=Ti(i),u=Ti(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const r=n(a,u);r<0?e=!0:r>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(r(u),u=Ti(o)):e?(s(a),a=Ti(i)):(a=Ti(i),u=Ti(o))}}(r,s,Cc,(r=>{i.push(this.Sn(t,e,n,r))}),(r=>{i.push(this.bn(t,e,n,r))})),Es.waitFor(i)}gn(t){let e=1;return $c(t).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,r)=>{r.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Cc(t,e))).filter(((t,e,n)=>!e||0!==Cc(t,n[e-1])));const r=[];r.push(t);for(const s of n){const n=Cc(s,t),i=Cc(s,e);if(0===n)r[0]=t.Jt();else if(n>0&&i<0)r.push(s),r.push(s.Jt());else if(i>0)break}r.push(e);const s=[];for(let t=0;t<r.length;t+=2){if(this.Dn(r[t],r[t+1]))return[];const e=[r[t].indexId,this.uid,r[t].arrayValue,r[t].directionalValue,Bc,[]],n=[r[t+1].indexId,this.uid,r[t+1].arrayValue,r[t+1].directionalValue,Bc,[]];s.push(IDBKeyRange.bound(e,n))}return s}Dn(t,e){return Cc(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Qc)}getMinOffset(t,e){return Es.mapArray(this.cn(e),(e=>this.ln(t,e).next((t=>t||Fr())))).next(Qc)}}function Kc(t){return mi(t,"collectionParents")}function Gc(t){return mi(t,"indexEntries")}function jc(t){return mi(t,"indexConfiguration")}function $c(t){return mi(t,"indexState")}function Qc(t){Or(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let r=1;r<t.length;r++){const s=t[r].indexState.offset;bs(s,e)<0&&(e=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new vs(e.readTime,e.documentKey,n)}const Wc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Hc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Hc(t,Hc.DEFAULT_COLLECTION_PERCENTILE,Hc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Yc(t,e,n){const r=t.store("mutations"),s=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Y({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{Or(1===a)})));const c=[];for(const t of n.mutations){const r=$s(e,t.key.path,n.batchId);i.push(s.delete(r)),c.push(t.key)}return Es.waitFor(i).next((()=>c))}function Xc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Fr();e=t.noDocument}return JSON.stringify(e).length}Hc.DEFAULT_COLLECTION_PERCENTILE=10,Hc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Hc.DEFAULT=new Hc(41943040,Hc.DEFAULT_COLLECTION_PERCENTILE,Hc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Hc.DISABLED=new Hc(-1,0,0);class Jc{constructor(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(t,e,n,r){Or(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new Jc(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return tl(t).Y({index:"userMutationsIndex",range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=el(t),i=tl(t);return i.add({}).next((o=>{Or("number"==typeof o);const a=new Ya(o,e,n,r),u=function(t,e,n){const r=n.baseMutations.map((e=>Bu(t.ct,e))),s=n.mutations.map((e=>Bu(t.ct,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new Ii(((t,e)=>ts(t.canonicalString(),e.canonicalString())));for(const t of r){const e=$s(this.userId,t.key.path,o);l=l.add(t.key.path.popLast()),c.push(i.put(u)),c.push(s.put(e,Qs))}return l.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Cn[o]=a.keys()})),Es.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return tl(t).get(e).next((t=>t?(Or(t.userId===this.userId),ac(this.serializer,t)):null))}vn(t,e){return this.Cn[e]?Es.resolve(this.Cn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Cn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return tl(t).Y({index:"userMutationsIndex",range:r},((t,e,r)=>{e.userId===this.userId&&(Or(e.batchId>=n),s=ac(this.serializer,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return tl(t).Y({index:"userMutationsIndex",range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return tl(t).W("userMutationsIndex",e).next((t=>t.map((t=>ac(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=js(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return el(t).Y({range:r},((n,r,i)=>{const[o,a,u]=n,c=Ks(a);if(o===this.userId&&e.path.isEqual(c))return tl(t).get(u).next((t=>{if(!t)throw Fr();Or(t.userId===this.userId),s.push(ac(this.serializer,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ii(ts);const r=[];return e.forEach((e=>{const s=js(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=el(t).Y({range:i},((t,r,s)=>{const[i,o,a]=t,u=Ks(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),Es.waitFor(r).next((()=>this.Fn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=js(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Ii(ts);return el(t).Y({range:i},((t,e,s)=>{const[i,a,u]=t,c=Ks(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.Fn(t,o)))}Fn(t,e){const n=[],r=[];return e.forEach((e=>{r.push(tl(t).get(e).next((t=>{if(null===t)throw Fr();Or(t.userId===this.userId),n.push(ac(this.serializer,t))})))})),Es.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return Yc(t.ae,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.Mn(e.batchId)})),Es.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}Mn(t){delete this.Cn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Es.resolve();const n=IDBKeyRange.lowerBound(function(t){return[t]}(this.userId)),r=[];return el(t).Y({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=Ks(t[1]);r.push(e)}else n.done()})).next((()=>{Or(0===r.length)}))}))}containsKey(t,e){return Zc(t,this.userId,e)}xn(t){return nl(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Zc(t,e,n){const r=js(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return el(t).Y({range:i,J:!0},((t,n,r)=>{const[i,a,u]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function tl(t){return mi(t,"mutations")}function el(t){return mi(t,"documentMutations")}function nl(t){return mi(t,"mutationQueues")}class rl{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new rl(0)}static Bn(){return new rl(-1)}}class sl{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Ln(t).next((e=>{const n=new rl(e.highestTargetId);return e.highestTargetId=n.next(),this.kn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Ln(t).next((t=>ss.fromTimestamp(new rs(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Ln(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Ln(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.kn(t,r))))}addTargetData(t,e){return this.qn(t,e).next((()=>this.Ln(t).next((n=>(n.targetCount+=1,this.Qn(e,n),this.kn(t,n))))))}updateTargetData(t,e){return this.qn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>il(t).delete(e.targetId))).next((()=>this.Ln(t))).next((e=>(Or(e.targetCount>0),e.targetCount-=1,this.kn(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return il(t).Y(((i,o)=>{const a=uc(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>Es.waitFor(s))).next((()=>r))}forEachTarget(t,e){return il(t).Y(((t,n)=>{const r=uc(n);e(r)}))}Ln(t){return ol(t).get("targetGlobalKey").next((t=>(Or(null!==t),t)))}kn(t,e){return ol(t).put("targetGlobalKey",e)}qn(t,e){return il(t).put(cc(this.serializer,e))}Qn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Ln(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Lo(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return il(t).Y({range:r,index:"queryTargetsIndex"},((t,n,r)=>{const i=uc(n);Fo(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=al(t);return e.forEach((e=>{const i=Us(e.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(t,n,e))})),Es.waitFor(r)}removeMatchingKeys(t,e,n){const r=al(t);return Es.forEach(e,(e=>{const s=Us(e.path);return Es.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=al(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=al(t);let s=ga();return r.Y({range:n,J:!0},((t,e,n)=>{const r=Ks(t[1]),i=new cs(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Us(e.path),r=IDBKeyRange.bound([n],[ns(n)],!1,!0);let s=0;return al(t).Y({index:"documentTargetsIndex",J:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}_t(t,e){return il(t).get(e).next((t=>t?uc(t):null))}}function il(t){return mi(t,"targets")}function ol(t){return mi(t,"targetGlobal")}function al(t){return mi(t,"targetDocuments")}function ul([t,e],[n,r]){const s=ts(t,n);return 0===s?ts(e,r):s}class cl{constructor(t){this.Kn=t,this.buffer=new Ii(ul),this.$n=0}Un(){return++this.$n}Wn(t){const e=[t,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();ul(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class ll{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(t){Rr("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){As(t)?Rr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Ts(t)}await this.zn(3e5)}))}}class hl{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.Hn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Es.resolve(Fs._e);const n=new cl(e);return this.jn.forEachTarget(t,(t=>n.Wn(t.sequenceNumber))).next((()=>this.jn.Jn(t,(t=>n.Wn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Rr("LruGarbageCollector","Garbage collection skipped; disabled"),Es.resolve(Wc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Rr("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Wc):this.Yn(t,e)))}getCacheSize(t){return this.jn.getCacheSize(t)}Yn(t,e){let n,r,s,i,a,u,c;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Rr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,i=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),Nr()<=o.$b.DEBUG&&Rr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-l}ms\n\tDetermined least recently used ${r} in `+(a-i)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${t} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),Es.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}function dl(t,e){return new hl(t,e)}class fl{constructor(t,e){this.db=t,this.garbageCollector=dl(this,e)}Hn(t){const e=this.Zn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Jn(t,e){return this.Xn(t,((t,n)=>e(n)))}addReference(t,e,n){return ml(t,n)}removeReference(t,e,n){return ml(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return ml(t,e)}er(t,e){return function(t,e){let n=!1;return nl(t).Z((r=>Zc(t,r,e).next((t=>(t&&(n=!0),Es.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Xn(t,((i,o)=>{if(o<=e){const e=this.er(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i,ss.min()),al(t).delete(function(t){return[0,Us(t.path)]}(i)))))}));r.push(e)}})).next((()=>Es.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return ml(t,e)}Xn(t,e){const n=al(t);let r,s=Fs._e;return n.Y({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==Fs._e&&e(new cs(Ks(r)),s),s=o,r=i):s=Fs._e})).next((()=>{s!==Fs._e&&e(new cs(Ks(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function ml(t,e){return al(t).put(function(t,e){return{targetId:0,path:Us(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class gl{constructor(){this.changes=new sa((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,ao.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Es.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class pl{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return bl(t).put(n)}removeEntry(t,e,n){return bl(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],sc(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.tr(t,n))))}getEntry(t,e){let n=ao.newInvalidDocument(e);return bl(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Il(e))},((t,r)=>{n=this.nr(e,r)})).next((()=>n))}rr(t,e){let n={size:0,document:ao.newInvalidDocument(e)};return bl(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Il(e))},((t,r)=>{n={document:this.nr(e,r),size:Xc(r)}})).next((()=>n))}getEntries(t,e){let n=oa();return this.ir(t,e,((t,e)=>{const r=this.nr(t,e);n=n.insert(t,r)})).next((()=>n))}sr(t,e){let n=oa(),r=new wi(cs.comparator);return this.ir(t,e,((t,e)=>{const s=this.nr(t,e);n=n.insert(t,s),r=r.insert(t,Xc(e))})).next((()=>({documents:n,_r:r})))}ir(t,e,n){if(e.isEmpty())return Es.resolve();let r=new Ii(Tl);e.forEach((t=>r=r.add(t)));const s=IDBKeyRange.bound(Il(r.first()),Il(r.last())),i=r.getIterator();let o=i.getNext();return bl(t).Y({index:"documentKeyIndex",range:s},((t,e,r)=>{const s=cs.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Tl(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.U(Il(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(t,e,n,r,s){const i=e.path,o=[i.popLast().toArray(),i.lastSegment(),sc(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return bl(t).W(IDBKeyRange.bound(o,a,!0)).next((t=>{null==s||s.incrementDocumentReadCount(t.length);let n=oa();for(const s of t){const t=this.nr(cs.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);t.isFoundDocument()&&(ta(e,t)||r.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,r){let s=oa();const i=_l(e,n),o=_l(e,vs.max());return bl(t).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.nr(cs.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(t){return new wl(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return vl(t).get("remoteDocumentGlobalKey").next((t=>(Or(!!t),t)))}tr(t,e){return vl(t).put("remoteDocumentGlobalKey",e)}nr(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Uu(t.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=cs.fromSegments(e.noDocument.path),r=oc(e.noDocument.readTime);n=ao.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Fr();{const t=cs.fromSegments(e.unknownDocument.path),r=oc(e.unknownDocument.version);n=ao.newUnknownDocument(t,r)}}return e.readTime&&n.setReadTime(function(t){const e=new rs(t[0],t[1]);return ss.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual(ss.min()))return t}return ao.newInvalidDocument(t)}}function yl(t){return new pl(t)}class wl extends gl{constructor(t,e){super(),this.ar=t,this.trackRemovals=e,this.ur=new sa((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new Ii(((t,e)=>ts(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.ur.get(s);if(e.push(this.ar.removeEntry(t,s,o.readTime)),i.isValidDocument()){const a=rc(this.ar.serializer,i);r=r.add(s.path.popLast());const u=Xc(a);n+=u-o.size,e.push(this.ar.addEntry(t,s,a))}else if(n-=o.size,this.trackRemovals){const n=rc(this.ar.serializer,i.convertToNoDocument(ss.min()));e.push(this.ar.addEntry(t,s,n))}})),r.forEach((n=>{e.push(this.ar.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.ar.updateMetadata(t,n)),Es.waitFor(e)}getFromCache(t,e){return this.ar.rr(t,e).next((t=>(this.ur.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.ar.sr(t,e).next((({documents:t,_r:e})=>(e.forEach(((e,n)=>{this.ur.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function vl(t){return mi(t,"remoteDocumentGlobal")}function bl(t){return mi(t,"remoteDocumentsV14")}function Il(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function _l(t,e){const n=e.documentKey.path.toArray();return[t,sc(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Tl(t,e){const n=t.path.toArray(),r=e.path.toArray();let s=0;for(let t=0;t<n.length-2&&t<r.length-2;++t)if(s=ts(n[t],r[t]),s)return s;return s=ts(n.length,r.length),s||(s=ts(n[n.length-2],r[r.length-2]),s||ts(n[n.length-1],r[r.length-1]))}class El{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Sl{constructor(t,e,n,r){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((r=>(n=r,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&Ua(n.mutation,t,Ei.empty(),rs.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,ga()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=ga()){const r=la();return this.populateOverlays(t,r,e).next((()=>this.computeViews(t,e,r,n).next((t=>{let e=ua();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=la();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,ga())))}populateOverlays(t,e,n){const r=[];return n.forEach((t=>{e.has(t)||r.push(t)})),this.documentOverlayCache.getOverlays(t,r).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,r){let s=oa();const i=da(),o=da();return e.forEach(((t,e)=>{const o=n.get(e.key);r.has(e.key)&&(void 0===o||o.mutation instanceof Ga)?s=s.insert(e.key,e):void 0!==o?(i.set(e.key,o.mutation.getFieldMask()),Ua(o.mutation,e,o.mutation.getFieldMask(),rs.now())):i.set(e.key,Ei.empty())})),this.recalculateAndSaveOverlays(t,s).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new El(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=da();let r=new wi(((t,e)=>t-e)),s=ga();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const s of t)s.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||Ei.empty();o=s.applyToLocalView(i,o),n.set(t,o);const a=(r.get(s.batchId)||ga()).add(t);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=ha();u.forEach((t=>{if(!s.has(t)){const r=Va(e.get(t),n.get(t));null!==r&&c.set(t,r),s=s.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return Es.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n,r){return function(t){return cs.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):jo(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,r):this.getDocumentsMatchingCollectionQuery(t,e,n,r)}getNextDocuments(t,e,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,r-s.size):Es.resolve(la());let o=-1,a=s;return i.next((e=>Es.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(e)?Es.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,s))).next((()=>this.computeViews(t,a,e,ga()))).next((t=>({batchId:o,changes:ca(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new cs(e)).next((t=>{let e=ua();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n,r){const s=e.collectionGroup;let i=ua();return this.indexManager.getCollectionParents(t,s).next((o=>Es.forEach(o,(o=>{const a=function(t,e){return new Bo(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,o.child(s));return this.getDocumentsMatchingCollectionQuery(t,a,n,r).next((t=>{t.forEach(((t,e)=>{i=i.insert(t,e)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(t,e,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,r)))).next((t=>{s.forEach(((e,n)=>{const r=n.getKey();null===t.get(r)&&(t=t.insert(r,ao.newInvalidDocument(r)))}));let n=ua();return t.forEach(((t,r)=>{const i=s.get(t);void 0!==i&&Ua(i.mutation,r,Ei.empty(),rs.now()),ta(e,r)&&(n=n.insert(t,r))})),n}))}}class xl{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return Es.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(t){return{id:t.id,version:t.version,createTime:Au(t.createTime)}}(e)),Es.resolve()}getNamedQuery(t,e){return Es.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(t){return{name:t.name,query:lc(t.bundledQuery),readTime:Au(t.readTime)}}(e)),Es.resolve()}}class Cl{constructor(){this.overlays=new wi(cs.comparator),this.hr=new Map}getOverlay(t,e){return Es.resolve(this.overlays.get(e))}getOverlays(t,e){const n=la();return Es.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,r)=>{this.ht(t,e,r)})),Es.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((t=>this.overlays=this.overlays.remove(t))),this.hr.delete(n)),Es.resolve()}getOverlaysForCollection(t,e,n){const r=la(),s=e.length+1,i=new cs(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===s&&t.largestBatchId>n&&r.set(t.getKey(),t)}return Es.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new wi(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=la(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=la(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=r)););return Es.resolve(o)}ht(t,e,n){const r=this.overlays.get(n.key);if(null!==r){const t=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Ja(e,n));let s=this.hr.get(e);void 0===s&&(s=ga(),this.hr.set(e,s)),this.hr.set(e,s.add(n.key))}}class Dl{constructor(){this.Pr=new Ii(Al.Ir),this.Tr=new Ii(Al.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){const n=new Al(t,e);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.Ar(new Al(t,e))}Rr(t,e){t.forEach((t=>this.removeReference(t,e)))}Vr(t){const e=new cs(new os([])),n=new Al(e,t),r=new Al(e,t+1),s=[];return this.Tr.forEachInRange([n,r],(t=>{this.Ar(t),s.push(t.key)})),s}mr(){this.Pr.forEach((t=>this.Ar(t)))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){const e=new cs(new os([])),n=new Al(e,t),r=new Al(e,t+1);let s=ga();return this.Tr.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Al(t,0),n=this.Pr.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Al{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return cs.comparator(t.key,e.key)||ts(t.pr,e.pr)}static Er(t,e){return ts(t.pr,e.pr)||cs.comparator(t.key,e.key)}}class Nl{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new Ii(Al.Ir)}checkEmpty(t){return Es.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,r){const s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Ya(s,e,n,r);this.mutationQueue.push(i);for(const e of r)this.wr=this.wr.add(new Al(e.key,s)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return Es.resolve(i)}lookupMutationBatch(t,e){return Es.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.br(n),s=r<0?0:r;return Es.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return Es.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(t){return Es.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Al(e,0),r=new Al(e,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([n,r],(t=>{const e=this.Sr(t.pr);s.push(e)})),Es.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ii(ts);return e.forEach((t=>{const e=new Al(t,0),r=new Al(t,Number.POSITIVE_INFINITY);this.wr.forEachInRange([e,r],(t=>{n=n.add(t.pr)}))})),Es.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;cs.isDocumentKey(s)||(s=s.child(""));const i=new Al(new cs(s),0);let o=new Ii(ts);return this.wr.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.pr)),!0)}),i),Es.resolve(this.Dr(o))}Dr(t){const e=[];return t.forEach((t=>{const n=this.Sr(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Or(0===this.Cr(e.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return Es.forEach(e.mutations,(r=>{const s=new Al(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.wr=n}))}Mn(t){}containsKey(t,e){const n=new Al(e,0),r=this.wr.firstAfterOrEqual(n);return Es.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.mutationQueue.length,Es.resolve()}Cr(t,e){return this.br(t)}br(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}Sr(t){const e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class kl{constructor(t){this.vr=t,this.docs=new wi(cs.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),s=r?r.size:0,i=this.vr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Es.resolve(n?n.document.mutableCopy():ao.newInvalidDocument(e))}getEntries(t,e){let n=oa();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():ao.newInvalidDocument(t))})),Es.resolve(n)}getDocumentsMatchingQuery(t,e,n,r){let s=oa();const i=e.path,o=new cs(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:t,value:{document:o}}=a.getNext();if(!i.isPrefixOf(t.path))break;t.path.length>i.length+1||bs(ws(o),n)<=0||(r.has(o.key)||ta(e,o))&&(s=s.insert(o.key,o.mutableCopy()))}return Es.resolve(s)}getAllFromCollectionGroup(t,e,n,r){Fr()}Fr(t,e){return Es.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Rl(this)}getSize(t){return Es.resolve(this.size)}}class Rl extends gl{constructor(t){super(),this.ar=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?e.push(this.ar.addEntry(t,r)):this.ar.removeEntry(n)})),Es.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}}class Ml{constructor(t){this.persistence=t,this.Mr=new sa((t=>Lo(t)),Fo),this.lastRemoteSnapshotVersion=ss.min(),this.highestTargetId=0,this.Or=0,this.Nr=new Dl,this.targetCount=0,this.Br=rl.Nn()}forEachTarget(t,e){return this.Mr.forEach(((t,n)=>e(n))),Es.resolve()}getLastRemoteSnapshotVersion(t){return Es.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Es.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Br.next(),Es.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Or&&(this.Or=e),Es.resolve()}qn(t){this.Mr.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Br=new rl(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,Es.resolve()}updateTargetData(t,e){return this.qn(e),Es.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,Es.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Mr.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Mr.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),Es.waitFor(s).next((()=>r))}getTargetCount(t){return Es.resolve(this.targetCount)}getTargetData(t,e){const n=this.Mr.get(e)||null;return Es.resolve(n)}addMatchingKeys(t,e,n){return this.Nr.dr(e,n),Es.resolve()}removeMatchingKeys(t,e,n){this.Nr.Rr(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),Es.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),Es.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Nr.gr(e);return Es.resolve(n)}containsKey(t,e){return Es.resolve(this.Nr.containsKey(e))}}class Pl{constructor(t,e){this.Lr={},this.overlays={},this.kr=new Fs(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new Ml(this),this.indexManager=new qc,this.remoteDocumentCache=function(t){return new kl(t)}((t=>this.referenceDelegate.Kr(t))),this.serializer=new nc(e),this.$r=new xl(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Cl,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Lr[t.toKey()];return n||(n=new Nl(e,this.referenceDelegate),this.Lr[t.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,n){Rr("MemoryPersistence","Starting transaction:",t);const r=new Ll(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((t=>this.referenceDelegate.Wr(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Gr(t,e){return Es.or(Object.values(this.Lr).map((n=>()=>n.containsKey(t,e))))}}class Ll extends _s{constructor(t){super(),this.currentSequenceNumber=t}}class Fl{constructor(t){this.persistence=t,this.zr=new Dl,this.jr=null}static Hr(t){return new Fl(t)}get Jr(){if(this.jr)return this.jr;throw Fr()}addReference(t,e,n){return this.zr.addReference(n,e),this.Jr.delete(n.toString()),Es.resolve()}removeReference(t,e,n){return this.zr.removeReference(n,e),this.Jr.add(n.toString()),Es.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),Es.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach((t=>this.Jr.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Jr.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Ur(){this.jr=new Set}Wr(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Es.forEach(this.Jr,(n=>{const r=cs.fromPath(n);return this.Yr(t,r).next((t=>{t||e.removeEntry(r,ss.min())}))})).next((()=>(this.jr=null,e.apply(t))))}updateLimboDocument(t,e){return this.Yr(t,e).next((t=>{t?this.Jr.delete(e.toString()):this.Jr.add(e.toString())}))}Kr(t){return 0}Yr(t,e){return Es.or([()=>Es.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}}class Ol{constructor(t,e){this.persistence=t,this.Zr=new sa((t=>Us(t.path)),((t,e)=>t.isEqual(e))),this.garbageCollector=dl(this,e)}static Hr(t,e){return new Ol(t,e)}Ur(){}Wr(t){return Es.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}Hn(t){const e=this.Zn(t);return this.persistence.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}Jn(t,e){return Es.forEach(this.Zr,((n,r)=>this.er(t,n,r).next((t=>t?Es.resolve():e(r)))))}removeTargets(t,e,n){return this.persistence.getTargetCache().removeTargets(t,e,n)}removeOrphanedDocuments(t,e){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Fr(t,(r=>this.er(t,r,e).next((t=>{t||(n++,s.removeEntry(r,ss.min()))})))).next((()=>s.apply(t))).next((()=>n))}markPotentiallyOrphaned(t,e){return this.Zr.set(e,t.currentSequenceNumber),Es.resolve()}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,n)}addReference(t,e,n){return this.Zr.set(n,t.currentSequenceNumber),Es.resolve()}removeReference(t,e,n){return this.Zr.set(n,t.currentSequenceNumber),Es.resolve()}updateLimboDocument(t,e){return this.Zr.set(e,t.currentSequenceNumber),Es.resolve()}Kr(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=$i(t.data.value)),e}er(t,e,n){return Es.or([()=>this.persistence.Gr(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const t=this.Zr.get(e);return Es.resolve(void 0!==t&&t>n)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}class Vl{constructor(t){this.serializer=t}N(t,e,n,r){const s=new Ss("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Gs,{unique:!0}),t.createObjectStore("documentMutations")}(t),ql(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=Es.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),ql(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ss.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Gs,{unique:!0});const r=e.store("mutations"),s=n.map((t=>r.put(t)));return Es.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.Xr(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.ei(s))))),n<7&&r>=7&&(i=i.next((()=>this.ti(s)))),n<8&&r>=8&&(i=i.next((()=>this.ni(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&r>=10&&(i=i.next((()=>this.ri(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&r>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:ii});e.createIndex("collectionPathOverlayIndex",oi,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",ai,{unique:!1})}(t)}))),n<13&&r>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Ws});e.createIndex("documentKeyIndex",Hs),e.createIndex("collectionGroupIndex",Ys)}(t))).next((()=>this.ii(t,s))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(t,s)))),n<15&&r>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:ei}).createIndex("sequenceNumberIndex",ni,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:ri}).createIndex("documentKeyIndex",si,{unique:!1})}(t)))),i}ei(t){let e=0;return t.store("remoteDocuments").Y(((t,n)=>{e+=Xc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>Es.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>Es.forEach(n,(n=>{Or(n.userId===e.userId);const r=ac(this.serializer,n);return Yc(t,e.userId,r).next((()=>{}))}))))}))))}ti(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const r=[];return n.Y(((n,s)=>{const i=new os(n),o=function(t){return[0,Us(t)]}(i);r.push(e.get(o).next((n=>n?Es.resolve():(n=>e.put({targetId:0,path:Us(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>Es.waitFor(r)))}))}ni(t,e){t.createObjectStore("collectionParents",{keyPath:ti});const n=e.store("collectionParents"),r=new Uc,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Us(r)})}};return e.store("remoteDocuments").Y({J:!0},((t,e)=>{const n=new os(t);return s(n.popLast())})).next((()=>e.store("documentMutations").Y({J:!0},(([t,e,n],r)=>{const i=Ks(e);return s(i.popLast())}))))}ri(t){const e=t.store("targets");return e.Y(((t,n)=>{const r=uc(n),s=cc(this.serializer,r);return e.put(s)}))}ii(t,e){const n=e.store("remoteDocuments"),r=[];return n.Y(((t,n)=>{const s=e.store("remoteDocumentsV14"),i=function(t){return t.document?new cs(os.fromString(t.document.name).popFirst(5)):t.noDocument?cs.fromSegments(t.noDocument.path):t.unknownDocument?cs.fromSegments(t.unknownDocument.path):Fr()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>Es.waitFor(r)))}si(t,e){const n=e.store("mutations"),r=yl(this.serializer),s=new Pl(Fl.Hr,this.serializer.ct);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let r=null!==(e=n.get(t.userId))&&void 0!==e?e:ga();ac(this.serializer,t).keys().forEach((t=>r=r.add(t))),n.set(t.userId,r)})),Es.forEach(n,((t,n)=>{const i=new Cr(n),o=yc.lt(this.serializer,i),a=s.getIndexManager(i),u=Jc.lt(i,this.serializer,a,s.referenceDelegate);return new Sl(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new fi(e,Fs._e),t).next()}))}))}}function ql(t){t.createObjectStore("targetDocuments",{keyPath:Js}).createIndex("documentTargetsIndex",Zs,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Xs,{unique:!0}),t.createObjectStore("targetGlobal")}const Ul="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Bl{constructor(t,e,n,r,s,i,o,a,u,c,l=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.oi=s,this.window=i,this.document=o,this._i=u,this.ai=c,this.ui=l,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=t=>Promise.resolve(),!Bl.D())throw new Br(Ur.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new fl(this,r),this.Ti=e+"main",this.serializer=new nc(a),this.Ei=new xs(this.Ti,this.ui,new Vl(this.serializer)),this.Qr=new sl(this.referenceDelegate,this.serializer),this.remoteDocumentCache=yl(this.serializer),this.$r=new mc,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===c&&Mr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Br(Ur.FAILED_PRECONDITION,Ul);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Qr.getHighestSequenceNumber(t)))})).then((t=>{this.kr=new Fs(t,this._i)})).then((()=>{this.qr=!0})).catch((t=>(this.Ei&&this.Ei.close(),Promise.reject(t))))}fi(t){return this.Ii=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.L((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Kl(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(t).next((t=>{t||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(t))).next((e=>this.isPrimary&&!e?this.yi(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(As(t))return Rr("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Rr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.oi.enqueueRetryable((()=>this.Ii(t))),this.isPrimary=t}))}gi(t){return zl(t).get("owner").next((t=>Es.resolve(this.Si(t))))}bi(t){return Kl(t).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=mi(t,"clientMetadata");return e.W().next((t=>{const n=this.vi(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return Es.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const e of t)this.di.removeItem(this.Fi(e.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(t){return!!t&&t.ownerId===this.clientId}pi(t){return this.ai?Es.resolve(!0):zl(t).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)){if(this.Si(e)&&this.networkEnabled)return!0;if(!this.Si(e)){if(!e.allowTabSynchronization)throw new Br(Ur.FAILED_PRECONDITION,Ul);return!1}}return!(!this.networkEnabled||!this.inForeground)||Kl(t).W().next((t=>void 0===this.vi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Rr("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new fi(t,Fs._e);return this.yi(e).next((()=>this.bi(e)))})),this.Ei.close(),this.Bi()}vi(t,e){return t.filter((t=>this.Ci(t.updateTimeMs,e)&&!this.Mi(t.clientId)))}Li(){return this.runTransaction("getActiveClients","readonly",(t=>Kl(t).W().next((t=>this.vi(t,18e5).map((t=>t.clientId))))))}get started(){return this.qr}getMutationQueue(t,e){return Jc.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new zc(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return yc.lt(this.serializer,t)}getBundleCache(){return this.$r}runTransaction(t,e,n){Rr("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite",s=function(t){return 15===t?di:14===t?hi:13===t?li:12===t?ci:11===t?ui:void Fr()}(this.ui);let i;return this.Ei.runTransaction(t,r,s,(r=>(i=new fi(r,this.kr?this.kr.next():Fs._e),"readwrite-primary"===e?this.gi(i).next((t=>!!t||this.pi(i))).next((e=>{if(!e)throw Mr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new Br(Ur.FAILED_PRECONDITION,Is);return n(i)})).next((t=>this.wi(i).next((()=>t)))):this.ki(i).next((()=>n(i)))))).then((t=>(i.raiseOnCommittedEvent(),t)))}ki(t){return zl(t).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)&&!this.Si(t)&&!(this.ai||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Br(Ur.FAILED_PRECONDITION,Ul)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return zl(t).put("owner",e)}static D(){return xs.D()}yi(t){const e=zl(t);return e.get("owner").next((t=>this.Si(t)?(Rr("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):Es.resolve()))}Ci(t,e){const n=Date.now();return!(t<n-e||t>n&&(Mr(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.ci=()=>{this.xi();const t=/(?:Version|Mobile)\/1[456]/;(0,a.nr)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(t){var e;try{const n=null!==(null===(e=this.di)||void 0===e?void 0:e.getItem(this.Fi(t)));return Rr("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Mr("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(t){Mr("Failed to set zombie client id.",t)}}Bi(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(t){}}Fi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function zl(t){return mi(t,"owner")}function Kl(t){return mi(t,"clientMetadata")}function Gl(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class jl{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.qi=n,this.Qi=r}static Ki(t,e){let n=ga(),r=ga();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new jl(t,e.fromCache,n,r)}}class $l{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}class Ql{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=(0,a.nr)()?8:xs.v((0,a.ZQ)())>0?6:4}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,n,r){const s={result:null};return this.ji(t,e).next((t=>{s.result=t})).next((()=>{if(!s.result)return this.Hi(t,e,r,n).next((t=>{s.result=t}))})).next((()=>{if(s.result)return;const n=new $l;return this.Ji(t,e,n).next((r=>{if(s.result=r,this.Ui)return this.Yi(t,e,n,r.size)}))})).next((()=>s.result))}Yi(t,e,n,r){return n.documentReadCount<this.Wi?(Nr()<=o.$b.DEBUG&&Rr("QueryEngine","SDK will not create cache indexes for query:",Zo(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),Es.resolve()):(Nr()<=o.$b.DEBUG&&Rr("QueryEngine","Query:",Zo(e),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(Nr()<=o.$b.DEBUG&&Rr("QueryEngine","The SDK decides to create cache indexes for query:",Zo(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Qo(e))):Es.resolve())}ji(t,e){if(Go(e))return Es.resolve(null);let n=Qo(e);return this.indexManager.getIndexType(t,n).next((r=>0===r?null:(null!==e.limit&&1===r&&(e=Yo(e,null,"F"),n=Qo(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((r=>{const s=ga(...r);return this.zi.getDocuments(t,s).next((r=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.Zi(e,r);return this.Xi(e,i,s,n.readTime)?this.ji(t,Yo(e,null,"F")):this.es(t,i,e,n)}))))})))))}Hi(t,e,n,r){return Go(e)||r.isEqual(ss.min())?Es.resolve(null):this.zi.getDocuments(t,n).next((s=>{const i=this.Zi(e,s);return this.Xi(e,i,n,r)?Es.resolve(null):(Nr()<=o.$b.DEBUG&&Rr("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Zo(e)),this.es(t,i,e,ys(r,-1)).next((t=>t)))}))}Zi(t,e){let n=new Ii(na(t));return e.forEach(((e,r)=>{ta(t,r)&&(n=n.add(r))})),n}Xi(t,e,n,r){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const s="F"===t.limitType?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ji(t,e,n){return Nr()<=o.$b.DEBUG&&Rr("QueryEngine","Using full collection scan to execute query:",Zo(e)),this.zi.getDocumentsMatchingQuery(t,e,vs.min(),n)}es(t,e,n,r){return this.zi.getDocumentsMatchingQuery(t,n,r).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class Wl{constructor(t,e,n,r){this.persistence=t,this.ts=e,this.serializer=r,this.ns=new wi(ts),this.rs=new sa((t=>Lo(t)),Fo),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(n)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Sl(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.ns)))}}function Hl(t,e,n,r){return new Wl(t,e,n,r)}async function Yl(t,e){const n=qr(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let r;return n.mutationQueue.getAllMutationBatches(t).next((s=>(r=s,n._s(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const s=[],i=[];let o=ga();for(const t of r){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({us:t,removedBatchIds:s,addedBatchIds:i})))}))}))}function Xl(t){const e=qr(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Qr.getLastRemoteSnapshotVersion(t)))}function Jl(t,e,n){let r=ga(),s=ga();return n.forEach((t=>r=r.add(t))),e.getEntries(t,r).next((t=>{let r=oa();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(ss.min())?(e.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),r=r.insert(n,i)):Rr("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{cs:r,ls:s}}))}function Zl(t,e){const n=qr(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function th(t,e){const n=qr(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.Qr.getTargetData(t,e).next((s=>s?(r=s,Es.resolve(r)):n.Qr.allocateTargetId(t).next((s=>(r=new ec(e,s,"TargetPurposeListen",t.currentSequenceNumber),n.Qr.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.ns.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(t.targetId,t),n.rs.set(e,t.targetId)),t}))}async function eh(t,e,n){const r=qr(t),s=r.ns.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!As(t))throw t;Rr("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.ns=r.ns.remove(e),r.rs.delete(s.target)}function nh(t,e,n){const r=qr(t);let s=ss.min(),i=ga();return r.persistence.runTransaction("Execute query","readwrite",(t=>function(t,e,n){const r=qr(t),s=r.rs.get(n);return void 0!==s?Es.resolve(r.ns.get(s)):r.Qr.getTargetData(e,n)}(r,t,Qo(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.ts.getDocumentsMatchingQuery(t,e,n?s:ss.min(),n?i:ga()))).next((t=>(ih(r,ea(e),t),{documents:t,hs:i})))))}function rh(t,e){const n=qr(t),r=qr(n.Qr),s=n.ns.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r._t(t,e).next((t=>t?t.target:null))))}function sh(t,e){const n=qr(t),r=n.ss.get(e)||ss.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.os.getAllFromCollectionGroup(t,e,ys(r,-1),Number.MAX_SAFE_INTEGER))).then((t=>(ih(n,e,t),t)))}function ih(t,e,n){let r=t.ss.get(e)||ss.min();n.forEach(((t,e)=>{e.readTime.compareTo(r)>0&&(r=e.readTime)})),t.ss.set(e,r)}async function oh(t,e,n=ga()){const r=await th(t,Qo(lc(e.bundledQuery))),s=qr(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Au(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.$r.saveNamedQuery(t,e);const o=r.withResumeToken(Ci.EMPTY_BYTE_STRING,i);return s.ns=s.ns.insert(o.targetId,o),s.Qr.updateTargetData(t,o).next((()=>s.Qr.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.Qr.addMatchingKeys(t,n,r.targetId))).next((()=>s.$r.saveNamedQuery(t,e)))}))}function ah(t,e){return`firestore_clients_${t}_${e}`}function uh(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function ch(t,e){return`firestore_targets_${t}_${e}`}class lh{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Es(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Br(r.error.code,r.error.message))),i?new lh(t,e,r.state,s):(Mr("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class hh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Es(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Br(n.error.code,n.error.message))),s?new hh(t,n.state,r):(Mr("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class dh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Es(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=ya();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=qs(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new dh(t,s):(Mr("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class fh{constructor(t,e){this.clientId=t,this.onlineState=e}static Es(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new fh(e.clientId,e.onlineState):(Mr("SharedClientState",`Failed to parse online state: ${t}`),null)}}class mh{constructor(){this.activeTargetIds=ya()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class gh{constructor(t,e,n,r,s){this.window=t,this.oi=e,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new wi(ts),this.started=!1,this.ys=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=ah(this.persistenceKey,this.Vs),this.Ss=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new mh),this.bs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Fs=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Li();for(const e of t){if(e===this.Vs)continue;const t=this.getItem(ah(this.persistenceKey,e));if(t){const n=dh.Es(e,t);n&&(this.ps=this.ps.insert(n.clientId,n))}}this.Ms();const e=this.storage.getItem(this.vs);if(e){const t=this.xs(e);t&&this.Os(t)}for(const t of this.ys)this.gs(t);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ss,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(t){let e=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Bs(t,"pending")}updateMutationState(t,e,n){this.Bs(t,e,n),this.Ls(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(ch(this.persistenceKey,t));if(n){const r=hh.Es(t,n);r&&(e=r.state)}}return this.ks.As(t),this.Ms(),e}removeLocalQueryTarget(t){this.ks.Rs(t),this.Ms()}isLocalQueryTarget(t){return this.ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(ch(this.persistenceKey,t))}updateQueryState(t,e,n){this.qs(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Ls(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Qs(t)}notifyBundleLoaded(t){this.Ks(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Rr("SharedClientState","READ",t,e),e}setItem(t,e){Rr("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Rr("SharedClientState","REMOVE",t),this.storage.removeItem(t)}gs(t){const e=t;if(e.storageArea===this.storage){if(Rr("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ws)return void Mr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.bs.test(e.key)){if(null==e.newValue){const t=this.$s(e.key);return this.Us(t,null)}{const t=this.Ws(e.key,e.newValue);if(t)return this.Us(t.clientId,t)}}else if(this.Ds.test(e.key)){if(null!==e.newValue){const t=this.Gs(e.key,e.newValue);if(t)return this.zs(t)}}else if(this.Cs.test(e.key)){if(null!==e.newValue){const t=this.js(e.key,e.newValue);if(t)return this.Hs(t)}}else if(e.key===this.vs){if(null!==e.newValue){const t=this.xs(e.newValue);if(t)return this.Os(t)}}else if(e.key===this.Ss){const t=function(t){let e=Fs._e;if(null!=t)try{const n=JSON.parse(t);Or("number"==typeof n),e=n}catch(t){Mr("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Fs._e&&this.sequenceNumberHandler(t)}else if(e.key===this.Fs){const t=this.Js(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Ys(t))))}}else this.ys.push(e)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Bs(t,e,n){const r=new lh(this.currentUser,t,e,n),s=uh(this.persistenceKey,this.currentUser,t);this.setItem(s,r.ds())}Ls(t){const e=uh(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Qs(t){const e={clientId:this.Vs,onlineState:t};this.storage.setItem(this.vs,JSON.stringify(e))}qs(t,e,n){const r=ch(this.persistenceKey,t),s=new hh(t,e,n);this.setItem(r,s.ds())}Ks(t){const e=JSON.stringify(Array.from(t));this.setItem(this.Fs,e)}$s(t){const e=this.bs.exec(t);return e?e[1]:null}Ws(t,e){const n=this.$s(t);return dh.Es(n,e)}Gs(t,e){const n=this.Ds.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return lh.Es(new Cr(s),r,e)}js(t,e){const n=this.Cs.exec(t),r=Number(n[1]);return hh.Es(r,e)}xs(t){return fh.Es(t)}Js(t){return JSON.parse(t)}async zs(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Zs(t.batchId,t.state,t.error);Rr("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Hs(t){return this.syncEngine.Xs(t.targetId,t.state,t.error)}Us(t,e){const n=e?this.ps.insert(t,e):this.ps.remove(t),r=this.Ns(this.ps),s=this.Ns(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.eo(i,o).then((()=>{this.ps=n}))}Os(t){this.ps.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ns(t){let e=ya();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class ph{constructor(){this.no=new mh,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,n){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new mh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class yh{io(t){}shutdown(){}}class wh{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){Rr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.uo)t(0)}ao(){Rr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.uo)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let vh=null;function bh(){return null===vh?vh=268435456+Math.round(2147483648*Math.random()):vh++,"0x"+vh.toString(16)}const Ih={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class _h{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}onMessage(t){this.Ao=t}close(){this.ho()}send(t){this.lo(t)}Ro(){this.Io()}Vo(t){this.Eo(t)}mo(t){this.Ao(t)}}const Th="WebChannelConnection";class Eh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.fo=e+"://"+t.host,this.po=`projects/${n}/databases/${r}`,this.yo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get wo(){return!1}So(t,e,n,r,s){const i=bh(),o=this.bo(t,e.toUriEncodedString());Rr("RestConnection",`Sending RPC '${t}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(a,r,s),this.Co(t,o,a,n).then((e=>(Rr("RestConnection",`Received RPC '${t}' ${i}: `,e),e)),(e=>{throw Pr("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",o,"request:",n),e}))}vo(t,e,n,r,s,i){return this.So(t,e,n,r,s)}Do(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+Dr,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}bo(t,e){const n=Ih[t];return`${this.fo}/v1/${e}:${n}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Co(t,e,n,r){const s=bh();return new Promise(((i,o)=>{const a=new Tr;a.setWithCredentials(!0),a.listenOnce(vr.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case wr.NO_ERROR:const e=a.getResponseJson();Rr(Th,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(e)),i(e);break;case wr.TIMEOUT:Rr(Th,`RPC '${t}' ${s} timed out`),o(new Br(Ur.DEADLINE_EXCEEDED,"Request time out"));break;case wr.HTTP_ERROR:const n=a.getStatus();if(Rr(Th,`RPC '${t}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let t=a.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Ur).indexOf(e)>=0?e:Ur.UNKNOWN}(e.status);o(new Br(t,e.message))}else o(new Br(Ur.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new Br(Ur.UNAVAILABLE,"Connection failed."));break;default:Fr()}}finally{Rr(Th,`RPC '${t}' ${s} completed.`)}}));const u=JSON.stringify(r);Rr(Th,`RPC '${t}' ${s} sending request:`,r),a.send(e,"POST",u,n,15)}))}Fo(t,e,n){const r=bh(),s=[this.fo,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=pr(),o=yr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Do(a.initMessageHeaders,e,n),a.encodeInitMessageHeaders=!0;const c=s.join("");Rr(Th,`Creating RPC '${t}' stream ${r}: ${c}`,a);const l=i.createWebChannel(c,a);let h=!1,d=!1;const f=new _h({lo:e=>{d?Rr(Th,`Not sending because RPC '${t}' stream ${r} is closed:`,e):(h||(Rr(Th,`Opening RPC '${t}' stream ${r} transport.`),l.open(),h=!0),Rr(Th,`RPC '${t}' stream ${r} sending:`,e),l.send(e))},ho:()=>l.close()}),m=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return m(l,_r.EventType.OPEN,(()=>{d||Rr(Th,`RPC '${t}' stream ${r} transport opened.`)})),m(l,_r.EventType.CLOSE,(()=>{d||(d=!0,Rr(Th,`RPC '${t}' stream ${r} transport closed`),f.Vo())})),m(l,_r.EventType.ERROR,(e=>{d||(d=!0,Pr(Th,`RPC '${t}' stream ${r} transport errored:`,e),f.Vo(new Br(Ur.UNAVAILABLE,"The operation could not be completed")))})),m(l,_r.EventType.MESSAGE,(e=>{var n;if(!d){const s=e.data[0];Or(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){Rr(Th,`RPC '${t}' stream ${r} received error:`,o);const e=o.status;let n=function(t){const e=eu[t];if(void 0!==e)return su(e)}(e),s=o.message;void 0===n&&(n=Ur.INTERNAL,s="Unknown error status: "+e+" with message "+o.message),d=!0,f.Vo(new Br(n,s)),l.close()}else Rr(Th,`RPC '${t}' stream ${r} received:`,s),f.mo(s)}})),m(o,br.STAT_EVENT,(e=>{e.stat===Ir.PROXY?Rr(Th,`RPC '${t}' stream ${r} detected buffering proxy`):e.stat===Ir.NOPROXY&&Rr(Th,`RPC '${t}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{f.Ro()}),0),f}}function Sh(){return"undefined"!=typeof window?window:null}function xh(){return"undefined"!=typeof document?document:null}function Ch(t){return new Eu(t,!0)}class Dh{constructor(t,e,n=1e3,r=1.5,s=6e4){this.oi=t,this.timerId=e,this.Mo=n,this.xo=r,this.Oo=s,this.No=0,this.Bo=null,this.Lo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(t){this.cancel();const e=Math.floor(this.No+this.Qo()),n=Math.max(0,Date.now()-this.Lo),r=Math.max(0,e-n);r>0&&Rr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.No} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Bo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Lo=Date.now(),t()))),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){null!==this.Bo&&(this.Bo.skipDelay(),this.Bo=null)}cancel(){null!==this.Bo&&(this.Bo.cancel(),this.Bo=null)}Qo(){return(Math.random()-.5)*this.No}}class Ah{constructor(t,e,n,r,s,i,o,a){this.oi=t,this.$o=n,this.Uo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new Dh(t,e)}Ho(){return 1===this.state||5===this.state||this.Jo()}Jo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Yo()}async stop(){this.Ho()&&await this.close(0)}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&null===this.Go&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,(()=>this.e_())))}t_(t){this.n_(),this.stream.send(t)}async e_(){if(this.Jo())return this.close(0)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}async close(t,e){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,4!==t?this.jo.reset():e&&e.code===Ur.RESOURCE_EXHAUSTED?(Mr(e.toString()),Mr("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):e&&e.code===Ur.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.i_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.To(e)}i_(){}auth(){this.state=1;const t=this.s_(this.Wo),e=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Wo===e&&this.o_(t,n)}),(e=>{t((()=>{const t=new Br(Ur.UNKNOWN,"Fetching auth token failed: "+e.message);return this.__(t)}))}))}o_(t,e){const n=this.s_(this.Wo);this.stream=this.a_(t,e),this.stream.Po((()=>{n((()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,(()=>(this.Jo()&&(this.state=3),Promise.resolve()))),this.listener.Po())))})),this.stream.To((t=>{n((()=>this.__(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Yo(){this.state=5,this.jo.qo((async()=>{this.state=0,this.start()}))}__(t){return Rr("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}s_(t){return e=>{this.oi.enqueueAndForget((()=>this.Wo===t?e():(Rr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Nh extends Ah{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s}a_(t,e){return this.connection.Fo("Listen",t,e)}onMessage(t){this.jo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Fr()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.useProto3Json?(Or(void 0===e||"string"==typeof e),Ci.fromBase64String(e||"")):(Or(void 0===e||e instanceof Uint8Array),Ci.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Ur.UNKNOWN:su(t.code);return new Br(e,t.message||"")}(o);n=new pu(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Pu(t,r.document.name),i=Au(r.document.updateTime),o=r.document.createTime?Au(r.document.createTime):ss.min(),a=new io({mapValue:{fields:r.document.fields}}),u=ao.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new mu(c,l,u.key,u)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Pu(t,r.document),i=r.readTime?Au(r.readTime):ss.min(),o=ao.newNoDocument(s,i),a=r.removedTargetIds||[];n=new mu([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Pu(t,r.document),i=r.removedTargetIds||[];n=new mu([],i,s,null)}else{if(!("filter"in e))return Fr();{e.filter;const t=e.filter;t.targetId;const{count:r=0,unchangedNames:s}=t,i=new tu(r,s),o=t.targetId;n=new gu(o,i)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return ss.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?ss.min():e.readTime?Au(e.readTime):ss.min()}(t);return this.listener.u_(e,n)}c_(t){const e={};e.database=Ou(this.serializer),e.addTarget=function(t,e){let n;const r=e.target;if(n=Oo(r)?{documents:Ku(t,r)}:{query:Gu(t,r).ut},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0){n.resumeToken=Cu(t,e.resumeToken);const r=Su(t,e.expectedCount);null!==r&&(n.expectedCount=r)}else if(e.snapshotVersion.compareTo(ss.min())>0){n.readTime=xu(t,e.snapshotVersion.toTimestamp());const r=Su(t,e.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,t);const n=function(t,e){const n=function(t){switch(t){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Fr()}}(e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.t_(e)}l_(t){const e={};e.database=Ou(this.serializer),e.removeTarget=t,this.t_(e)}}class kh extends Ah{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(t,e){return this.connection.Fo("Write",t,e)}onMessage(t){if(Or(!!t.streamToken),this.lastStreamToken=t.streamToken,this.h_){this.jo.reset();const e=function(t,e){return t&&t.length>0?(Or(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Au(t.updateTime):Au(e);return n.isEqual(ss.min())&&(n=Au(e)),new Pa(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Au(t.commitTime);return this.listener.T_(n,e)}return Or(!t.writeResults||0===t.writeResults.length),this.h_=!0,this.listener.E_()}d_(){const t={};t.database=Ou(this.serializer),this.t_(t)}I_(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Bu(this.serializer,t)))};this.t_(e)}}class Rh extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=r,this.A_=!1}R_(){if(this.A_)throw new Br(Ur.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,n,r){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.So(t,ku(e,n),r,s,i))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Ur.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Br(Ur.UNKNOWN,t.toString())}))}vo(t,e,n,r,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.vo(t,ku(e,n),r,i,o,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Ur.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Br(Ur.UNKNOWN,t.toString())}))}terminate(){this.A_=!0,this.connection.terminate()}}class Mh{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){0===this.m_&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve()))))}S_(t){"Online"===this.state?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.y_("Offline")))}set(t){this.b_(),this.m_=0,"Online"===t&&(this.g_=!1),this.y_(t)}y_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}w_(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(Mr(e),this.g_=!1):Rr("OnlineStateTracker",e)}b_(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}}class Ph{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=s,this.M_.io((t=>{n.enqueueAndForget((async()=>{Kh(this)&&(Rr("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=qr(t);e.v_.add(4),await Fh(e),e.x_.set("Unknown"),e.v_.delete(4),await Lh(e)}(this))}))})),this.x_=new Mh(n,r)}}async function Lh(t){if(Kh(t))for(const e of t.F_)await e(!0)}async function Fh(t){for(const e of t.F_)await e(!1)}function Oh(t,e){const n=qr(t);n.C_.has(e.targetId)||(n.C_.set(e.targetId,e),zh(n)?Bh(n):ad(n).Jo()&&qh(n,e))}function Vh(t,e){const n=qr(t),r=ad(n);n.C_.delete(e),r.Jo()&&Uh(n,e),0===n.C_.size&&(r.Jo()?r.Xo():Kh(n)&&n.x_.set("Unknown"))}function qh(t,e){if(t.O_.Oe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(ss.min())>0){const n=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(n)}ad(t).c_(e)}function Uh(t,e){t.O_.Oe(e),ad(t).l_(e)}function Bh(t){t.O_=new wu({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.C_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),ad(t).start(),t.x_.p_()}function zh(t){return Kh(t)&&!ad(t).Ho()&&t.C_.size>0}function Kh(t){return 0===qr(t).v_.size}function Gh(t){t.O_=void 0}async function jh(t){t.C_.forEach(((e,n)=>{qh(t,e)}))}async function $h(t,e){Gh(t),zh(t)?(t.x_.S_(e),Bh(t)):t.x_.set("Unknown")}async function Qh(t,e,n){if(t.x_.set("Online"),e instanceof pu&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.C_.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.C_.delete(r),t.O_.removeTarget(r))}(t,e)}catch(n){Rr("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await Wh(t,n)}else if(e instanceof mu?t.O_.$e(e):e instanceof gu?t.O_.Je(e):t.O_.Ge(e),!n.isEqual(ss.min()))try{const e=await Xl(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.O_.it(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.C_.get(r);s&&t.C_.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach(((e,n)=>{const r=t.C_.get(e);if(!r)return;t.C_.set(e,r.withResumeToken(Ci.EMPTY_BYTE_STRING,r.snapshotVersion)),Uh(t,e);const s=new ec(r.target,e,n,r.sequenceNumber);qh(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Rr("RemoteStore","Failed to raise snapshot:",e),await Wh(t,e)}}async function Wh(t,e,n){if(!As(e))throw e;t.v_.add(1),await Fh(t),t.x_.set("Offline"),n||(n=()=>Xl(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Rr("RemoteStore","Retrying IndexedDB access"),await n(),t.v_.delete(1),await Lh(t)}))}function Hh(t,e){return e().catch((n=>Wh(t,n,e)))}async function Yh(t){const e=qr(t),n=ud(e);let r=e.D_.length>0?e.D_[e.D_.length-1].batchId:-1;for(;Xh(e);)try{const t=await Zl(e.localStore,r);if(null===t){0===e.D_.length&&n.Xo();break}r=t.batchId,Jh(e,t)}catch(t){await Wh(e,t)}Zh(e)&&td(e)}function Xh(t){return Kh(t)&&t.D_.length<10}function Jh(t,e){t.D_.push(e);const n=ud(t);n.Jo()&&n.P_&&n.I_(e.mutations)}function Zh(t){return Kh(t)&&!ud(t).Ho()&&t.D_.length>0}function td(t){ud(t).start()}async function ed(t){ud(t).d_()}async function nd(t){const e=ud(t);for(const n of t.D_)e.I_(n.mutations)}async function rd(t,e,n){const r=t.D_.shift(),s=Xa.from(r,e,n);await Hh(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await Yh(t)}async function sd(t,e){e&&ud(t).P_&&await async function(t,e){if(function(t){return ru(t)&&t!==Ur.ABORTED}(e.code)){const n=t.D_.shift();ud(t).Zo(),await Hh(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Yh(t)}}(t,e),Zh(t)&&td(t)}async function id(t,e){const n=qr(t);n.asyncQueue.verifyOperationInProgress(),Rr("RemoteStore","RemoteStore received new credentials");const r=Kh(n);n.v_.add(3),await Fh(n),r&&n.x_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.v_.delete(3),await Lh(n)}async function od(t,e){const n=qr(t);e?(n.v_.delete(2),await Lh(n)):e||(n.v_.add(2),await Fh(n),n.x_.set("Unknown"))}function ad(t){return t.N_||(t.N_=function(t,e,n){const r=qr(t);return r.R_(),new Nh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:jh.bind(null,t),To:$h.bind(null,t),u_:Qh.bind(null,t)}),t.F_.push((async e=>{e?(t.N_.Zo(),zh(t)?Bh(t):t.x_.set("Unknown")):(await t.N_.stop(),Gh(t))}))),t.N_}function ud(t){return t.B_||(t.B_=function(t,e,n){const r=qr(t);return r.R_(),new kh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:ed.bind(null,t),To:sd.bind(null,t),E_:nd.bind(null,t),T_:rd.bind(null,t)}),t.F_.push((async e=>{e?(t.B_.Zo(),await Yh(t)):(await t.B_.stop(),t.D_.length>0&&(Rr("RemoteStore",`Stopping write stream with ${t.D_.length} pending writes`),t.D_=[]))}))),t.B_}class cd{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new zr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new cd(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Br(Ur.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ld(t,e){if(Mr("AsyncQueue",`${e}: ${t}`),As(t))return new Br(Ur.UNAVAILABLE,`${e}: ${t}`);throw t}class hd{constructor(t){this.comparator=t?(e,n)=>t(e,n)||cs.comparator(e.key,n.key):(t,e)=>cs.comparator(t.key,e.key),this.keyedMap=ua(),this.sortedSet=new wi(this.comparator)}static emptySet(t){return new hd(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof hd))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new hd;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class dd{constructor(){this.L_=new wi(cs.comparator)}track(t){const e=t.doc.key,n=this.L_.get(e);n?0!==t.type&&3===n.type?this.L_=this.L_.insert(e,t):3===t.type&&1!==n.type?this.L_=this.L_.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.L_=this.L_.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.L_=this.L_.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.L_=this.L_.remove(e):1===t.type&&2===n.type?this.L_=this.L_.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.L_=this.L_.insert(e,{type:2,doc:t.doc}):Fr():this.L_=this.L_.insert(e,t)}k_(){const t=[];return this.L_.inorderTraversal(((e,n)=>{t.push(n)})),t}}class fd{constructor(t,e,n,r,s,i,o,a,u){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(t,e,n,r,s){const i=[];return e.forEach((t=>{i.push({type:0,doc:t})})),new fd(t,e,hd.emptySet(e),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Xo(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class md{constructor(){this.q_=void 0,this.Q_=[]}}class gd{constructor(){this.queries=new sa((t=>Jo(t)),Xo),this.onlineState="Unknown",this.K_=new Set}}async function pd(t,e){const n=qr(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new md),s)try{i.q_=await n.onListen(r)}catch(t){const n=ld(t,`Initialization of query '${Zo(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.Q_.push(e),e.U_(n.onlineState),i.q_&&e.W_(i.q_)&&bd(n)}async function yd(t,e){const n=qr(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.Q_.indexOf(e);t>=0&&(i.Q_.splice(t,1),s=0===i.Q_.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function wd(t,e){const n=qr(t);let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.Q_)e.W_(t)&&(r=!0);s.q_=t}}r&&bd(n)}function vd(t,e,n){const r=qr(t),s=r.queries.get(e);if(s)for(const t of s.Q_)t.onError(n);r.queries.delete(e)}function bd(t){t.K_.forEach((t=>{t.next()}))}class Id{constructor(t,e,n){this.query=t,this.G_=e,this.z_=!1,this.j_=null,this.onlineState="Unknown",this.options=n||{}}W_(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new fd(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.z_?this.H_(t)&&(this.G_.next(t),e=!0):this.J_(t,this.onlineState)&&(this.Y_(t),e=!0),this.j_=t,e}onError(t){this.G_.error(t)}U_(t){this.onlineState=t;let e=!1;return this.j_&&!this.z_&&this.J_(this.j_,t)&&(this.Y_(this.j_),e=!0),e}J_(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.Z_||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}H_(t){if(t.docChanges.length>0)return!0;const e=this.j_&&this.j_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Y_(t){t=fd.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.z_=!0,this.G_.next(t)}}class _d{constructor(t,e){this.X_=t,this.byteLength=e}ea(){return"metadata"in this.X_}}class Td{constructor(t){this.serializer=t}Ps(t){return Pu(this.serializer,t)}Is(t){return t.metadata.exists?Uu(this.serializer,t.document,!1):ao.newNoDocument(this.Ps(t.metadata.name),this.Ts(t.metadata.readTime))}Ts(t){return Au(t)}}class Ed{constructor(t,e,n){this.ta=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Sd(t)}na(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.X_.namedQuery)this.queries.push(t.X_.namedQuery);else if(t.X_.documentMetadata){this.documents.push({metadata:t.X_.documentMetadata}),t.X_.documentMetadata.exists||++e;const n=os.fromString(t.X_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.X_.document&&(this.documents[this.documents.length-1].document=t.X_.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ra(t){const e=new Map,n=new Td(this.serializer);for(const r of t)if(r.metadata.queries){const t=n.Ps(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||ga()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=qr(t);let i=ga(),o=oa();for(const t of n){const n=e.Ps(t.metadata.name);t.document&&(i=i.add(n));const r=e.Is(t);r.setReadTime(e.Ts(t.metadata.readTime)),o=o.insert(n,r)}const a=s.os.newChangeBuffer({trackRemovals:!0}),u=await th(s,function(t){return Qo(Ko(os.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Jl(t,a,o).next((e=>(a.apply(t),e))).next((e=>s.Qr.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.Qr.addMatchingKeys(t,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(t,e.cs,e.ls))).next((()=>e.cs))))))}(this.localStore,new Td(this.serializer),this.documents,this.ta.id),e=this.ra(this.documents);for(const t of this.queries)await oh(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,ia:this.collectionGroups,sa:t}}}function Sd(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class xd{constructor(t){this.key=t}}class Cd{constructor(t){this.key=t}}class Dd{constructor(t,e){this.query=t,this.oa=e,this._a=null,this.hasCachedResults=!1,this.current=!1,this.aa=ga(),this.mutatedKeys=ga(),this.ua=na(t),this.ca=new hd(this.ua)}get la(){return this.oa}ha(t,e){const n=e?e.Pa:new dd,r=e?e.ca:this.ca;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const c=r.get(t),l=ta(this.query,e)?e:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ia(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.ua(l,a)>0||u&&this.ua(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{ca:i,Pa:n,Xi:o,mutatedKeys:s}}Ia(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,r){const s=this.ca;this.ca=t.ca,this.mutatedKeys=t.mutatedKeys;const i=t.Pa.k_();i.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Fr()}};return n(t)-n(e)}(t.type,e.type)||this.ua(t.doc,e.doc))),this.Ta(n),r=null!=r&&r;const o=e&&!r?this.Ea():[],a=0===this.aa.size&&this.current&&!r?1:0,u=a!==this._a;return this._a=a,0!==i.length||u?{snapshot:new fd(this.query,t.ca,s,i,t.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),da:o}:{da:o}}U_(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({ca:this.ca,Pa:new dd,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{da:[]}}Aa(t){return!this.oa.has(t)&&!!this.ca.has(t)&&!this.ca.get(t).hasLocalMutations}Ta(t){t&&(t.addedDocuments.forEach((t=>this.oa=this.oa.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.oa=this.oa.delete(t))),this.current=t.current)}Ea(){if(!this.current)return[];const t=this.aa;this.aa=ga(),this.ca.forEach((t=>{this.Aa(t.key)&&(this.aa=this.aa.add(t.key))}));const e=[];return t.forEach((t=>{this.aa.has(t)||e.push(new Cd(t))})),this.aa.forEach((n=>{t.has(n)||e.push(new xd(n))})),e}Ra(t){this.oa=t.hs,this.aa=ga();const e=this.ha(t.documents);return this.applyChanges(e,!0)}Va(){return fd.fromInitialDocuments(this.query,this.ca,this.mutatedKeys,0===this._a,this.hasCachedResults)}}class Ad{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Nd{constructor(t){this.key=t,this.ma=!1}}class kd{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.fa={},this.ga=new sa((t=>Jo(t)),Xo),this.pa=new Map,this.ya=new Set,this.wa=new wi(cs.comparator),this.Sa=new Map,this.ba=new Dl,this.Da={},this.Ca=new Map,this.va=rl.Bn(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return!0===this.Fa}}async function Rd(t,e){const n=sf(t);let r,s;const i=n.ga.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Va();else{const t=await th(n.localStore,Qo(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Md(n,e,r,"current"===i,t.resumeToken),n.isPrimaryClient&&Oh(n.remoteStore,t)}return s}async function Md(t,e,n,r,s){t.Ma=(e,n,r)=>async function(t,e,n,r){let s=e.view.ha(n);s.Xi&&(s=await nh(t.localStore,e.query,!1).then((({documents:t})=>e.view.ha(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=r&&null!=r.targetMismatches.get(e.targetId),a=e.view.applyChanges(s,t.isPrimaryClient,i,o);return Gd(t,e.targetId,a.da),a.snapshot}(t,e,n,r);const i=await nh(t.localStore,e,!0),o=new Dd(e,i.hs),a=o.ha(i.documents),u=fu.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState,s),c=o.applyChanges(a,t.isPrimaryClient,u);Gd(t,n,c.da);const l=new Ad(e,n,o);return t.ga.set(e,l),t.pa.has(n)?t.pa.get(n).push(e):t.pa.set(n,[e]),c.snapshot}async function Pd(t,e){const n=qr(t),r=n.ga.get(e),s=n.pa.get(r.targetId);if(s.length>1)return n.pa.set(r.targetId,s.filter((t=>!Xo(t,e)))),void n.ga.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await eh(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Vh(n.remoteStore,r.targetId),zd(n,r.targetId)})).catch(Ts)):(zd(n,r.targetId),await eh(n.localStore,r.targetId,!0))}async function Ld(t,e){const n=qr(t);try{const t=await function(t,e){const n=qr(t),r=e.snapshotVersion;let s=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.os.newChangeBuffer({trackRemovals:!0});s=n.ns;const o=[];e.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Qr.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Qr.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);null!==e.targetMismatches.get(a)?c=c.withResumeToken(Ci.EMPTY_BYTE_STRING,ss.min()).withLastLimboFreeSnapshotVersion(ss.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Qr.updateTargetData(t,c))}));let a=oa(),u=ga();if(e.documentUpdates.forEach((r=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Jl(t,i,e.documentUpdates).next((t=>{a=t.cs,u=t.ls}))),!r.isEqual(ss.min())){const e=n.Qr.getLastRemoteSnapshotVersion(t).next((e=>n.Qr.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return Es.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.ns=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Sa.get(e);r&&(Or(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.ma=!0:t.modifiedDocuments.size>0?Or(r.ma):t.removedDocuments.size>0&&(Or(r.ma),r.ma=!1))})),await Qd(n,t,e)}catch(t){await Ts(t)}}function Fd(t,e,n){const r=qr(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.ga.forEach(((n,r)=>{const s=r.view.U_(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=qr(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const t of n.Q_)t.U_(e)&&(r=!0)})),r&&bd(n)}(r.eventManager,e),t.length&&r.fa.u_(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function Od(t,e,n){const r=qr(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Sa.get(e),i=s&&s.key;if(i){let t=new wi(cs.comparator);t=t.insert(i,ao.newNoDocument(i,ss.min()));const n=ga().add(i),s=new du(ss.min(),new Map,new wi(ts),t,n);await Ld(r,s),r.wa=r.wa.remove(i),r.Sa.delete(e),$d(r)}else await eh(r.localStore,e,!1).then((()=>zd(r,e,n))).catch(Ts)}async function Vd(t,e){const n=qr(t),r=e.batch.batchId;try{const t=await function(t,e){const n=qr(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.os.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=Es.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Or(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),r.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=ga();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(n.localStore,e);Bd(n,r,null),Ud(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Qd(n,t)}catch(t){await Ts(t)}}async function qd(t,e,n){const r=qr(t);try{const t=await function(t,e){const n=qr(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(Or(null!==e),r=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,r))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(r.localStore,e);Bd(r,e,n),Ud(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Qd(r,t)}catch(n){await Ts(n)}}function Ud(t,e){(t.Ca.get(e)||[]).forEach((t=>{t.resolve()})),t.Ca.delete(e)}function Bd(t,e,n){const r=qr(t);let s=r.Da[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Da[r.currentUser.toKey()]=s}}function zd(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.pa.get(e))t.ga.delete(r),n&&t.fa.xa(r,n);t.pa.delete(e),t.isPrimaryClient&&t.ba.Vr(e).forEach((e=>{t.ba.containsKey(e)||Kd(t,e)}))}function Kd(t,e){t.ya.delete(e.path.canonicalString());const n=t.wa.get(e);null!==n&&(Vh(t.remoteStore,n),t.wa=t.wa.remove(e),t.Sa.delete(n),$d(t))}function Gd(t,e,n){for(const r of n)r instanceof xd?(t.ba.addReference(r.key,e),jd(t,r)):r instanceof Cd?(Rr("SyncEngine","Document no longer in limbo: "+r.key),t.ba.removeReference(r.key,e),t.ba.containsKey(r.key)||Kd(t,r.key)):Fr()}function jd(t,e){const n=e.key,r=n.path.canonicalString();t.wa.get(n)||t.ya.has(r)||(Rr("SyncEngine","New document in limbo: "+n),t.ya.add(r),$d(t))}function $d(t){for(;t.ya.size>0&&t.wa.size<t.maxConcurrentLimboResolutions;){const e=t.ya.values().next().value;t.ya.delete(e);const n=new cs(os.fromString(e)),r=t.va.next();t.Sa.set(r,new Nd(n)),t.wa=t.wa.insert(n,r),Oh(t.remoteStore,new ec(Qo(Ko(n.path)),r,"TargetPurposeLimboResolution",Fs._e))}}async function Qd(t,e,n){const r=qr(t),s=[],i=[],o=[];r.ga.isEmpty()||(r.ga.forEach(((t,a)=>{o.push(r.Ma(a,e,n).then((t=>{if((t||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){s.push(t);const e=jl.Ki(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.fa.u_(s),await async function(t,e){const n=qr(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Es.forEach(e,(e=>Es.forEach(e.qi,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>Es.forEach(e.Qi,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!As(t))throw t;Rr("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.ns.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(e,s)}}}(r.localStore,i))}async function Wd(t,e){const n=qr(t);if(!n.currentUser.isEqual(e)){Rr("SyncEngine","User change. New user:",e.toKey());const t=await Yl(n.localStore,e);n.currentUser=e,function(t){t.Ca.forEach((t=>{t.forEach((t=>{t.reject(new Br(Ur.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.Ca.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Qd(n,t.us)}}function Hd(t,e){const n=qr(t),r=n.Sa.get(e);if(r&&r.ma)return ga().add(r.key);{let t=ga();const r=n.pa.get(e);if(!r)return t;for(const e of r){const r=n.ga.get(e);t=t.unionWith(r.view.la)}return t}}async function Yd(t,e){const n=qr(t),r=await nh(n.localStore,e.query,!0),s=e.view.Ra(r);return n.isPrimaryClient&&Gd(n,e.targetId,s.da),s}async function Xd(t,e){const n=qr(t);return sh(n.localStore,e).then((t=>Qd(n,t)))}async function Jd(t,e,n,r){const s=qr(t),i=await function(t,e){const n=qr(t),r=qr(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.vn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):Es.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await Yh(s.remoteStore):"acknowledged"===n||"rejected"===n?(Bd(s,e,r||null),Ud(s,e),function(t,e){qr(qr(t).mutationQueue).Mn(e)}(s.localStore,e)):Fr(),await Qd(s,i)):Rr("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Zd(t,e,n){const r=qr(t),s=[],i=[];for(const t of e){let e;const n=r.pa.get(t);if(n&&0!==n.length){e=await th(r.localStore,Qo(n[0]));for(const t of n){const e=r.ga.get(t),n=await Yd(r,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await rh(r.localStore,t);e=await th(r.localStore,n),await Md(r,tf(n),t,!1,e.resumeToken)}s.push(e)}return r.fa.u_(i),s}function tf(t){return zo(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function ef(t){return function(t){return qr(qr(t).persistence).Li()}(qr(t).localStore)}async function nf(t,e,n,r){const s=qr(t);if(s.Fa)return void Rr("SyncEngine","Ignoring unexpected query state notification.");const i=s.pa.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await sh(s.localStore,ea(i[0])),r=du.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,Ci.EMPTY_BYTE_STRING);await Qd(s,t,r);break}case"rejected":await eh(s.localStore,e,!0),zd(s,e,r);break;default:Fr()}}async function rf(t,e,n){const r=sf(t);if(r.Fa){for(const t of e){if(r.pa.has(t)){Rr("SyncEngine","Adding an already active target "+t);continue}const e=await rh(r.localStore,t),n=await th(r.localStore,e);await Md(r,tf(e),n.targetId,!1,n.resumeToken),Oh(r.remoteStore,n)}for(const t of n)r.pa.has(t)&&await eh(r.localStore,t,!1).then((()=>{Vh(r.remoteStore,t),zd(r,t)})).catch(Ts)}}function sf(t){const e=qr(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Ld.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Hd.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Od.bind(null,e),e.fa.u_=wd.bind(null,e.eventManager),e.fa.xa=vd.bind(null,e.eventManager),e}function of(t){const e=qr(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Vd.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=qd.bind(null,e),e}class af{constructor(){this.synchronizeTabs=!1}async initialize(t){this.serializer=Ch(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),await this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return Hl(this.persistence,new Ql,t.initialUser,this.serializer)}createPersistence(t){return new Pl(Fl.Hr,this.serializer)}createSharedClientState(t){return new ph}async terminate(){var t,e;null===(t=this.gcScheduler)||void 0===t||t.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class uf extends af{constructor(t){super(),this.cacheSizeBytes=t}createGarbageCollectionScheduler(t,e){Or(this.persistence.referenceDelegate instanceof Ol);const n=this.persistence.referenceDelegate.garbageCollector;return new ll(n,t.asyncQueue,e)}createPersistence(t){const e=void 0!==this.cacheSizeBytes?Hc.withCacheSize(this.cacheSizeBytes):Hc.DEFAULT;return new Pl((t=>Ol.Hr(t,e)),this.serializer)}}class cf extends af{constructor(t,e,n){super(),this.Na=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Na.initialize(this,t),await of(this.Na.syncEngine),await Yh(this.Na.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(t){return Hl(this.persistence,new Ql,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new ll(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){const n=new Ls(e,this.persistence);return new Ps(t.asyncQueue,n)}createPersistence(t){const e=Gl(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Hc.withCacheSize(this.cacheSizeBytes):Hc.DEFAULT;return new Bl(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Sh(),xh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new ph}}class lf extends cf{constructor(t,e){super(t,e,!1),this.Na=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Na.syncEngine;this.sharedClientState instanceof gh&&(this.sharedClientState.syncEngine={Zs:Jd.bind(null,e),Xs:nf.bind(null,e),eo:rf.bind(null,e),Li:ef.bind(null,e),Ys:Xd.bind(null,e)},await this.sharedClientState.start()),await this.persistence.fi((async t=>{await async function(t,e){const n=qr(t);if(sf(n),of(n),!0===e&&!0!==n.Fa){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Zd(n,t.toArray());n.Fa=!0,await od(n.remoteStore,!0);for(const t of e)Oh(n.remoteStore,t)}else if(!1===e&&!1!==n.Fa){const t=[];let e=Promise.resolve();n.pa.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(zd(n,s),eh(n.localStore,s,!0)))),Vh(n.remoteStore,s)})),await e,await Zd(n,t),function(t){const e=qr(t);e.Sa.forEach(((t,n)=>{Vh(e.remoteStore,n)})),e.ba.mr(),e.Sa=new Map,e.wa=new wi(cs.comparator)}(n),n.Fa=!1,await od(n.remoteStore,!1)}}(this.Na.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}createSharedClientState(t){const e=Sh();if(!gh.D(e))throw new Br(Ur.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Gl(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new gh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class hf{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Fd(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Wd.bind(null,this.syncEngine),await od(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new gd}createDatastore(t){const e=Ch(t.databaseInfo.databaseId),n=function(t){return new Eh(t)}(t.databaseInfo);return function(t,e,n,r){return new Rh(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(t,e,n,r,s){return new Ph(t,e,n,r,s)}(this.localStore,this.datastore,t.asyncQueue,(t=>Fd(this.syncEngine,t,0)),wh.D()?new wh:new yh)}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new kd(t,e,n,r,s,i);return o&&(a.Fa=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t;await async function(t){const e=qr(t);Rr("RemoteStore","RemoteStore shutting down."),e.v_.add(5),await Fh(e),e.M_.shutdown(),e.x_.set("Unknown")}(this.remoteStore),null===(t=this.datastore)||void 0===t||t.terminate()}}function df(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class ff{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ba(this.observer.next,t)}error(t){this.observer.error?this.Ba(this.observer.error,t):Mr("Uncaught Error in snapshot listener:",t.toString())}La(){this.muted=!0}Ba(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class mf{constructor(t,e){this.ka=t,this.serializer=e,this.metadata=new zr,this.buffer=new Uint8Array,this.qa=new TextDecoder("utf-8"),this.Qa().then((t=>{t&&t.ea()?this.metadata.resolve(t.X_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.X_)}`))}),(t=>this.metadata.reject(t)))}close(){return this.ka.cancel()}async getMetadata(){return this.metadata.promise}async Oa(){return await this.getMetadata(),this.Qa()}async Qa(){const t=await this.Ka();if(null===t)return null;const e=this.qa.decode(t),n=Number(e);isNaN(n)&&this.$a(`length string (${e}) is not valid number`);const r=await this.Ua(n);return new _d(JSON.parse(r),t.length+n)}Wa(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Ka(){for(;this.Wa()<0&&!await this.Ga(););if(0===this.buffer.length)return null;const t=this.Wa();t<0&&this.$a("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Ua(t){for(;this.buffer.length<t;)await this.Ga()&&this.$a("Reached the end of bundle when more is expected.");const e=this.qa.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}$a(t){throw this.ka.cancel(),new Error(`Invalid bundle format: ${t}`)}async Ga(){const t=await this.ka.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class gf{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new Br(Ur.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const e=await async function(t,e){const n=qr(t),r={documents:e.map((t=>Mu(n.serializer,t)))},s=await n.vo("BatchGetDocuments",n.serializer.databaseId,os.emptyPath(),r,e.length),i=new Map;s.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Or(!!e.found),e.found.name,e.found.updateTime;const n=Pu(t,e.found.name),r=Au(e.found.updateTime),s=e.found.createTime?Au(e.found.createTime):ss.min(),i=new io({mapValue:{fields:e.found.fields}});return ao.newFoundDocument(n,r,s,i)}(t,e):"missing"in e?function(t,e){Or(!!e.missing),Or(!!e.readTime);const n=Pu(t,e.missing),r=Au(e.readTime);return ao.newNoDocument(n,r)}(t,e):Fr()}(n.serializer,t);i.set(e.key.toString(),e)}));const o=[];return e.forEach((t=>{const e=i.get(t.toString());Or(!!e),o.push(e)})),o}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastTransactionError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Wa(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=cs.fromPath(e);this.mutations.push(new Ha(n,this.precondition(n)))})),await async function(t,e){const n=qr(t),r={writes:e.map((t=>Bu(n.serializer,t)))};await n.So("Commit",n.serializer.databaseId,os.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Fr();e=ss.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Br(Ur.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(ss.min())?La.exists(!1):La.updateTime(e):La.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(ss.min()))throw new Br(Ur.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return La.updateTime(e)}return La.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class pf{constructor(t,e,n,r,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=r,this.deferred=s,this.za=n.maxAttempts,this.jo=new Dh(this.asyncQueue,"transaction_retry")}ja(){this.za-=1,this.Ha()}Ha(){this.jo.qo((async()=>{const t=new gf(this.datastore),e=this.Ja(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Ya(t)}))))})).catch((t=>{this.Ya(t)}))}))}Ja(t){try{const e=this.updateFunction(t);return!Os(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Ya(t){this.za>0&&this.Za(t)?(this.za-=1,this.asyncQueue.enqueueAndForget((()=>(this.Ha(),Promise.resolve())))):this.deferred.reject(t)}Za(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!ru(e)}return!1}}class yf{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=Cr.UNAUTHENTICATED,this.clientId=Zr.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Rr("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(Rr("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Br(Ur.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new zr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=ld(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function wf(t,e){t.asyncQueue.verifyOperationInProgress(),Rr("FirestoreClient","Initializing OfflineComponentProvider");const n=t.configuration;await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await Yl(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function vf(t,e){t.asyncQueue.verifyOperationInProgress();const n=await If(t);Rr("FirestoreClient","Initializing OnlineComponentProvider"),await e.initialize(n,t.configuration),t.setCredentialChangeListener((t=>id(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>id(e.remoteStore,n))),t._onlineComponents=e}function bf(t){return"FirebaseError"===t.name?t.code===Ur.FAILED_PRECONDITION||t.code===Ur.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}async function If(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Rr("FirestoreClient","Using user provided OfflineComponentProvider");try{await wf(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!bf(n))throw n;Pr("Error using user provided cache. Falling back to memory cache: "+n),await wf(t,new af)}}else Rr("FirestoreClient","Using default OfflineComponentProvider"),await wf(t,new af);return t._offlineComponents}async function _f(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(Rr("FirestoreClient","Using user provided OnlineComponentProvider"),await vf(t,t._uninitializedComponentsProvider._online)):(Rr("FirestoreClient","Using default OnlineComponentProvider"),await vf(t,new hf))),t._onlineComponents}function Tf(t){return If(t).then((t=>t.persistence))}function Ef(t){return If(t).then((t=>t.localStore))}function Sf(t){return _f(t).then((t=>t.remoteStore))}function xf(t){return _f(t).then((t=>t.syncEngine))}function Cf(t){return _f(t).then((t=>t.datastore))}async function Df(t){const e=await _f(t),n=e.eventManager;return n.onListen=Rd.bind(null,e.syncEngine),n.onUnlisten=Pd.bind(null,e.syncEngine),n}function Af(t,e,n={}){const r=new zr;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new ff({next:i=>{e.enqueueAndForget((()=>yd(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new Br(Ur.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new Br(Ur.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new Id(Ko(n.path),i,{includeMetadataChanges:!0,Z_:!0});return pd(t,o)}(await Df(t),t.asyncQueue,e,n,r))),r.promise}function Nf(t,e,n={}){const r=new zr;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new ff({next:n=>{e.enqueueAndForget((()=>yd(t,o))),n.fromCache&&"server"===r.source?s.reject(new Br(Ur.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new Id(n,i,{includeMetadataChanges:!0,Z_:!0});return pd(t,o)}(await Df(t),t.asyncQueue,e,n,r))),r.promise}function kf(t){const e={};return void 0!==t.timeoutSeconds&&(e.timeoutSeconds=t.timeoutSeconds),e}const Rf=new Map;function Mf(t,e,n){if(!n)throw new Br(Ur.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Pf(t,e,n,r){if(!0===e&&!0===r)throw new Br(Ur.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Lf(t){if(!cs.isDocumentKey(t))throw new Br(Ur.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Ff(t){if(cs.isDocumentKey(t))throw new Br(Ur.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Of(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Fr()}function Vf(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Br(Ur.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Of(t);throw new Br(Ur.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function qf(t,e){if(e<=0)throw new Br(Ur.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Uf{constructor(t){var e,n;if(void 0===t.host){if(void 0!==t.ssl)throw new Br(Ur.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Br(Ur.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Pf("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=kf(null!==(n=t.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(t){if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new Br(Ur.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new Br(Ur.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(t.timeoutSeconds>30)throw new Br(Ur.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(t,e){return t.timeoutSeconds===e.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Bf{constructor(t,e,n,r){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Uf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Br(Ur.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Br(Ur.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Uf(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Gr;switch(t.type){case"firstParty":return new Wr(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new Br(Ur.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Rf.get(t);e&&(Rr("ComponentProvider","Removing Datastore"),Rf.delete(t),e.terminate())}(this),Promise.resolve()}}function zf(t,e,n,r={}){var s;const i=(t=Vf(t,Bf))._getSettings(),o=`${e}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==o&&Pr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),t._setSettings(Object.assign(Object.assign({},i),{host:o,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=Cr.MOCK_USER;else{e=(0,a.Fy)(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Br(Ur.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Cr(i)}t._authCredentials=new jr(new Kr(e,n))}}class Kf{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Kf(this.firestore,t,this._query)}}class Gf{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new jf(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Gf(this.firestore,t,this._key)}}class jf extends Kf{constructor(t,e,n){super(t,e,Ko(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Gf(this.firestore,null,new cs(t))}withConverter(t){return new jf(this.firestore,t,this._path)}}function $f(t,e,...n){if(t=(0,a.Ku)(t),Mf("collection","path",e),t instanceof Bf){const r=os.fromString(e,...n);return Ff(r),new jf(t,null,r)}{if(!(t instanceof Gf||t instanceof jf))throw new Br(Ur.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(os.fromString(e,...n));return Ff(r),new jf(t.firestore,null,r)}}function Qf(t,e){if(t=Vf(t,Bf),Mf("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Br(Ur.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Kf(t,null,function(t){return new Bo(os.emptyPath(),t)}(e))}function Wf(t,e,...n){if(t=(0,a.Ku)(t),1===arguments.length&&(e=Zr.newId()),Mf("doc","path",e),t instanceof Bf){const r=os.fromString(e,...n);return Lf(r),new Gf(t,null,new cs(r))}{if(!(t instanceof Gf||t instanceof jf))throw new Br(Ur.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(os.fromString(e,...n));return Lf(r),new Gf(t.firestore,t instanceof jf?t.converter:null,new cs(r))}}function Hf(t,e){return t=(0,a.Ku)(t),e=(0,a.Ku)(e),(t instanceof Gf||t instanceof jf)&&(e instanceof Gf||e instanceof jf)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Yf(t,e){return t=(0,a.Ku)(t),e=(0,a.Ku)(e),t instanceof Kf&&e instanceof Kf&&t.firestore===e.firestore&&Xo(t._query,e._query)&&t.converter===e.converter}class Xf{constructor(){this.Xa=Promise.resolve(),this.eu=[],this.tu=!1,this.nu=[],this.ru=null,this.iu=!1,this.su=!1,this.ou=[],this.jo=new Dh(this,"async_queue_retry"),this._u=()=>{const t=xh();t&&Rr("AsyncQueue","Visibility state changed to "+t.visibilityState),this.jo.Ko()};const t=xh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._u)}get isShuttingDown(){return this.tu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.au(),this.uu(t)}enterRestrictedMode(t){if(!this.tu){this.tu=!0,this.su=t||!1;const e=xh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this._u)}}enqueue(t){if(this.au(),this.tu)return new Promise((()=>{}));const e=new zr;return this.uu((()=>this.tu&&this.su?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.eu.push(t),this.cu())))}async cu(){if(0!==this.eu.length){try{await this.eu[0](),this.eu.shift(),this.jo.reset()}catch(t){if(!As(t))throw t;Rr("AsyncQueue","Operation failed with retryable error: "+t)}this.eu.length>0&&this.jo.qo((()=>this.cu()))}}uu(t){const e=this.Xa.then((()=>(this.iu=!0,t().catch((t=>{this.ru=t,this.iu=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Mr("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.iu=!1,t))))));return this.Xa=e,e}enqueueAfterDelay(t,e,n){this.au(),this.ou.indexOf(t)>-1&&(e=0);const r=cd.createAndSchedule(this,t,e,n,(t=>this.lu(t)));return this.nu.push(r),r}au(){this.ru&&Fr()}verifyOperationInProgress(){}async hu(){let t;do{t=this.Xa,await t}while(t!==this.Xa)}Pu(t){for(const e of this.nu)if(e.timerId===t)return!0;return!1}Iu(t){return this.hu().then((()=>{this.nu.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.nu)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.hu()}))}Tu(t){this.ou.push(t)}lu(t){const e=this.nu.indexOf(t);this.nu.splice(e,1)}}function Jf(t){return function(t){if("object"!=typeof t||null===t)return!1;const e=t;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}(t)}class Zf{constructor(){this._progressObserver={},this._taskCompletionResolver=new zr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const tm=-1;class em extends Bf{constructor(t,e,n,r){super(t,e,n,r),this.type="firestore",this._queue=new Xf,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||im(this),this._firestoreClient.terminate()}}function nm(t,e,n){n||(n="(default)");const r=(0,s.j6)(t,"firestore");if(r.isInitialized(n)){const t=r.getImmediate({identifier:n}),s=r.getOptions(n);if((0,a.bD)(s,e))return t;throw new Br(Ur.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&void 0!==e.localCache)throw new Br(Ur.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Br(Ur.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:e,instanceIdentifier:n})}function rm(t,e){const n="object"==typeof t?t:(0,s.Sx)(),r="string"==typeof t?t:e||"(default)",i=(0,s.j6)(n,"firestore").getImmediate({identifier:r});if(!i._initialized){const t=(0,a.yU)("firestore");t&&zf(i,...t)}return i}function sm(t){return t._firestoreClient||im(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function im(t){var e,n,r;const s=t._freezeSettings(),i=function(t,e,n,r){return new Li(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,kf(r.experimentalLongPollingOptions),r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,s);t._firestoreClient=new yf(t._authCredentials,t._appCheckCredentials,t._queue,i),(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(t._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function om(t,e){pm(t=Vf(t,em));const n=sm(t);if(n._uninitializedComponentsProvider)throw new Br(Ur.FAILED_PRECONDITION,"SDK cache is already specified.");Pr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=t._freezeSettings(),s=new hf;return um(n,s,new cf(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function am(t){pm(t=Vf(t,em));const e=sm(t);if(e._uninitializedComponentsProvider)throw new Br(Ur.FAILED_PRECONDITION,"SDK cache is already specified.");Pr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings(),r=new hf;return um(e,r,new lf(r,n.cacheSizeBytes))}function um(t,e,n){const r=new zr;return t.asyncQueue.enqueue((async()=>{try{await wf(t,n),await vf(t,e),r.resolve()}catch(t){const e=t;if(!bf(e))throw e;Pr("Error enabling indexeddb cache. Falling back to memory cache: "+e),r.reject(e)}})).then((()=>r.promise))}function cm(t){if(t._initialized&&!t._terminated)throw new Br(Ur.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new zr;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!xs.D())return Promise.resolve();const e=t+"main";await xs.delete(e)}(Gl(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function lm(t){return function(t){const e=new zr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=qr(t);Kh(n.remoteStore)||Rr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=qr(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.Ca.get(t)||[];r.push(e),n.Ca.set(t,r)}catch(t){const n=ld(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await xf(t),e))),e.promise}(sm(t=Vf(t,em)))}function hm(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Tf(t),n=await Sf(t);return e.setNetworkEnabled(!0),function(t){const e=qr(t);return e.v_.delete(0),Lh(e)}(n)}))}(sm(t=Vf(t,em)))}function dm(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Tf(t),n=await Sf(t);return e.setNetworkEnabled(!1),async function(t){const e=qr(t);e.v_.add(0),await Fh(e),e.x_.set("Offline")}(n)}))}(sm(t=Vf(t,em)))}function fm(t){return(0,s.Us)(t.app,"firestore",t._databaseId.database),t._delete()}function mm(t,e){const n=sm(t=Vf(t,em)),r=new Zf;return function(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?ou().encode(t):t,function(t,e){return new mf(t,e)}(function(t,e){if(t instanceof Uint8Array)return df(t,e);if(t instanceof ArrayBuffer)return df(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Ch(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=qr(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=qr(t),r=Au(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.$r.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Sd(r));const s=new Ed(r,t.localStore,e.serializer);let i=await e.Oa();for(;i;){const t=await s.na(i);t&&n._updateProgress(t),i=await e.Oa()}const o=await s.complete();return await Qd(t,o.sa,void 0),await function(t,e){const n=qr(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.$r.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress),Promise.resolve(o.ia)}catch(t){return Pr("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(r,e,n).then((t=>{r.sharedClientState.notifyBundleLoaded(t)}))}(await xf(t),s,r)}))}(n,t._databaseId,e,r),r}function gm(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=qr(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.$r.getNamedQuery(t,e)))}(await Ef(t),e)))}(sm(t=Vf(t,em)),e).then((e=>e?new Kf(t,null,e.query):null))}function pm(t){if(t._initialized||t._terminated)throw new Br(Ur.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class ym{constructor(t="count",e){this._internalFieldPath=e,this.type="AggregateField",this.aggregateType=t}}class wm{constructor(t,e,n){this._userDataWriter=e,this._data=n,this.type="AggregateQuerySnapshot",this.query=t}data(){return this._userDataWriter.convertObjectMap(this._data)}}class vm{constructor(t){this._byteString=t}static fromBase64String(t){try{return new vm(Ci.fromBase64String(t))}catch(t){throw new Br(Ur.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new vm(Ci.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class bm{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Br(Ur.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new us(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Im(){return new bm("__name__")}class _m{constructor(t){this._methodName=t}}class Tm{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Br(Ur.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Br(Ur.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return ts(this._lat,t._lat)||ts(this._long,t._long)}}const Em=/^__.*__$/;class Sm{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Ga(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ka(t,this.data,e,this.fieldTransforms)}}class xm{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Ga(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Cm(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Fr()}}class Dm{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Eu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get du(){return this.settings.du}Au(t){return new Dm(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Ru(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Au({path:n,Vu:!1});return r.mu(t),r}fu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Au({path:n,Vu:!1});return r.Eu(),r}gu(t){return this.Au({path:void 0,Vu:!0})}pu(t){return Wm(t,this.settings.methodName,this.settings.yu||!1,this.path,this.settings.wu)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Eu(){if(this.path)for(let t=0;t<this.path.length;t++)this.mu(this.path.get(t))}mu(t){if(0===t.length)throw this.pu("Document fields must not be empty");if(Cm(this.du)&&Em.test(t))throw this.pu('Document fields cannot begin and end with "__"')}}class Am{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||Ch(t)}Su(t,e,n,r=!1){return new Dm({du:t,methodName:e,wu:n,path:us.emptyPath(),Vu:!1,yu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Nm(t){const e=t._freezeSettings(),n=Ch(t._databaseId);return new Am(t._databaseId,!!e.ignoreUndefinedProperties,n)}function km(t,e,n,r,s,i={}){const o=t.Su(i.merge||i.mergeFields?2:0,e,n,s);Gm("Data must be an object, but it was:",o,r);const a=zm(r,o);let u,c;if(i.merge)u=new Ei(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=jm(e,r,n);if(!o.contains(s))throw new Br(Ur.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Hm(t,s)||t.push(s)}u=new Ei(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new Sm(new io(a),u,c)}class Rm extends _m{_toFieldTransform(t){if(2!==t.du)throw 1===t.du?t.pu(`${this._methodName}() can only appear at the top level of your update data`):t.pu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Rm}}function Mm(t,e,n){return new Dm({du:3,wu:e.settings.wu,methodName:t._methodName,Vu:n},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class Pm extends _m{_toFieldTransform(t){return new Ma(t.path,new Sa)}isEqual(t){return t instanceof Pm}}class Lm extends _m{constructor(t,e){super(t),this.bu=e}_toFieldTransform(t){const e=Mm(this,t,!0),n=this.bu.map((t=>Bm(t,e))),r=new xa(n);return new Ma(t.path,r)}isEqual(t){return t instanceof Lm&&(0,a.bD)(this.bu,t.bu)}}class Fm extends _m{constructor(t,e){super(t),this.bu=e}_toFieldTransform(t){const e=Mm(this,t,!0),n=this.bu.map((t=>Bm(t,e))),r=new Da(n);return new Ma(t.path,r)}isEqual(t){return t instanceof Fm&&(0,a.bD)(this.bu,t.bu)}}class Om extends _m{constructor(t,e){super(t),this.Du=e}_toFieldTransform(t){const e=new Na(t.serializer,ba(t.serializer,this.Du));return new Ma(t.path,e)}isEqual(t){return t instanceof Om&&this.Du===t.Du}}function Vm(t,e,n,r){const s=t.Su(1,e,n);Gm("Data must be an object, but it was:",s,r);const i=[],o=io.empty();pi(r,((t,r)=>{const u=Qm(e,t,n);r=(0,a.Ku)(r);const c=s.fu(u);if(r instanceof Rm)i.push(u);else{const t=Bm(r,c);null!=t&&(i.push(u),o.set(u,t))}}));const u=new Ei(i);return new xm(o,u,s.fieldTransforms)}function qm(t,e,n,r,s,i){const o=t.Su(1,e,n),u=[jm(e,r,n)],c=[s];if(i.length%2!=0)throw new Br(Ur.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)u.push(jm(e,i[t])),c.push(i[t+1]);const l=[],h=io.empty();for(let t=u.length-1;t>=0;--t)if(!Hm(l,u[t])){const e=u[t];let n=c[t];n=(0,a.Ku)(n);const r=o.fu(e);if(n instanceof Rm)l.push(e);else{const t=Bm(n,r);null!=t&&(l.push(e),h.set(e,t))}}const d=new Ei(l);return new xm(h,d,o.fieldTransforms)}function Um(t,e,n,r=!1){return Bm(n,t.Su(r?4:3,e))}function Bm(t,e){if(Km(t=(0,a.Ku)(t)))return Gm("Unsupported field value:",e,t),zm(t,e);if(t instanceof _m)return function(t,e){if(!Cm(e.du))throw e.pu(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.pu(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Vu&&4!==e.du)throw e.pu("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Bm(s,e.gu(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,a.Ku)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return ba(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=rs.fromDate(t);return{timestampValue:xu(e.serializer,n)}}if(t instanceof rs){const n=new rs(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:xu(e.serializer,n)}}if(t instanceof Tm)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof vm)return{bytesValue:Cu(e.serializer,t._byteString)};if(t instanceof Gf){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.pu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Nu(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.pu(`Unsupported field value: ${Of(t)}`)}(t,e)}function zm(t,e){const n={};return yi(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):pi(t,((t,r)=>{const s=Bm(r,e.Ru(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function Km(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof rs||t instanceof Tm||t instanceof vm||t instanceof Gf||t instanceof _m)}function Gm(t,e,n){if(!Km(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=Of(n);throw"an object"===r?e.pu(t+" a custom object"):e.pu(t+" "+r)}}function jm(t,e,n){if((e=(0,a.Ku)(e))instanceof bm)return e._internalPath;if("string"==typeof e)return Qm(t,e);throw Wm("Field path arguments must be of type string or ",t,!1,void 0,n)}const $m=new RegExp("[~\\*/\\[\\]]");function Qm(t,e,n){if(e.search($m)>=0)throw Wm(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new bm(...e.split("."))._internalPath}catch(r){throw Wm(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Wm(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new Br(Ur.INVALID_ARGUMENT,a+t+u)}function Hm(t,e){return t.some((t=>t.isEqual(e)))}class Ym{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Gf(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Xm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Jm("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Xm extends Ym{data(){return super.data()}}function Jm(t,e){return"string"==typeof e?Qm(t,e):e instanceof bm?e._internalPath:e._delegate._internalPath}function Zm(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Br(Ur.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class tg{}class eg extends tg{}function ng(t,e,...n){let r=[];e instanceof tg&&r.push(e),r=r.concat(n),function(t){const e=t.filter((t=>t instanceof ig)).length,n=t.filter((t=>t instanceof rg)).length;if(e>1||e>0&&n>0)throw new Br(Ur.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const e of r)t=e._apply(t);return t}class rg extends eg{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new rg(t,e,n)}_apply(t){const e=this._parse(t);return _g(t._query,e),new Kf(t.firestore,t.converter,Ho(t._query,e))}_parse(t){const e=Nm(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Br(Ur.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Ig(o,i);const e=[];for(const n of o)e.push(bg(r,t,n));a={arrayValue:{values:e}}}else a=bg(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Ig(o,i),a=Um(n,"where",o,"in"===i||"not-in"===i);return go.create(s,i,a)}(t._query,0,e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function sg(t,e,n){const r=e,s=Jm("where",t);return rg._create(s,r,n)}class ig extends tg{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new ig(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:po.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const r=e.getFlattenedFilters();for(const t of r)_g(n,t),n=Ho(n,t)}(t._query,e),new Kf(t.firestore,t.converter,Ho(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function og(...t){return t.forEach((t=>Tg("or",t))),ig._create("or",t)}function ag(...t){return t.forEach((t=>Tg("and",t))),ig._create("and",t)}class ug extends eg{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new ug(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Br(Ur.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Br(Ur.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new ho(e,n)}(t._query,this._field,this._direction);return new Kf(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Bo(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function cg(t,e="asc"){const n=e,r=Jm("orderBy",t);return ug._create(r,n)}class lg extends eg{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new lg(t,e,n)}_apply(t){return new Kf(t.firestore,t.converter,Yo(t._query,this._limit,this._limitType))}}function hg(t){return qf("limit",t),lg._create("limit",t,"F")}function dg(t){return qf("limitToLast",t),lg._create("limitToLast",t,"L")}class fg extends eg{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new fg(t,e,n)}_apply(t){const e=vg(t,this.type,this._docOrFields,this._inclusive);return new Kf(t.firestore,t.converter,function(t,e){return new Bo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function mg(...t){return fg._create("startAt",t,!0)}function gg(...t){return fg._create("startAfter",t,!1)}class pg extends eg{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new pg(t,e,n)}_apply(t){const e=vg(t,this.type,this._docOrFields,this._inclusive);return new Kf(t.firestore,t.converter,function(t,e){return new Bo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function yg(...t){return pg._create("endBefore",t,!1)}function wg(...t){return pg._create("endAt",t,!0)}function vg(t,e,n,r){if(n[0]=(0,a.Ku)(n[0]),n[0]instanceof Ym)return function(t,e,n,r,s){if(!r)throw new Br(Ur.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of $o(t))if(n.field.isKeyField())i.push(Qi(e,r.key));else{const t=r.data.field(n.field);if(Ri(t))throw new Br(Ur.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new uo(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=Nm(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new Br(Ur.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const u=s[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!jo(t)&&-1!==u.indexOf("/"))throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(os.fromString(u));if(!cs.isDocumentKey(n))throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new cs(n);a.push(Qi(e,s))}else{const t=Um(n,r,u);a.push(t)}}return new uo(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function bg(t,e,n){if("string"==typeof(n=(0,a.Ku)(n))){if(""===n)throw new Br(Ur.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!jo(e)&&-1!==n.indexOf("/"))throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(os.fromString(n));if(!cs.isDocumentKey(r))throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Qi(t,new cs(r))}if(n instanceof Gf)return Qi(t,n._key);throw new Br(Ur.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Of(n)}.`)}function Ig(t,e){if(!Array.isArray(t)||0===t.length)throw new Br(Ur.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function _g(t,e){const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Br(Ur.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Br(Ur.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}function Tg(t,e){if(!(e instanceof rg||e instanceof ig))throw new Br(Ur.INVALID_ARGUMENT,`Function ${t}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class Eg{convertValue(t,e="none"){switch(qi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Ni(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(ki(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Fr()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const n={};return pi(t,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new Tm(Ni(t.latitude),Ni(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Mi(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Pi(t));default:return null}}convertTimestamp(t){const e=Ai(t);return new rs(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=os.fromString(t);Or(tc(n));const r=new Fi(n.get(1),n.get(3)),s=new cs(n.popFirst(5));return r.isEqual(e)||Mr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function Sg(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class xg extends Eg{constructor(t){super(),this.firestore=t}convertBytes(t){return new vm(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gf(this.firestore,null,e)}}function Cg(t){return new ym("sum",jm("sum",t))}function Dg(t){return new ym("avg",jm("average",t))}function Ag(){return new ym("count")}function Ng(t,e){var n,r;return t instanceof ym&&e instanceof ym&&t.aggregateType===e.aggregateType&&(null===(n=t._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=e._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function kg(t,e){return Yf(t.query,e.query)&&(0,a.bD)(t.data(),e.data())}class Rg{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Mg extends Ym{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Pg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Jm("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Pg extends Mg{data(t={}){return super.data(t)}}class Lg{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Rg(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Pg(this._firestore,this._userDataWriter,n.key,n,new Rg(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Br(Ur.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const r=new Pg(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Rg(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new Pg(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Rg(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Fg(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Fg(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Fr()}}function Og(t,e){return t instanceof Mg&&e instanceof Mg?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Lg&&e instanceof Lg&&t._firestore===e._firestore&&Yf(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Vg(t){t=Vf(t,Gf);const e=Vf(t.firestore,em);return Af(sm(e),t._key).then((n=>Jg(e,t,n)))}class qg extends Eg{constructor(t){super(),this.firestore=t}convertBytes(t){return new vm(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gf(this.firestore,null,e)}}function Ug(t){t=Vf(t,Gf);const e=Vf(t.firestore,em),n=sm(e),r=new qg(e);return function(t,e){const n=new zr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=qr(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new Br(Ur.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=ld(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await Ef(t),e,n))),n.promise}(n,t._key).then((n=>new Mg(e,r,t._key,n,new Rg(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Bg(t){t=Vf(t,Gf);const e=Vf(t.firestore,em);return Af(sm(e),t._key,{source:"server"}).then((n=>Jg(e,t,n)))}function zg(t){t=Vf(t,Kf);const e=Vf(t.firestore,em),n=sm(e),r=new qg(e);return Zm(t._query),Nf(n,t._query).then((n=>new Lg(e,r,t,n)))}function Kg(t){t=Vf(t,Kf);const e=Vf(t.firestore,em),n=sm(e),r=new qg(e);return function(t,e){const n=new zr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await nh(t,e,!0),s=new Dd(e,r.hs),i=s.ha(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=ld(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await Ef(t),e,n))),n.promise}(n,t._query).then((n=>new Lg(e,r,t,n)))}function Gg(t){t=Vf(t,Kf);const e=Vf(t.firestore,em),n=sm(e),r=new qg(e);return Nf(n,t._query,{source:"server"}).then((n=>new Lg(e,r,t,n)))}function jg(t,e,n){t=Vf(t,Gf);const r=Vf(t.firestore,em),s=Sg(t.converter,e,n);return Xg(r,[km(Nm(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,La.none())])}function $g(t,e,n,...r){t=Vf(t,Gf);const s=Vf(t.firestore,em),i=Nm(s);let o;return o="string"==typeof(e=(0,a.Ku)(e))||e instanceof bm?qm(i,"updateDoc",t._key,e,n,r):Vm(i,"updateDoc",t._key,e),Xg(s,[o.toMutation(t._key,La.exists(!0))])}function Qg(t){return Xg(Vf(t.firestore,em),[new Wa(t._key,La.none())])}function Wg(t,e){const n=Vf(t.firestore,em),r=Wf(t),s=Sg(t.converter,e);return Xg(n,[km(Nm(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,La.exists(!1))]).then((()=>r))}function Hg(t,...e){var n,r,s;t=(0,a.Ku)(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||Jf(e[o])||(i=e[o],o++);const u={includeMetadataChanges:i.includeMetadataChanges};if(Jf(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[o+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let c,l,h;if(t instanceof Gf)l=Vf(t.firestore,em),h=Ko(t._key.path),c={next:n=>{e[o]&&e[o](Jg(l,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Vf(t,Kf);l=Vf(n.firestore,em),h=n._query;const r=new qg(l);c={next:t=>{e[o]&&e[o](new Lg(l,r,n,t))},error:e[o+1],complete:e[o+2]},Zm(t._query)}return function(t,e,n,r){const s=new ff(r),i=new Id(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>pd(await Df(t),i))),()=>{s.La(),t.asyncQueue.enqueueAndForget((async()=>yd(await Df(t),i)))}}(sm(l),h,u,c)}function Yg(t,e){return function(t,e){const n=new ff(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){qr(t).K_.add(e),e.next()}(await Df(t),n))),()=>{n.La(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){qr(t).K_.delete(e)}(await Df(t),n)))}}(sm(t=Vf(t,em)),Jf(e)?e:{next:e})}function Xg(t,e){return function(t,e){const n=new zr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=of(t);try{const t=await function(t,e){const n=qr(t),r=rs.now(),s=e.reduce(((t,e)=>t.add(e.key)),ga());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=oa(),u=ga();return n.os.getEntries(t,s).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((s=>{i=s;const o=[];for(const t of e){const e=Ba(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new Ga(t.key,e,oo(e.value.mapValue),La.exists(!0)))}return n.mutationQueue.addMutationBatch(t,r,o,e)})).next((e=>{o=e;const r=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:ca(i)})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Da[t.currentUser.toKey()];r||(r=new wi(ts)),r=r.insert(e,n),t.Da[t.currentUser.toKey()]=r}(r,t.batchId,n),await Qd(r,t.changes),await Yh(r.remoteStore)}catch(t){const e=ld(t,"Failed to persist write");n.reject(e)}}(await xf(t),e,n))),n.promise}(sm(t),e)}function Jg(t,e,n){const r=n.docs.get(e._key),s=new qg(t);return new Mg(t,s,e._key,r,new Rg(n.hasPendingWrites,n.fromCache),e.converter)}function Zg(t){return tp(t,{count:Ag()})}function tp(t,e){const n=Vf(t.firestore,em),r=sm(n),s=function(t,e){const n=[];for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(e(t[r],r));return n}(e,((t,e)=>new Za(e,t.aggregateType,t._internalFieldPath)));return function(t,e,n){const r=new zr;return t.asyncQueue.enqueueAndForget((async()=>{try{const s=await Cf(t);r.resolve(async function(t,e,n){var r;const s=qr(t),{request:i,V_:o,parent:a}=function(t,e,n){const{ut:r,parent:s}=Gu(t,e),i={},o=[];let a=0;return n.forEach((t=>{const e="aggregate_"+a++;i[e]=t.alias,"count"===t.aggregateType?o.push({alias:e,count:{}}):"avg"===t.aggregateType?o.push({alias:e,avg:{field:Yu(t.fieldPath)}}):"sum"===t.aggregateType&&o.push({alias:e,sum:{field:Yu(t.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:r.structuredQuery},parent:r.parent},V_:i,parent:s}}(s.serializer,function(t){const e=qr(t);return e.Pe||(e.Pe=Wo(e,t.explicitOrderBy)),e.Pe}(e),n);s.connection.wo||delete i.parent;const u=(await s.vo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((t=>!!t.result));Or(1===u.length);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce(((t,e)=>(t[o[e]]=c[e],t)),{})}(s,e,n))}catch(t){r.reject(t)}})),r.promise}(r,t._query,s).then((e=>function(t,e,n){const r=new qg(t);return new wm(e,r,n)}(n,t,e)))}class ep{constructor(t){this.kind="memory",this._onlineComponentProvider=new hf,(null==t?void 0:t.garbageCollector)?this._offlineComponentProvider=t.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=new af}toJSON(){return{kind:this.kind}}}class np{constructor(t){let e;this.kind="persistent",(null==t?void 0:t.tabManager)?(t.tabManager._initialize(t),e=t.tabManager):(e=hp(void 0),e._initialize(t)),this._onlineComponentProvider=e._onlineComponentProvider,this._offlineComponentProvider=e._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class rp{constructor(){this.kind="memoryEager",this._offlineComponentProvider=new af}toJSON(){return{kind:this.kind}}}class sp{constructor(t){this.kind="memoryLru",this._offlineComponentProvider=new uf(t)}toJSON(){return{kind:this.kind}}}function ip(){return new rp}function op(t){return new sp(null==t?void 0:t.cacheSizeBytes)}function ap(t){return new ep(t)}function up(t){return new np(t)}class cp{constructor(t){this.forceOwnership=t,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new hf,this._offlineComponentProvider=new cf(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes,this.forceOwnership)}}class lp{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new hf,this._offlineComponentProvider=new lf(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes)}}function hp(t){return new cp(null==t?void 0:t.forceOwnership)}function dp(){return new lp}const fp={maxAttempts:5};class mp{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Nm(t)}set(t,e,n){this._verifyNotCommitted();const r=gp(t,this._firestore),s=Sg(r.converter,e,n),i=km(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,La.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=gp(t,this._firestore);let i;return i="string"==typeof(e=(0,a.Ku)(e))||e instanceof bm?qm(this._dataReader,"WriteBatch.update",s._key,e,n,r):Vm(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,La.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=gp(t,this._firestore);return this._mutations=this._mutations.concat(new Wa(e._key,La.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Br(Ur.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function gp(t,e){if((t=(0,a.Ku)(t)).firestore!==e)throw new Br(Ur.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class pp extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Nm(t)}get(t){const e=gp(t,this._firestore),n=new xg(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Fr();const r=t[0];if(r.isFoundDocument())return new Ym(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Ym(this._firestore,n,e._key,null,e.converter);throw Fr()}))}set(t,e,n){const r=gp(t,this._firestore),s=Sg(r.converter,e,n),i=km(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=gp(t,this._firestore);let i;return i="string"==typeof(e=(0,a.Ku)(e))||e instanceof bm?qm(this._dataReader,"Transaction.update",s._key,e,n,r):Vm(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=gp(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=gp(t,this._firestore),n=new qg(this._firestore);return super.get(t).then((t=>new Mg(this._firestore,n,e._key,t._document,new Rg(!1,!1),e.converter)))}}function yp(t,e,n){t=Vf(t,em);const r=Object.assign(Object.assign({},fp),n);return function(t){if(t.maxAttempts<1)throw new Br(Ur.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,e,n){const r=new zr;return t.asyncQueue.enqueueAndForget((async()=>{const s=await Cf(t);new pf(t.asyncQueue,s,n,e,r).ja()})),r.promise}(sm(t),(n=>e(new pp(t,n))),r)}function wp(){return new Rm("deleteField")}function vp(){return new Pm("serverTimestamp")}function bp(...t){return new Lm("arrayUnion",t)}function Ip(...t){return new Fm("arrayRemove",t)}function _p(t){return new Om("increment",t)}function Tp(t){return sm(t=Vf(t,em)),new mp(t,(e=>Xg(t,e)))}function Ep(t,e){var n;const r=sm(t=Vf(t,em));if(!r._uninitializedComponentsProvider||"memory"===(null===(n=r._uninitializedComponentsProvider)||void 0===n?void 0:n._offlineKind))return Pr("Cannot enable indexes when persistence is disabled"),Promise.resolve();const s=function(t){const e="string"==typeof t?function(t){try{return JSON.parse(t)}catch(t){throw new Br(Ur.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==t?void 0:t.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=Sp(t,"collectionGroup"),r=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=Qm("setIndexConfiguration",Sp(e,"fieldPath"));"CONTAINS"===e.arrayConfig?r.push(new ms(t,2)):"ASCENDING"===e.order?r.push(new ms(t,0)):"DESCENDING"===e.order&&r.push(new ms(t,1))}n.push(new ls(ls.UNKNOWN_ID,e,r,ps.empty()))}return n}(e);return function(t,e){return t.asyncQueue.enqueue((async()=>async function(t,e){const n=qr(t),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>r.getFieldIndexes(t).next((n=>function(t,e,n,r,s){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(t[u],e[a]);i<0?s(t[u++]):i>0?r(e[a++]):(a++,u++)}for(;a<o;)r(e[a++]);for(;u<i;)s(t[u++])}(n,e,fs,(e=>{s.push(r.addFieldIndex(t,e))}),(e=>{s.push(r.deleteFieldIndex(t,e))})))).next((()=>Es.waitFor(s)))))}(await Ef(t),e)))}(r,s)}function Sp(t,e){if("string"!=typeof t[e])throw new Br(Ur.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}class xp{constructor(t){this._client=t,this.type="PersistentCacheIndexManager"}}function Cp(t){var e;t=Vf(t,em);const n=Rp.get(t);if(n)return n;const r=sm(t);if("persistent"!==(null===(e=r._uninitializedComponentsProvider)||void 0===e?void 0:e._offlineKind))return null;const s=new xp(r);return Rp.set(t,s),s}function Dp(t){kp(t,!0)}function Ap(t){kp(t,!1)}function Np(t){t._client.verifyNotTerminated(),function(t){return t.asyncQueue.enqueue((async()=>function(t){const e=qr(t),n=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",(t=>n.deleteAllFieldIndexes(t)))}(await Ef(t))))}(t._client).then((t=>Rr("deleting all persistent cache indexes succeeded"))).catch((t=>Pr("deleting all persistent cache indexes failed",t)))}function kp(t,e){t._client.verifyNotTerminated(),function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){qr(t).ts.Ui=e}(await Ef(t),e)))}(t._client,e).then((t=>Rr(`setting persistent cache index auto creation isEnabled=${e} succeeded`))).catch((t=>Pr(`setting persistent cache index auto creation isEnabled=${e} failed`,t)))}const Rp=new WeakMap;class Mp{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(t){return Pp.instance.onExistenceFilterMismatch(t)}}class Pp{constructor(){this.Cu=new Map}static get instance(){return Lp||(Lp=new Pp,function(t){if(iu)throw new Error("a TestingHooksSpi instance is already set");iu=t}(Lp)),Lp}tt(t){this.Cu.forEach((e=>e(t)))}onExistenceFilterMismatch(t){const e=Symbol(),n=this.Cu;return n.set(e,t),()=>n.delete(e)}}let Lp=null;!function(t,e=!0){!function(t){Dr=t}(s.MF),(0,s.om)(new i.uA("firestore",((t,{instanceIdentifier:n,options:r})=>{const s=t.getProvider("app").getImmediate(),i=new em(new $r(t.getProvider("auth-internal")),new Yr(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Br(Ur.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Fi(t.options.projectId,e)}(s,n),s);return r=Object.assign({useFetchStreams:e},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,s.KO)(xr,"4.4.1",t),(0,s.KO)(xr,"4.4.1","esm2017")}()}}]);